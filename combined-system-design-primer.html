<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>System Design Primer - Complete Guide</title>
  <style>
    /* Default styles provided by pandoc.
    ** See https://pandoc.org/MANUAL.html#variables-for-html for config info.
    */
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  background-color: #f8f8f8; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ef2929; } /* Alert */
    code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #204a87; } /* Attribute */
    code span.bn { color: #0000cf; } /* BaseN */
    code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4e9a06; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #8f5902; font-style: italic; } /* Comment */
    code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
    code span.dt { color: #204a87; } /* DataType */
    code span.dv { color: #0000cf; } /* DecVal */
    code span.er { color: #a40000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #0000cf; } /* Float */
    code span.fu { color: #204a87; font-weight: bold; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
    code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
    code span.ot { color: #8f5902; } /* Other */
    code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
    code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
    code span.ss { color: #4e9a06; } /* SpecialString */
    code span.st { color: #4e9a06; } /* String */
    code span.va { color: #000000; } /* Variable */
    code span.vs { color: #4e9a06; } /* VerbatimString */
    code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css" />

        <style>
        @media print {

            @page {
                margin: 0.8in 0.6in 1in 0.6in;  /* Extra bottom margin for page numbers */
                size: A4;

                @bottom-center {
                    content: counter(page);
                    font-size: 12px;
                    color: #666;
                }
            }
            
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
                line-height: 1.6;
                color: #24292e;
                max-width: none;
                margin: 0 !important;

                padding: 30px 20px !important;
            }
            
            /* Image sizing for PDF */
            img {
                max-width: 100% !important;
                height: auto !important;
                display: block;
                margin: 10px auto;
                page-break-inside: avoid;
            }
            
            /* Ensure large images fit within page width */
            img[src*="jj3A5N8.png"], img[src*="4edXG0T.png"] {
                max-width: 90% !important;
                width: auto !important;
            }
            
            /* Links styling */
            a {
                color: #0366d6;
                text-decoration: underline;
            }
            
            a:hover {
                text-decoration: underline;
            }
            
            /* Code blocks */
            pre {
                background-color: #f6f8fa;
                border-radius: 6px;
                padding: 16px;
                overflow-x: auto;
                page-break-inside: avoid;
            }
            
            /* Tables */
            table {
                border-collapse: collapse;
                width: 100%;
                margin: 16px 0;
                page-break-inside: avoid;
            }
            
            th, td {
                border: 1px solid #d0d7de;
                padding: 8px 12px;
                text-align: left;
            }
            
            th {
                background-color: #f6f8fa;
                font-weight: 600;
            }
            
            /* Headings */
            h1, h2, h3, h4, h5, h6 {
                margin-top: 24px;
                margin-bottom: 16px;
                font-weight: 600;
                line-height: 1.25;
                page-break-after: avoid;
            }
            
            h1 {
                font-size: 2em;
                border-bottom: 1px solid #eaecef;
                padding-bottom: 10px;
            }
            
            h2 {
                font-size: 1.5em;
                border-bottom: 1px solid #eaecef;
                padding-bottom: 8px;
            }

        }
        
        @media screen {
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
                line-height: 1.6;
                color: #24292e;
                max-width: 1200px;
                margin: 0 auto;

                padding: 30px 20px;
            }
        }
        </style>
        </head>
<body>
<header id="title-block-header">
<h1 class="title">System Design Primer - Complete Guide</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#the-system-design-primer"
id="toc-the-system-design-primer">The System Design Primer</a>
<ul>
<li><a href="#motivation" id="toc-motivation">Motivation</a>
<ul>
<li><a href="#learn-how-to-design-large-scale-systems"
id="toc-learn-how-to-design-large-scale-systems">Learn how to design
large-scale systems</a></li>
<li><a href="#learn-from-the-open-source-community"
id="toc-learn-from-the-open-source-community">Learn from the open source
community</a></li>
<li><a href="#prep-for-the-system-design-interview"
id="toc-prep-for-the-system-design-interview">Prep for the system design
interview</a></li>
</ul></li>
<li><a href="#anki-flashcards" id="toc-anki-flashcards">Anki
flashcards</a>
<ul>
<li><a href="#coding-resource-interactive-coding-challenges"
id="toc-coding-resource-interactive-coding-challenges">Coding Resource:
Interactive Coding Challenges</a></li>
</ul></li>
<li><a href="#contributing" id="toc-contributing">Contributing</a></li>
<li><a href="#index-of-system-design-topics"
id="toc-index-of-system-design-topics">Index of system design
topics</a></li>
<li><a href="#study-guide" id="toc-study-guide">Study guide</a></li>
<li><a href="#how-to-approach-a-system-design-interview-question"
id="toc-how-to-approach-a-system-design-interview-question">How to
approach a system design interview question</a>
<ul>
<li><a href="#step-1-outline-use-cases-constraints-and-assumptions"
id="toc-step-1-outline-use-cases-constraints-and-assumptions">Step 1:
Outline use cases, constraints, and assumptions</a></li>
<li><a href="#step-2-create-a-high-level-design"
id="toc-step-2-create-a-high-level-design">Step 2: Create a high level
design</a></li>
<li><a href="#step-3-design-core-components"
id="toc-step-3-design-core-components">Step 3: Design core
components</a></li>
<li><a href="#step-4-scale-the-design"
id="toc-step-4-scale-the-design">Step 4: Scale the design</a></li>
<li><a href="#back-of-the-envelope-calculations"
id="toc-back-of-the-envelope-calculations">Back-of-the-envelope
calculations</a></li>
<li><a href="#sources-and-further-reading"
id="toc-sources-and-further-reading">Source(s) and further
reading</a></li>
</ul></li>
<li><a href="#system-design-interview-questions-with-solutions"
id="toc-system-design-interview-questions-with-solutions">System design
interview questions with solutions</a>
<ul>
<li><a href="#design-pastebin.com-or-bit.ly"
id="toc-design-pastebin.com-or-bit.ly">Design Pastebin.com (or
Bit.ly)</a></li>
<li><a
href="#design-the-twitter-timeline-and-search-or-facebook-feed-and-search"
id="toc-design-the-twitter-timeline-and-search-or-facebook-feed-and-search">Design
the Twitter timeline and search (or Facebook feed and search)</a></li>
<li><a href="#design-a-web-crawler" id="toc-design-a-web-crawler">Design
a web crawler</a></li>
<li><a href="#design-mint.com" id="toc-design-mint.com">Design
Mint.com</a></li>
<li><a href="#design-the-data-structures-for-a-social-network"
id="toc-design-the-data-structures-for-a-social-network">Design the data
structures for a social network</a></li>
<li><a href="#design-a-key-value-store-for-a-search-engine"
id="toc-design-a-key-value-store-for-a-search-engine">Design a key-value
store for a search engine</a></li>
<li><a href="#design-amazons-sales-ranking-by-category-feature"
id="toc-design-amazons-sales-ranking-by-category-feature">Design
Amazon’s sales ranking by category feature</a></li>
<li><a href="#design-a-system-that-scales-to-millions-of-users-on-aws"
id="toc-design-a-system-that-scales-to-millions-of-users-on-aws">Design
a system that scales to millions of users on AWS</a></li>
</ul></li>
<li><a href="#object-oriented-design-interview-questions-with-solutions"
id="toc-object-oriented-design-interview-questions-with-solutions">Object-oriented
design interview questions with solutions</a></li>
<li><a href="#system-design-topics-start-here"
id="toc-system-design-topics-start-here">System design topics: start
here</a>
<ul>
<li><a href="#step-1-review-the-scalability-video-lecture"
id="toc-step-1-review-the-scalability-video-lecture">Step 1: Review the
scalability video lecture</a></li>
<li><a href="#step-2-review-the-scalability-article"
id="toc-step-2-review-the-scalability-article">Step 2: Review the
scalability article</a></li>
<li><a href="#next-steps" id="toc-next-steps">Next steps</a></li>
</ul></li>
<li><a href="#performance-vs-scalability"
id="toc-performance-vs-scalability">Performance vs scalability</a>
<ul>
<li><a href="#sources-and-further-reading-1"
id="toc-sources-and-further-reading-1">Source(s) and further
reading</a></li>
</ul></li>
<li><a href="#latency-vs-throughput"
id="toc-latency-vs-throughput">Latency vs throughput</a>
<ul>
<li><a href="#sources-and-further-reading-2"
id="toc-sources-and-further-reading-2">Source(s) and further
reading</a></li>
</ul></li>
<li><a href="#availability-vs-consistency"
id="toc-availability-vs-consistency">Availability vs consistency</a>
<ul>
<li><a href="#cap-theorem" id="toc-cap-theorem">CAP theorem</a></li>
<li><a href="#sources-and-further-reading-3"
id="toc-sources-and-further-reading-3">Source(s) and further
reading</a></li>
</ul></li>
<li><a href="#consistency-patterns"
id="toc-consistency-patterns">Consistency patterns</a>
<ul>
<li><a href="#weak-consistency" id="toc-weak-consistency">Weak
consistency</a></li>
<li><a href="#eventual-consistency"
id="toc-eventual-consistency">Eventual consistency</a></li>
<li><a href="#strong-consistency" id="toc-strong-consistency">Strong
consistency</a></li>
<li><a href="#sources-and-further-reading-4"
id="toc-sources-and-further-reading-4">Source(s) and further
reading</a></li>
</ul></li>
<li><a href="#availability-patterns"
id="toc-availability-patterns">Availability patterns</a>
<ul>
<li><a href="#fail-over" id="toc-fail-over">Fail-over</a></li>
<li><a href="#disadvantages-failover"
id="toc-disadvantages-failover">Disadvantage(s): failover</a></li>
<li><a href="#replication" id="toc-replication">Replication</a></li>
<li><a href="#availability-in-numbers"
id="toc-availability-in-numbers">Availability in numbers</a></li>
</ul></li>
<li><a href="#domain-name-system" id="toc-domain-name-system">Domain
name system</a>
<ul>
<li><a href="#disadvantages-dns"
id="toc-disadvantages-dns">Disadvantage(s): DNS</a></li>
<li><a href="#sources-and-further-reading-5"
id="toc-sources-and-further-reading-5">Source(s) and further
reading</a></li>
</ul></li>
<li><a href="#content-delivery-network"
id="toc-content-delivery-network">Content delivery network</a>
<ul>
<li><a href="#push-cdns" id="toc-push-cdns">Push CDNs</a></li>
<li><a href="#pull-cdns" id="toc-pull-cdns">Pull CDNs</a></li>
<li><a href="#disadvantages-cdn"
id="toc-disadvantages-cdn">Disadvantage(s): CDN</a></li>
<li><a href="#sources-and-further-reading-6"
id="toc-sources-and-further-reading-6">Source(s) and further
reading</a></li>
</ul></li>
<li><a href="#load-balancer" id="toc-load-balancer">Load balancer</a>
<ul>
<li><a href="#layer-4-load-balancing"
id="toc-layer-4-load-balancing">Layer 4 load balancing</a></li>
<li><a href="#layer-7-load-balancing"
id="toc-layer-7-load-balancing">Layer 7 load balancing</a></li>
<li><a href="#horizontal-scaling" id="toc-horizontal-scaling">Horizontal
scaling</a></li>
<li><a href="#disadvantages-load-balancer"
id="toc-disadvantages-load-balancer">Disadvantage(s): load
balancer</a></li>
<li><a href="#sources-and-further-reading-7"
id="toc-sources-and-further-reading-7">Source(s) and further
reading</a></li>
</ul></li>
<li><a href="#reverse-proxy-web-server"
id="toc-reverse-proxy-web-server">Reverse proxy (web server)</a>
<ul>
<li><a href="#load-balancer-vs-reverse-proxy"
id="toc-load-balancer-vs-reverse-proxy">Load balancer vs reverse
proxy</a></li>
<li><a href="#disadvantages-reverse-proxy"
id="toc-disadvantages-reverse-proxy">Disadvantage(s): reverse
proxy</a></li>
<li><a href="#sources-and-further-reading-8"
id="toc-sources-and-further-reading-8">Source(s) and further
reading</a></li>
</ul></li>
<li><a href="#application-layer" id="toc-application-layer">Application
layer</a>
<ul>
<li><a href="#microservices"
id="toc-microservices">Microservices</a></li>
<li><a href="#service-discovery" id="toc-service-discovery">Service
Discovery</a></li>
<li><a href="#disadvantages-application-layer"
id="toc-disadvantages-application-layer">Disadvantage(s): application
layer</a></li>
<li><a href="#sources-and-further-reading-9"
id="toc-sources-and-further-reading-9">Source(s) and further
reading</a></li>
</ul></li>
<li><a href="#database" id="toc-database">Database</a>
<ul>
<li><a href="#relational-database-management-system-rdbms"
id="toc-relational-database-management-system-rdbms">Relational database
management system (RDBMS)</a></li>
<li><a href="#nosql" id="toc-nosql">NoSQL</a></li>
<li><a href="#sql-or-nosql" id="toc-sql-or-nosql">SQL or NoSQL</a></li>
</ul></li>
<li><a href="#cache" id="toc-cache">Cache</a>
<ul>
<li><a href="#client-caching" id="toc-client-caching">Client
caching</a></li>
<li><a href="#cdn-caching" id="toc-cdn-caching">CDN caching</a></li>
<li><a href="#web-server-caching" id="toc-web-server-caching">Web server
caching</a></li>
<li><a href="#database-caching" id="toc-database-caching">Database
caching</a></li>
<li><a href="#application-caching"
id="toc-application-caching">Application caching</a></li>
<li><a href="#caching-at-the-database-query-level"
id="toc-caching-at-the-database-query-level">Caching at the database
query level</a></li>
<li><a href="#caching-at-the-object-level"
id="toc-caching-at-the-object-level">Caching at the object
level</a></li>
<li><a href="#when-to-update-the-cache"
id="toc-when-to-update-the-cache">When to update the cache</a></li>
<li><a href="#disadvantages-cache"
id="toc-disadvantages-cache">Disadvantage(s): cache</a></li>
<li><a href="#sources-and-further-reading-10"
id="toc-sources-and-further-reading-10">Source(s) and further
reading</a></li>
</ul></li>
<li><a href="#asynchronism" id="toc-asynchronism">Asynchronism</a>
<ul>
<li><a href="#message-queues" id="toc-message-queues">Message
queues</a></li>
<li><a href="#task-queues" id="toc-task-queues">Task queues</a></li>
<li><a href="#back-pressure" id="toc-back-pressure">Back
pressure</a></li>
<li><a href="#disadvantages-asynchronism"
id="toc-disadvantages-asynchronism">Disadvantage(s):
asynchronism</a></li>
<li><a href="#sources-and-further-reading-11"
id="toc-sources-and-further-reading-11">Source(s) and further
reading</a></li>
</ul></li>
<li><a href="#communication" id="toc-communication">Communication</a>
<ul>
<li><a href="#hypertext-transfer-protocol-http"
id="toc-hypertext-transfer-protocol-http">Hypertext transfer protocol
(HTTP)</a></li>
<li><a href="#transmission-control-protocol-tcp"
id="toc-transmission-control-protocol-tcp">Transmission control protocol
(TCP)</a></li>
<li><a href="#user-datagram-protocol-udp"
id="toc-user-datagram-protocol-udp">User datagram protocol
(UDP)</a></li>
<li><a href="#remote-procedure-call-rpc"
id="toc-remote-procedure-call-rpc">Remote procedure call (RPC)</a></li>
<li><a href="#representational-state-transfer-rest"
id="toc-representational-state-transfer-rest">Representational state
transfer (REST)</a></li>
<li><a href="#rpc-and-rest-calls-comparison"
id="toc-rpc-and-rest-calls-comparison">RPC and REST calls
comparison</a></li>
</ul></li>
<li><a href="#security" id="toc-security">Security</a>
<ul>
<li><a href="#sources-and-further-reading-12"
id="toc-sources-and-further-reading-12">Source(s) and further
reading</a></li>
</ul></li>
<li><a href="#appendix" id="toc-appendix">Appendix</a>
<ul>
<li><a href="#powers-of-two-table" id="toc-powers-of-two-table">Powers
of two table</a></li>
<li><a href="#latency-numbers-every-programmer-should-know"
id="toc-latency-numbers-every-programmer-should-know">Latency numbers
every programmer should know</a></li>
<li><a href="#additional-system-design-interview-questions"
id="toc-additional-system-design-interview-questions">Additional system
design interview questions</a></li>
<li><a href="#real-world-architectures"
id="toc-real-world-architectures">Real world architectures</a></li>
<li><a href="#company-architectures"
id="toc-company-architectures">Company architectures</a></li>
<li><a href="#company-engineering-blogs"
id="toc-company-engineering-blogs">Company engineering blogs</a></li>
</ul></li>
<li><a href="#under-development" id="toc-under-development">Under
development</a></li>
<li><a href="#credits" id="toc-credits">Credits</a></li>
<li><a href="#contact-info" id="toc-contact-info">Contact info</a></li>
<li><a href="#license" id="toc-license">License</a></li>
</ul></li>
<li><a href="#contributing-1"
id="toc-contributing-1">CONTRIBUTING</a></li>
<li><a href="#contributing-2" id="toc-contributing-2">Contributing</a>
<ul>
<li><a href="#bug-reports" id="toc-bug-reports">Bug Reports</a></li>
<li><a href="#pull-requests" id="toc-pull-requests">Pull Requests</a>
<ul>
<li><a href="#github-pull-requests-docs"
id="toc-github-pull-requests-docs">GitHub Pull Requests Docs</a></li>
</ul></li>
<li><a href="#translations" id="toc-translations">Translations</a>
<ul>
<li><a href="#changes-to-translations"
id="toc-changes-to-translations">Changes to translations</a></li>
<li><a href="#adding-translations-to-new-languages"
id="toc-adding-translations-to-new-languages">Adding translations to new
languages</a></li>
<li><a href="#translation-template-credits"
id="toc-translation-template-credits">Translation template
credits</a></li>
</ul></li>
</ul></li>
<li><a href="#system-design-pastebin"
id="toc-system-design-pastebin">System Design: Pastebin</a></li>
<li><a href="#design-pastebin.com-or-bit.ly-1"
id="toc-design-pastebin.com-or-bit.ly-1">Design Pastebin.com (or
Bit.ly)</a>
<ul>
<li><a href="#step-1-outline-use-cases-and-constraints"
id="toc-step-1-outline-use-cases-and-constraints">Step 1: Outline use
cases and constraints</a>
<ul>
<li><a href="#use-cases" id="toc-use-cases">Use cases</a></li>
<li><a href="#constraints-and-assumptions"
id="toc-constraints-and-assumptions">Constraints and
assumptions</a></li>
</ul></li>
<li><a href="#step-2-create-a-high-level-design-1"
id="toc-step-2-create-a-high-level-design-1">Step 2: Create a high level
design</a></li>
<li><a href="#step-3-design-core-components-1"
id="toc-step-3-design-core-components-1">Step 3: Design core
components</a>
<ul>
<li><a
href="#use-case-user-enters-a-block-of-text-and-gets-a-randomly-generated-link"
id="toc-use-case-user-enters-a-block-of-text-and-gets-a-randomly-generated-link">Use
case: User enters a block of text and gets a randomly generated
link</a></li>
<li><a href="#use-case-user-enters-a-pastes-url-and-views-the-contents"
id="toc-use-case-user-enters-a-pastes-url-and-views-the-contents">Use
case: User enters a paste’s url and views the contents</a></li>
<li><a href="#use-case-service-tracks-analytics-of-pages"
id="toc-use-case-service-tracks-analytics-of-pages">Use case: Service
tracks analytics of pages</a></li>
<li><a href="#use-case-service-deletes-expired-pastes"
id="toc-use-case-service-deletes-expired-pastes">Use case: Service
deletes expired pastes</a></li>
</ul></li>
<li><a href="#step-4-scale-the-design-1"
id="toc-step-4-scale-the-design-1">Step 4: Scale the design</a></li>
<li><a href="#additional-talking-points"
id="toc-additional-talking-points">Additional talking points</a>
<ul>
<li><a href="#caching" id="toc-caching">Caching</a></li>
<li><a href="#asynchronism-and-microservices"
id="toc-asynchronism-and-microservices">Asynchronism and
microservices</a></li>
<li><a href="#communications"
id="toc-communications">Communications</a></li>
<li><a href="#security-1" id="toc-security-1">Security</a></li>
<li><a href="#latency-numbers" id="toc-latency-numbers">Latency
numbers</a></li>
<li><a href="#ongoing" id="toc-ongoing">Ongoing</a></li>
</ul></li>
</ul></li>
<li><a href="#system-design-twitter"
id="toc-system-design-twitter">System Design: Twitter</a></li>
<li><a href="#design-the-twitter-timeline-and-search"
id="toc-design-the-twitter-timeline-and-search">Design the Twitter
timeline and search</a>
<ul>
<li><a href="#step-1-outline-use-cases-and-constraints-1"
id="toc-step-1-outline-use-cases-and-constraints-1">Step 1: Outline use
cases and constraints</a>
<ul>
<li><a href="#use-cases-1" id="toc-use-cases-1">Use cases</a></li>
<li><a href="#constraints-and-assumptions-1"
id="toc-constraints-and-assumptions-1">Constraints and
assumptions</a></li>
</ul></li>
<li><a href="#step-2-create-a-high-level-design-2"
id="toc-step-2-create-a-high-level-design-2">Step 2: Create a high level
design</a></li>
<li><a href="#step-3-design-core-components-2"
id="toc-step-3-design-core-components-2">Step 3: Design core
components</a>
<ul>
<li><a href="#use-case-user-posts-a-tweet"
id="toc-use-case-user-posts-a-tweet">Use case: User posts a
tweet</a></li>
<li><a href="#use-case-user-views-the-home-timeline"
id="toc-use-case-user-views-the-home-timeline">Use case: User views the
home timeline</a></li>
<li><a href="#use-case-user-views-the-user-timeline"
id="toc-use-case-user-views-the-user-timeline">Use case: User views the
user timeline</a></li>
<li><a href="#use-case-user-searches-keywords"
id="toc-use-case-user-searches-keywords">Use case: User searches
keywords</a></li>
</ul></li>
<li><a href="#step-4-scale-the-design-2"
id="toc-step-4-scale-the-design-2">Step 4: Scale the design</a></li>
<li><a href="#additional-talking-points-1"
id="toc-additional-talking-points-1">Additional talking points</a>
<ul>
<li><a href="#caching-1" id="toc-caching-1">Caching</a></li>
<li><a href="#asynchronism-and-microservices-1"
id="toc-asynchronism-and-microservices-1">Asynchronism and
microservices</a></li>
<li><a href="#communications-1"
id="toc-communications-1">Communications</a></li>
<li><a href="#security-2" id="toc-security-2">Security</a></li>
<li><a href="#latency-numbers-1" id="toc-latency-numbers-1">Latency
numbers</a></li>
<li><a href="#ongoing-1" id="toc-ongoing-1">Ongoing</a></li>
</ul></li>
</ul></li>
<li><a href="#system-design-web-crawler"
id="toc-system-design-web-crawler">System Design: Web Crawler</a></li>
<li><a href="#design-a-web-crawler-1"
id="toc-design-a-web-crawler-1">Design a web crawler</a>
<ul>
<li><a href="#step-1-outline-use-cases-and-constraints-2"
id="toc-step-1-outline-use-cases-and-constraints-2">Step 1: Outline use
cases and constraints</a>
<ul>
<li><a href="#use-cases-2" id="toc-use-cases-2">Use cases</a></li>
<li><a href="#constraints-and-assumptions-2"
id="toc-constraints-and-assumptions-2">Constraints and
assumptions</a></li>
</ul></li>
<li><a href="#step-2-create-a-high-level-design-3"
id="toc-step-2-create-a-high-level-design-3">Step 2: Create a high level
design</a></li>
<li><a href="#step-3-design-core-components-3"
id="toc-step-3-design-core-components-3">Step 3: Design core
components</a>
<ul>
<li><a href="#use-case-service-crawls-a-list-of-urls"
id="toc-use-case-service-crawls-a-list-of-urls">Use case: Service crawls
a list of urls</a></li>
<li><a href="#handling-duplicates" id="toc-handling-duplicates">Handling
duplicates</a></li>
<li><a href="#determining-when-to-update-the-crawl-results"
id="toc-determining-when-to-update-the-crawl-results">Determining when
to update the crawl results</a></li>
<li><a
href="#use-case-user-inputs-a-search-term-and-sees-a-list-of-relevant-pages-with-titles-and-snippets"
id="toc-use-case-user-inputs-a-search-term-and-sees-a-list-of-relevant-pages-with-titles-and-snippets">Use
case: User inputs a search term and sees a list of relevant pages with
titles and snippets</a></li>
</ul></li>
<li><a href="#step-4-scale-the-design-3"
id="toc-step-4-scale-the-design-3">Step 4: Scale the design</a></li>
<li><a href="#additional-talking-points-2"
id="toc-additional-talking-points-2">Additional talking points</a>
<ul>
<li><a href="#sql-scaling-patterns" id="toc-sql-scaling-patterns">SQL
scaling patterns</a></li>
<li><a href="#caching-2" id="toc-caching-2">Caching</a></li>
<li><a href="#asynchronism-and-microservices-2"
id="toc-asynchronism-and-microservices-2">Asynchronism and
microservices</a></li>
<li><a href="#communications-2"
id="toc-communications-2">Communications</a></li>
<li><a href="#security-3" id="toc-security-3">Security</a></li>
<li><a href="#latency-numbers-2" id="toc-latency-numbers-2">Latency
numbers</a></li>
<li><a href="#ongoing-2" id="toc-ongoing-2">Ongoing</a></li>
</ul></li>
</ul></li>
<li><a href="#system-design-mint" id="toc-system-design-mint">System
Design: Mint</a></li>
<li><a href="#design-mint.com-1" id="toc-design-mint.com-1">Design
Mint.com</a>
<ul>
<li><a href="#step-1-outline-use-cases-and-constraints-3"
id="toc-step-1-outline-use-cases-and-constraints-3">Step 1: Outline use
cases and constraints</a>
<ul>
<li><a href="#use-cases-3" id="toc-use-cases-3">Use cases</a></li>
<li><a href="#constraints-and-assumptions-3"
id="toc-constraints-and-assumptions-3">Constraints and
assumptions</a></li>
</ul></li>
<li><a href="#step-2-create-a-high-level-design-4"
id="toc-step-2-create-a-high-level-design-4">Step 2: Create a high level
design</a></li>
<li><a href="#step-3-design-core-components-4"
id="toc-step-3-design-core-components-4">Step 3: Design core
components</a>
<ul>
<li><a href="#use-case-user-connects-to-a-financial-account"
id="toc-use-case-user-connects-to-a-financial-account">Use case: User
connects to a financial account</a></li>
<li><a href="#use-case-service-extracts-transactions-from-the-account"
id="toc-use-case-service-extracts-transactions-from-the-account">Use
case: Service extracts transactions from the account</a></li>
<li><a href="#use-case-service-recommends-a-budget"
id="toc-use-case-service-recommends-a-budget">Use case: Service
recommends a budget</a></li>
</ul></li>
<li><a href="#step-4-scale-the-design-4"
id="toc-step-4-scale-the-design-4">Step 4: Scale the design</a></li>
<li><a href="#additional-talking-points-3"
id="toc-additional-talking-points-3">Additional talking points</a>
<ul>
<li><a href="#caching-3" id="toc-caching-3">Caching</a></li>
<li><a href="#asynchronism-and-microservices-3"
id="toc-asynchronism-and-microservices-3">Asynchronism and
microservices</a></li>
<li><a href="#communications-3"
id="toc-communications-3">Communications</a></li>
<li><a href="#security-4" id="toc-security-4">Security</a></li>
<li><a href="#latency-numbers-3" id="toc-latency-numbers-3">Latency
numbers</a></li>
<li><a href="#ongoing-3" id="toc-ongoing-3">Ongoing</a></li>
</ul></li>
</ul></li>
<li><a href="#system-design-social-graph"
id="toc-system-design-social-graph">System Design: Social Graph</a></li>
<li><a href="#design-the-data-structures-for-a-social-network-1"
id="toc-design-the-data-structures-for-a-social-network-1">Design the
data structures for a social network</a>
<ul>
<li><a href="#step-1-outline-use-cases-and-constraints-4"
id="toc-step-1-outline-use-cases-and-constraints-4">Step 1: Outline use
cases and constraints</a>
<ul>
<li><a href="#use-cases-4" id="toc-use-cases-4">Use cases</a></li>
<li><a href="#constraints-and-assumptions-4"
id="toc-constraints-and-assumptions-4">Constraints and
assumptions</a></li>
</ul></li>
<li><a href="#step-2-create-a-high-level-design-5"
id="toc-step-2-create-a-high-level-design-5">Step 2: Create a high level
design</a></li>
<li><a href="#step-3-design-core-components-5"
id="toc-step-3-design-core-components-5">Step 3: Design core
components</a>
<ul>
<li><a
href="#use-case-user-searches-for-someone-and-sees-the-shortest-path-to-the-searched-person"
id="toc-use-case-user-searches-for-someone-and-sees-the-shortest-path-to-the-searched-person">Use
case: User searches for someone and sees the shortest path to the
searched person</a></li>
</ul></li>
<li><a href="#step-4-scale-the-design-5"
id="toc-step-4-scale-the-design-5">Step 4: Scale the design</a></li>
<li><a href="#additional-talking-points-4"
id="toc-additional-talking-points-4">Additional talking points</a>
<ul>
<li><a href="#sql-scaling-patterns-1"
id="toc-sql-scaling-patterns-1">SQL scaling patterns</a></li>
<li><a href="#caching-4" id="toc-caching-4">Caching</a></li>
<li><a href="#asynchronism-and-microservices-4"
id="toc-asynchronism-and-microservices-4">Asynchronism and
microservices</a></li>
<li><a href="#communications-4"
id="toc-communications-4">Communications</a></li>
<li><a href="#security-5" id="toc-security-5">Security</a></li>
<li><a href="#latency-numbers-4" id="toc-latency-numbers-4">Latency
numbers</a></li>
<li><a href="#ongoing-4" id="toc-ongoing-4">Ongoing</a></li>
</ul></li>
</ul></li>
<li><a href="#system-design-query-cache"
id="toc-system-design-query-cache">System Design: Query Cache</a></li>
<li><a
href="#design-a-key-value-cache-to-save-the-results-of-the-most-recent-web-server-queries"
id="toc-design-a-key-value-cache-to-save-the-results-of-the-most-recent-web-server-queries">Design
a key-value cache to save the results of the most recent web server
queries</a>
<ul>
<li><a href="#step-1-outline-use-cases-and-constraints-5"
id="toc-step-1-outline-use-cases-and-constraints-5">Step 1: Outline use
cases and constraints</a>
<ul>
<li><a href="#use-cases-5" id="toc-use-cases-5">Use cases</a></li>
<li><a href="#constraints-and-assumptions-5"
id="toc-constraints-and-assumptions-5">Constraints and
assumptions</a></li>
</ul></li>
<li><a href="#step-2-create-a-high-level-design-6"
id="toc-step-2-create-a-high-level-design-6">Step 2: Create a high level
design</a></li>
<li><a href="#step-3-design-core-components-6"
id="toc-step-3-design-core-components-6">Step 3: Design core
components</a>
<ul>
<li><a href="#use-case-user-sends-a-request-resulting-in-a-cache-hit"
id="toc-use-case-user-sends-a-request-resulting-in-a-cache-hit">Use
case: User sends a request resulting in a cache hit</a></li>
</ul></li>
<li><a href="#step-4-scale-the-design-6"
id="toc-step-4-scale-the-design-6">Step 4: Scale the design</a>
<ul>
<li><a href="#expanding-the-memory-cache-to-many-machines"
id="toc-expanding-the-memory-cache-to-many-machines">Expanding the
Memory Cache to many machines</a></li>
</ul></li>
<li><a href="#additional-talking-points-5"
id="toc-additional-talking-points-5">Additional talking points</a>
<ul>
<li><a href="#sql-scaling-patterns-2"
id="toc-sql-scaling-patterns-2">SQL scaling patterns</a></li>
<li><a href="#caching-5" id="toc-caching-5">Caching</a></li>
<li><a href="#asynchronism-and-microservices-5"
id="toc-asynchronism-and-microservices-5">Asynchronism and
microservices</a></li>
<li><a href="#communications-5"
id="toc-communications-5">Communications</a></li>
<li><a href="#security-6" id="toc-security-6">Security</a></li>
<li><a href="#latency-numbers-5" id="toc-latency-numbers-5">Latency
numbers</a></li>
<li><a href="#ongoing-5" id="toc-ongoing-5">Ongoing</a></li>
</ul></li>
</ul></li>
<li><a href="#system-design-sales-rank"
id="toc-system-design-sales-rank">System Design: Sales Rank</a></li>
<li><a href="#design-amazons-sales-rank-by-category-feature"
id="toc-design-amazons-sales-rank-by-category-feature">Design Amazon’s
sales rank by category feature</a>
<ul>
<li><a href="#step-1-outline-use-cases-and-constraints-6"
id="toc-step-1-outline-use-cases-and-constraints-6">Step 1: Outline use
cases and constraints</a>
<ul>
<li><a href="#use-cases-6" id="toc-use-cases-6">Use cases</a></li>
<li><a href="#constraints-and-assumptions-6"
id="toc-constraints-and-assumptions-6">Constraints and
assumptions</a></li>
</ul></li>
<li><a href="#step-2-create-a-high-level-design-7"
id="toc-step-2-create-a-high-level-design-7">Step 2: Create a high level
design</a></li>
<li><a href="#step-3-design-core-components-7"
id="toc-step-3-design-core-components-7">Step 3: Design core
components</a>
<ul>
<li><a
href="#use-case-service-calculates-the-past-weeks-most-popular-products-by-category"
id="toc-use-case-service-calculates-the-past-weeks-most-popular-products-by-category">Use
case: Service calculates the past week’s most popular products by
category</a></li>
<li><a
href="#use-case-user-views-the-past-weeks-most-popular-products-by-category"
id="toc-use-case-user-views-the-past-weeks-most-popular-products-by-category">Use
case: User views the past week’s most popular products by
category</a></li>
</ul></li>
<li><a href="#step-4-scale-the-design-7"
id="toc-step-4-scale-the-design-7">Step 4: Scale the design</a></li>
<li><a href="#additional-talking-points-6"
id="toc-additional-talking-points-6">Additional talking points</a>
<ul>
<li><a href="#caching-6" id="toc-caching-6">Caching</a></li>
<li><a href="#asynchronism-and-microservices-6"
id="toc-asynchronism-and-microservices-6">Asynchronism and
microservices</a></li>
<li><a href="#communications-6"
id="toc-communications-6">Communications</a></li>
<li><a href="#security-7" id="toc-security-7">Security</a></li>
<li><a href="#latency-numbers-6" id="toc-latency-numbers-6">Latency
numbers</a></li>
<li><a href="#ongoing-6" id="toc-ongoing-6">Ongoing</a></li>
</ul></li>
</ul></li>
<li><a href="#system-design-scaling-aws"
id="toc-system-design-scaling-aws">System Design: Scaling Aws</a></li>
<li><a href="#design-a-system-that-scales-to-millions-of-users-on-aws-1"
id="toc-design-a-system-that-scales-to-millions-of-users-on-aws-1">Design
a system that scales to millions of users on AWS</a>
<ul>
<li><a href="#step-1-outline-use-cases-and-constraints-7"
id="toc-step-1-outline-use-cases-and-constraints-7">Step 1: Outline use
cases and constraints</a>
<ul>
<li><a href="#use-cases-7" id="toc-use-cases-7">Use cases</a></li>
<li><a href="#constraints-and-assumptions-7"
id="toc-constraints-and-assumptions-7">Constraints and
assumptions</a></li>
</ul></li>
<li><a href="#step-2-create-a-high-level-design-8"
id="toc-step-2-create-a-high-level-design-8">Step 2: Create a high level
design</a></li>
<li><a href="#step-3-design-core-components-8"
id="toc-step-3-design-core-components-8">Step 3: Design core
components</a>
<ul>
<li><a href="#use-case-user-makes-a-read-or-write-request"
id="toc-use-case-user-makes-a-read-or-write-request">Use case: User
makes a read or write request</a></li>
</ul></li>
<li><a href="#step-4-scale-the-design-8"
id="toc-step-4-scale-the-design-8">Step 4: Scale the design</a>
<ul>
<li><a href="#users" id="toc-users">Users+</a></li>
<li><a href="#users-1" id="toc-users-1">Users++</a></li>
<li><a href="#users-2" id="toc-users-2">Users+++</a></li>
<li><a href="#users-3" id="toc-users-3">Users++++</a></li>
<li><a href="#users-4" id="toc-users-4">Users+++++</a></li>
</ul></li>
<li><a href="#additional-talking-points-7"
id="toc-additional-talking-points-7">Additional talking points</a>
<ul>
<li><a href="#sql-scaling-patterns-3"
id="toc-sql-scaling-patterns-3">SQL scaling patterns</a></li>
<li><a href="#caching-7" id="toc-caching-7">Caching</a></li>
<li><a href="#asynchronism-and-microservices-7"
id="toc-asynchronism-and-microservices-7">Asynchronism and
microservices</a></li>
<li><a href="#communications-7"
id="toc-communications-7">Communications</a></li>
<li><a href="#security-8" id="toc-security-8">Security</a></li>
<li><a href="#latency-numbers-7" id="toc-latency-numbers-7">Latency
numbers</a></li>
<li><a href="#ongoing-7" id="toc-ongoing-7">Ongoing</a></li>
</ul></li>
</ul></li>
<li><a href="#object-oriented-design-hash-table"
id="toc-object-oriented-design-hash-table">Object Oriented Design: Hash
Table</a></li>
<li><a href="#design-a-hash-map" id="toc-design-a-hash-map">Design a
hash map</a></li>
<li><a href="#constraints-and-assumptions-8"
id="toc-constraints-and-assumptions-8">Constraints and
assumptions</a></li>
<li><a href="#solution" id="toc-solution">Solution</a></li>
<li><a href="#object-oriented-design-lru-cache"
id="toc-object-oriented-design-lru-cache">Object Oriented Design: Lru
Cache</a></li>
<li><a href="#design-an-lru-cache" id="toc-design-an-lru-cache">Design
an LRU cache</a></li>
<li><a href="#constraints-and-assumptions-9"
id="toc-constraints-and-assumptions-9">Constraints and
assumptions</a></li>
<li><a href="#solution-1" id="toc-solution-1">Solution</a></li>
<li><a href="#object-oriented-design-call-center"
id="toc-object-oriented-design-call-center">Object Oriented Design: Call
Center</a></li>
<li><a href="#design-a-call-center" id="toc-design-a-call-center">Design
a call center</a></li>
<li><a href="#constraints-and-assumptions-10"
id="toc-constraints-and-assumptions-10">Constraints and
assumptions</a></li>
<li><a href="#solution-2" id="toc-solution-2">Solution</a></li>
<li><a href="#object-oriented-design-deck-of-cards"
id="toc-object-oriented-design-deck-of-cards">Object Oriented Design:
Deck Of Cards</a></li>
<li><a href="#design-a-deck-of-cards"
id="toc-design-a-deck-of-cards">Design a deck of cards</a></li>
<li><a href="#constraints-and-assumptions-11"
id="toc-constraints-and-assumptions-11">Constraints and
assumptions</a></li>
<li><a href="#solution-3" id="toc-solution-3">Solution</a></li>
<li><a href="#object-oriented-design-parking-lot"
id="toc-object-oriented-design-parking-lot">Object Oriented Design:
Parking Lot</a></li>
<li><a href="#design-a-parking-lot" id="toc-design-a-parking-lot">Design
a parking lot</a></li>
<li><a href="#constraints-and-assumptions-12"
id="toc-constraints-and-assumptions-12">Constraints and
assumptions</a></li>
<li><a href="#solution-4" id="toc-solution-4">Solution</a></li>
<li><a href="#object-oriented-design-online-chat"
id="toc-object-oriented-design-online-chat">Object Oriented Design:
Online Chat</a></li>
<li><a href="#design-an-online-chat"
id="toc-design-an-online-chat">Design an online chat</a></li>
<li><a href="#constraints-and-assumptions-13"
id="toc-constraints-and-assumptions-13">Constraints and
assumptions</a></li>
<li><a href="#solution-5" id="toc-solution-5">Solution</a></li>
</ul>
</nav>
<p><em><a href="#main-readme">English</a> • <a href="#-ja">日本語</a> •
<a href="#-zh-hans">简体中文</a> • <a href="#-zh-tw">繁體中文</a> | <a
href="https://github.com/donnemartin/system-design-primer/issues/170">العَرَبِيَّة‎</a>
• <a
href="https://github.com/donnemartin/system-design-primer/issues/220">বাংলা</a>
• <a
href="https://github.com/donnemartin/system-design-primer/issues/40">Português
do Brasil</a> • <a
href="https://github.com/donnemartin/system-design-primer/issues/186">Deutsch</a>
• <a
href="https://github.com/donnemartin/system-design-primer/issues/130">ελληνικά</a>
• <a
href="https://github.com/donnemartin/system-design-primer/issues/272">עברית</a>
• <a
href="https://github.com/donnemartin/system-design-primer/issues/104">Italiano</a>
• <a
href="https://github.com/donnemartin/system-design-primer/issues/102">한국어</a>
• <a
href="https://github.com/donnemartin/system-design-primer/issues/110">فارسی</a>
• <a
href="https://github.com/donnemartin/system-design-primer/issues/68">Polski</a>
• <a
href="https://github.com/donnemartin/system-design-primer/issues/87">русский
язык</a> • <a
href="https://github.com/donnemartin/system-design-primer/issues/136">Español</a>
• <a
href="https://github.com/donnemartin/system-design-primer/issues/187">ภาษาไทย</a>
• <a
href="https://github.com/donnemartin/system-design-primer/issues/39">Türkçe</a>
• <a
href="https://github.com/donnemartin/system-design-primer/issues/127">tiếng
Việt</a> • <a
href="https://github.com/donnemartin/system-design-primer/issues/250">Français</a>
| <a
href="https://github.com/donnemartin/system-design-primer/issues/28">Add
Translation</a></em></p>
<p><strong>Help <a href="#translations">translate</a> this
guide!</strong></p>
<h1 id="the-system-design-primer">The System Design Primer</h1>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/jj3A5N8.png"> <br/>
</p>
<h2 id="motivation">Motivation</h2>
<blockquote>
<p>Learn how to design large-scale systems.</p>
<p>Prep for the system design interview.</p>
</blockquote>
<h3 id="learn-how-to-design-large-scale-systems">Learn how to design
large-scale systems</h3>
<p>Learning how to design scalable systems will help you become a better
engineer.</p>
<p>System design is a broad topic. There is a <strong>vast amount of
resources scattered throughout the web</strong> on system design
principles.</p>
<p>This repo is an <strong>organized collection</strong> of resources to
help you learn how to build systems at scale.</p>
<h3 id="learn-from-the-open-source-community">Learn from the open source
community</h3>
<p>This is a continually updated, open source project.</p>
<p><a href="#contributing">Contributions</a> are welcome!</p>
<h3 id="prep-for-the-system-design-interview">Prep for the system design
interview</h3>
<p>In addition to coding interviews, system design is a <strong>required
component</strong> of the <strong>technical interview process</strong>
at many tech companies.</p>
<p><strong>Practice common system design interview questions</strong>
and <strong>compare</strong> your results with <strong>sample
solutions</strong>: discussions, code, and diagrams.</p>
<p>Additional topics for interview prep:</p>
<ul>
<li><a href="#study-guide">Study guide</a></li>
<li><a href="#how-to-approach-a-system-design-interview-question">How to
approach a system design interview question</a></li>
<li><a href="#system-design-interview-questions-with-solutions">System
design interview questions, <strong>with solutions</strong></a></li>
<li><a
href="#object-oriented-design-interview-questions-with-solutions">Object-oriented
design interview questions, <strong>with solutions</strong></a></li>
<li><a href="#additional-system-design-interview-questions">Additional
system design interview questions</a></li>
</ul>
<h2 id="anki-flashcards">Anki flashcards</h2>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/zdCAkB3.png"> <br/>
</p>
<p>The provided <a href="https://apps.ankiweb.net/" target="_blank">Anki flashcard
decks</a> use spaced repetition to help you retain key system design
concepts.</p>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer/tree/master/resources/flash_cards/System%20Design.apkg">System
design deck</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer/tree/master/resources/flash_cards/System%20Design%20Exercises.apkg">System
design exercises deck</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer/tree/master/resources/flash_cards/OO%20Design.apkg">Object
oriented design exercises deck</a></li>
</ul>
<p>Great for use while on-the-go.</p>
<h3 id="coding-resource-interactive-coding-challenges">Coding Resource:
Interactive Coding Challenges</h3>
<p>Looking for resources to help you prep for the <a
href="https://github.com/donnemartin/interactive-coding-challenges"><strong>Coding
Interview</strong></a>?</p>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/b4YtAEN.png"> <br/>
</p>
<p>Check out the sister repo <a
href="https://github.com/donnemartin/interactive-coding-challenges"><strong>Interactive
Coding Challenges</strong></a>, which contains an additional Anki
deck:</p>
<ul>
<li><a
href="https://github.com/donnemartin/interactive-coding-challenges/tree/master/anki_cards/Coding.apkg">Coding
deck</a></li>
</ul>
<h2 id="contributing">Contributing</h2>
<blockquote>
<p>Learn from the community.</p>
</blockquote>
<p>Feel free to submit pull requests to help:</p>
<ul>
<li>Fix errors</li>
<li>Improve sections</li>
<li>Add new sections</li>
<li><a
href="https://github.com/donnemartin/system-design-primer/issues/28">Translate</a></li>
</ul>
<p>Content that needs some polishing is placed <a
href="#under-development">under development</a>.</p>
<p>Review the <a href="#contributing">Contributing Guidelines</a>.</p>
<h2 id="index-of-system-design-topics">Index of system design
topics</h2>
<blockquote>
<p>Summaries of various system design topics, including pros and cons.
<strong>Everything is a trade-off</strong>.</p>
<p>Each section contains links to more in-depth resources.</p>
</blockquote>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/jrUBAF7.png"> <br/>
</p>
<ul>
<li><a href="#system-design-topics-start-here">System design topics:
start here</a>
<ul>
<li><a href="#step-1-review-the-scalability-video-lecture">Step 1:
Review the scalability video lecture</a></li>
<li><a href="#step-2-review-the-scalability-article">Step 2: Review the
scalability article</a></li>
<li><a href="#next-steps">Next steps</a></li>
</ul></li>
<li><a href="#performance-vs-scalability">Performance vs
scalability</a></li>
<li><a href="#latency-vs-throughput">Latency vs throughput</a></li>
<li><a href="#availability-vs-consistency">Availability vs
consistency</a>
<ul>
<li><a href="#cap-theorem">CAP theorem</a>
<ul>
<li><a href="#cp---consistency-and-partition-tolerance">CP - consistency
and partition tolerance</a></li>
<li><a href="#ap---availability-and-partition-tolerance">AP -
availability and partition tolerance</a></li>
</ul></li>
</ul></li>
<li><a href="#consistency-patterns">Consistency patterns</a>
<ul>
<li><a href="#weak-consistency">Weak consistency</a></li>
<li><a href="#eventual-consistency">Eventual consistency</a></li>
<li><a href="#strong-consistency">Strong consistency</a></li>
</ul></li>
<li><a href="#availability-patterns">Availability patterns</a>
<ul>
<li><a href="#fail-over">Fail-over</a></li>
<li><a href="#replication">Replication</a></li>
<li><a href="#availability-in-numbers">Availability in numbers</a></li>
</ul></li>
<li><a href="#domain-name-system">Domain name system</a></li>
<li><a href="#content-delivery-network">Content delivery network</a>
<ul>
<li><a href="#push-cdns">Push CDNs</a></li>
<li><a href="#pull-cdns">Pull CDNs</a></li>
</ul></li>
<li><a href="#load-balancer">Load balancer</a>
<ul>
<li><a href="#active-passive">Active-passive</a></li>
<li><a href="#active-active">Active-active</a></li>
<li><a href="#layer-4-load-balancing">Layer 4 load balancing</a></li>
<li><a href="#layer-7-load-balancing">Layer 7 load balancing</a></li>
<li><a href="#horizontal-scaling">Horizontal scaling</a></li>
</ul></li>
<li><a href="#reverse-proxy-web-server">Reverse proxy (web server)</a>
<ul>
<li><a href="#load-balancer-vs-reverse-proxy">Load balancer vs reverse
proxy</a></li>
</ul></li>
<li><a href="#application-layer">Application layer</a>
<ul>
<li><a href="#microservices">Microservices</a></li>
<li><a href="#service-discovery">Service discovery</a></li>
</ul></li>
<li><a href="#database">Database</a>
<ul>
<li><a href="#relational-database-management-system-rdbms">Relational
database management system (RDBMS)</a>
<ul>
<li><a href="#master-slave-replication">Master-slave
replication</a></li>
<li><a href="#master-master-replication">Master-master
replication</a></li>
<li><a href="#federation">Federation</a></li>
<li><a href="#sharding">Sharding</a></li>
<li><a href="#denormalization">Denormalization</a></li>
<li><a href="#sql-tuning">SQL tuning</a></li>
</ul></li>
<li><a href="#nosql">NoSQL</a>
<ul>
<li><a href="#key-value-store">Key-value store</a></li>
<li><a href="#document-store">Document store</a></li>
<li><a href="#wide-column-store">Wide column store</a></li>
<li><a href="#graph-database">Graph Database</a></li>
</ul></li>
<li><a href="#sql-or-nosql">SQL or NoSQL</a></li>
</ul></li>
<li><a href="#cache">Cache</a>
<ul>
<li><a href="#client-caching">Client caching</a></li>
<li><a href="#cdn-caching">CDN caching</a></li>
<li><a href="#web-server-caching">Web server caching</a></li>
<li><a href="#database-caching">Database caching</a></li>
<li><a href="#application-caching">Application caching</a></li>
<li><a href="#caching-at-the-database-query-level">Caching at the
database query level</a></li>
<li><a href="#caching-at-the-object-level">Caching at the object
level</a></li>
<li><a href="#when-to-update-the-cache">When to update the cache</a>
<ul>
<li><a href="#cache-aside">Cache-aside</a></li>
<li><a href="#write-through">Write-through</a></li>
<li><a href="#write-behind-write-back">Write-behind
(write-back)</a></li>
<li><a href="#refresh-ahead">Refresh-ahead</a></li>
</ul></li>
</ul></li>
<li><a href="#asynchronism">Asynchronism</a>
<ul>
<li><a href="#message-queues">Message queues</a></li>
<li><a href="#task-queues">Task queues</a></li>
<li><a href="#back-pressure">Back pressure</a></li>
</ul></li>
<li><a href="#communication">Communication</a>
<ul>
<li><a href="#transmission-control-protocol-tcp">Transmission control
protocol (TCP)</a></li>
<li><a href="#user-datagram-protocol-udp">User datagram protocol
(UDP)</a></li>
<li><a href="#remote-procedure-call-rpc">Remote procedure call
(RPC)</a></li>
<li><a href="#representational-state-transfer-rest">Representational
state transfer (REST)</a></li>
</ul></li>
<li><a href="#security">Security</a></li>
<li><a href="#appendix">Appendix</a>
<ul>
<li><a href="#powers-of-two-table">Powers of two table</a></li>
<li><a href="#latency-numbers-every-programmer-should-know">Latency
numbers every programmer should know</a></li>
<li><a href="#additional-system-design-interview-questions">Additional
system design interview questions</a></li>
<li><a href="#real-world-architectures">Real world
architectures</a></li>
<li><a href="#company-architectures">Company architectures</a></li>
<li><a href="#company-engineering-blogs">Company engineering
blogs</a></li>
</ul></li>
<li><a href="#under-development">Under development</a></li>
<li><a href="#credits">Credits</a></li>
<li><a href="#contact-info">Contact info</a></li>
<li><a href="#license">License</a></li>
</ul>
<h2 id="study-guide">Study guide</h2>
<blockquote>
<p>Suggested topics to review based on your interview timeline (short,
medium, long).</p>
</blockquote>
<figure>
<img
src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/OfVllex.png"
alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<p><strong>Q: For interviews, do I need to know everything
here?</strong></p>
<p><strong>A: No, you don’t need to know everything here to prepare for
the interview</strong>.</p>
<p>What you are asked in an interview depends on variables such as:</p>
<ul>
<li>How much experience you have</li>
<li>What your technical background is</li>
<li>What positions you are interviewing for</li>
<li>Which companies you are interviewing with</li>
<li>Luck</li>
</ul>
<p>More experienced candidates are generally expected to know more about
system design. Architects or team leads might be expected to know more
than individual contributors. Top tech companies are likely to have one
or more design interview rounds.</p>
<p>Start broad and go deeper in a few areas. It helps to know a little
about various key system design topics. Adjust the following guide based
on your timeline, experience, what positions you are interviewing for,
and which companies you are interviewing with.</p>
<ul>
<li><strong>Short timeline</strong> - Aim for <strong>breadth</strong>
with system design topics. Practice by solving <strong>some</strong>
interview questions.</li>
<li><strong>Medium timeline</strong> - Aim for <strong>breadth</strong>
and <strong>some depth</strong> with system design topics. Practice by
solving <strong>many</strong> interview questions.</li>
<li><strong>Long timeline</strong> - Aim for <strong>breadth</strong>
and <strong>more depth</strong> with system design topics. Practice by
solving <strong>most</strong> interview questions.</li>
</ul>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th></th>
<th>Short</th>
<th>Medium</th>
<th>Long</th>
</tr>
</thead>
<tbody>
<tr>
<td>Read through the <a href="#index-of-system-design-topics">System
design topics</a> to get a broad understanding of how systems work</td>
<td>:+1:</td>
<td>:+1:</td>
<td>:+1:</td>
</tr>
<tr>
<td>Read through a few articles in the <a
href="#company-engineering-blogs">Company engineering blogs</a> for the
companies you are interviewing with</td>
<td>:+1:</td>
<td>:+1:</td>
<td>:+1:</td>
</tr>
<tr>
<td>Read through a few <a href="#real-world-architectures">Real world
architectures</a></td>
<td>:+1:</td>
<td>:+1:</td>
<td>:+1:</td>
</tr>
<tr>
<td>Review <a
href="#how-to-approach-a-system-design-interview-question">How to
approach a system design interview question</a></td>
<td>:+1:</td>
<td>:+1:</td>
<td>:+1:</td>
</tr>
<tr>
<td>Work through <a
href="#system-design-interview-questions-with-solutions">System design
interview questions with solutions</a></td>
<td>Some</td>
<td>Many</td>
<td>Most</td>
</tr>
<tr>
<td>Work through <a
href="#object-oriented-design-interview-questions-with-solutions">Object-oriented
design interview questions with solutions</a></td>
<td>Some</td>
<td>Many</td>
<td>Most</td>
</tr>
<tr>
<td>Review <a
href="#additional-system-design-interview-questions">Additional system
design interview questions</a></td>
<td>Some</td>
<td>Many</td>
<td>Most</td>
</tr>
</tbody>
</table>
<h2 id="how-to-approach-a-system-design-interview-question">How to
approach a system design interview question</h2>
<blockquote>
<p>How to tackle a system design interview question.</p>
</blockquote>
<p>The system design interview is an <strong>open-ended
conversation</strong>. You are expected to lead it.</p>
<p>You can use the following steps to guide the discussion. To help
solidify this process, work through the <a
href="#system-design-interview-questions-with-solutions">System design
interview questions with solutions</a> section using the following
steps.</p>
<h3 id="step-1-outline-use-cases-constraints-and-assumptions">Step 1:
Outline use cases, constraints, and assumptions</h3>
<p>Gather requirements and scope the problem. Ask questions to clarify
use cases and constraints. Discuss assumptions.</p>
<ul>
<li>Who is going to use it?</li>
<li>How are they going to use it?</li>
<li>How many users are there?</li>
<li>What does the system do?</li>
<li>What are the inputs and outputs of the system?</li>
<li>How much data do we expect to handle?</li>
<li>How many requests per second do we expect?</li>
<li>What is the expected read to write ratio?</li>
</ul>
<h3 id="step-2-create-a-high-level-design">Step 2: Create a high level
design</h3>
<p>Outline a high level design with all important components.</p>
<ul>
<li>Sketch the main components and connections</li>
<li>Justify your ideas</li>
</ul>
<h3 id="step-3-design-core-components">Step 3: Design core
components</h3>
<p>Dive into details for each core component. For example, if you were
asked to <a href="#system-design-pastebin">design a url shortening
service</a>, discuss:</p>
<ul>
<li>Generating and storing a hash of the full url
<ul>
<li><a href="#system-design-pastebin">MD5</a> and <a
href="#system-design-pastebin">Base62</a></li>
<li>Hash collisions</li>
<li>SQL or NoSQL</li>
<li>Database schema</li>
</ul></li>
<li>Translating a hashed url to the full url
<ul>
<li>Database lookup</li>
</ul></li>
<li>API and object-oriented design</li>
</ul>
<h3 id="step-4-scale-the-design">Step 4: Scale the design</h3>
<p>Identify and address bottlenecks, given the constraints. For example,
do you need the following to address scalability issues?</p>
<ul>
<li>Load balancer</li>
<li>Horizontal scaling</li>
<li>Caching</li>
<li>Database sharding</li>
</ul>
<p>Discuss potential solutions and trade-offs. Everything is a
trade-off. Address bottlenecks using <a
href="#index-of-system-design-topics">principles of scalable system
design</a>.</p>
<h3 id="back-of-the-envelope-calculations">Back-of-the-envelope
calculations</h3>
<p>You might be asked to do some estimates by hand. Refer to the <a
href="#appendix">Appendix</a> for the following resources:</p>
<ul>
<li><a
href="http://highscalability.com/blog/2011/1/26/google-pro-tip-use-back-of-the-envelope-calculations-to-choo.html">Use
back of the envelope calculations</a></li>
<li><a href="#powers-of-two-table">Powers of two table</a></li>
<li><a href="#latency-numbers-every-programmer-should-know">Latency
numbers every programmer should know</a></li>
</ul>
<h3 id="sources-and-further-reading">Source(s) and further reading</h3>
<p>Check out the following links to get a better idea of what to
expect:</p>
<ul>
<li><a
href="https://www.palantir.com/2011/10/how-to-rock-a-systems-design-interview/">How
to ace a systems design interview</a></li>
<li><a href="http://www.hiredintech.com/system-design" target="_blank">The system design
interview</a></li>
<li><a href="https://www.youtube.com/watch?v=ZgdS0EUmn70" target="_blank">Intro to
Architecture and Systems Design Interviews</a></li>
<li><a
href="https://leetcode.com/discuss/career/229177/My-System-Design-Template">System
design template</a></li>
</ul>
<h2 id="system-design-interview-questions-with-solutions">System design
interview questions with solutions</h2>
<blockquote>
<p>Common system design interview questions with sample discussions,
code, and diagrams.</p>
<p>Solutions linked to content in the <code>solutions/</code>
folder.</p>
</blockquote>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>Question</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Design Pastebin.com (or Bit.ly)</td>
<td><a href="#system-design-pastebin">Solution</a></td>
</tr>
<tr>
<td>Design the Twitter timeline and search (or Facebook feed and
search)</td>
<td><a href="#system-design-twitter">Solution</a></td>
</tr>
<tr>
<td>Design a web crawler</td>
<td><a href="#system-design-web-crawler">Solution</a></td>
</tr>
<tr>
<td>Design Mint.com</td>
<td><a href="#system-design-mint">Solution</a></td>
</tr>
<tr>
<td>Design the data structures for a social network</td>
<td><a href="#system-design-social-graph">Solution</a></td>
</tr>
<tr>
<td>Design a key-value store for a search engine</td>
<td><a href="#system-design-query-cache">Solution</a></td>
</tr>
<tr>
<td>Design Amazon’s sales ranking by category feature</td>
<td><a href="#system-design-sales-rank">Solution</a></td>
</tr>
<tr>
<td>Design a system that scales to millions of users on AWS</td>
<td><a href="#system-design-scaling-aws">Solution</a></td>
</tr>
<tr>
<td>Add a system design question</td>
<td><a href="#contributing">Contribute</a></td>
</tr>
</tbody>
</table>
<h3 id="design-pastebin.com-or-bit.ly">Design Pastebin.com (or
Bit.ly)</h3>
<p><a href="#system-design-pastebin">View exercise and solution</a></p>
<figure>
<img
src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/4edXG0T.png"
alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h3
id="design-the-twitter-timeline-and-search-or-facebook-feed-and-search">Design
the Twitter timeline and search (or Facebook feed and search)</h3>
<p><a href="#system-design-twitter">View exercise and solution</a></p>
<figure>
<img
src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/jrUBAF7.png"
alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h3 id="design-a-web-crawler">Design a web crawler</h3>
<p><a href="#system-design-web-crawler">View exercise and
solution</a></p>
<figure>
<img
src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/bWxPtQA.png"
alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h3 id="design-mint.com">Design Mint.com</h3>
<p><a href="#system-design-mint">View exercise and solution</a></p>
<figure>
<img
src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/V5q57vU.png"
alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h3 id="design-the-data-structures-for-a-social-network">Design the data
structures for a social network</h3>
<p><a href="#system-design-social-graph">View exercise and
solution</a></p>
<figure>
<img
src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/cdCv5g7.png"
alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h3 id="design-a-key-value-store-for-a-search-engine">Design a key-value
store for a search engine</h3>
<p><a href="#system-design-query-cache">View exercise and
solution</a></p>
<figure>
<img
src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/4j99mhe.png"
alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h3 id="design-amazons-sales-ranking-by-category-feature">Design
Amazon’s sales ranking by category feature</h3>
<p><a href="#system-design-sales-rank">View exercise and
solution</a></p>
<figure>
<img
src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/MzExP06.png"
alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h3 id="design-a-system-that-scales-to-millions-of-users-on-aws">Design
a system that scales to millions of users on AWS</h3>
<p><a href="#system-design-scaling-aws">View exercise and
solution</a></p>
<figure>
<img
src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/jj3A5N8.png"
alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h2
id="object-oriented-design-interview-questions-with-solutions">Object-oriented
design interview questions with solutions</h2>
<blockquote>
<p>Common object-oriented design interview questions with sample
discussions, code, and diagrams.</p>
<p>Solutions linked to content in the <code>solutions/</code>
folder.</p>
</blockquote>
<blockquote>
<p><strong>Note: This section is under development</strong></p>
</blockquote>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>Question</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Design a hash map</td>
<td><a href="#object-oriented-design-hash-table">Solution</a></td>
</tr>
<tr>
<td>Design a least recently used cache</td>
<td><a href="#object-oriented-design-lru-cache">Solution</a></td>
</tr>
<tr>
<td>Design a call center</td>
<td><a href="#object-oriented-design-call-center">Solution</a></td>
</tr>
<tr>
<td>Design a deck of cards</td>
<td><a href="#object-oriented-design-deck-of-cards">Solution</a></td>
</tr>
<tr>
<td>Design a parking lot</td>
<td><a href="#object-oriented-design-parking-lot">Solution</a></td>
</tr>
<tr>
<td>Design a chat server</td>
<td><a href="#object-oriented-design-online-chat">Solution</a></td>
</tr>
<tr>
<td>Design a circular array</td>
<td><a href="#contributing">Contribute</a></td>
</tr>
<tr>
<td>Add an object-oriented design question</td>
<td><a href="#contributing">Contribute</a></td>
</tr>
</tbody>
</table>
<h2 id="system-design-topics-start-here">System design topics: start
here</h2>
<p>New to system design?</p>
<p>First, you’ll need a basic understanding of common principles,
learning about what they are, how they are used, and their pros and
cons.</p>
<h3 id="step-1-review-the-scalability-video-lecture">Step 1: Review the
scalability video lecture</h3>
<p><a href="https://www.youtube.com/watch?v=-W9F__D3oY4" target="_blank">Scalability
Lecture at Harvard</a></p>
<ul>
<li>Topics covered:
<ul>
<li>Vertical scaling</li>
<li>Horizontal scaling</li>
<li>Caching</li>
<li>Load balancing</li>
<li>Database replication</li>
<li>Database partitioning</li>
</ul></li>
</ul>
<h3 id="step-2-review-the-scalability-article">Step 2: Review the
scalability article</h3>
<p><a
href="https://web.archive.org/web/20221030091841/http://www.lecloud.net/tagged/scalability/chrono">Scalability</a></p>
<ul>
<li>Topics covered:
<ul>
<li><a
href="https://web.archive.org/web/20220530193911/https://www.lecloud.net/post/7295452622/scalability-for-dummies-part-1-clones">Clones</a></li>
<li><a
href="https://web.archive.org/web/20220602114024/https://www.lecloud.net/post/7994751381/scalability-for-dummies-part-2-database">Databases</a></li>
<li><a
href="https://web.archive.org/web/20230126233752/https://www.lecloud.net/post/9246290032/scalability-for-dummies-part-3-cache">Caches</a></li>
<li><a
href="https://web.archive.org/web/20220926171507/https://www.lecloud.net/post/9699762917/scalability-for-dummies-part-4-asynchronism">Asynchronism</a></li>
</ul></li>
</ul>
<h3 id="next-steps">Next steps</h3>
<p>Next, we’ll look at high-level trade-offs:</p>
<ul>
<li><strong>Performance</strong> vs <strong>scalability</strong></li>
<li><strong>Latency</strong> vs <strong>throughput</strong></li>
<li><strong>Availability</strong> vs <strong>consistency</strong></li>
</ul>
<p>Keep in mind that <strong>everything is a trade-off</strong>.</p>
<p>Then we’ll dive into more specific topics such as DNS, CDNs, and load
balancers.</p>
<h2 id="performance-vs-scalability">Performance vs scalability</h2>
<p>A service is <strong>scalable</strong> if it results in increased
<strong>performance</strong> in a manner proportional to resources
added. Generally, increasing performance means serving more units of
work, but it can also be to handle larger units of work, such as when
datasets
grow.<sup><a href=http://www.allthingsdistributed.com/2006/03/a_word_on_scalability.html>1</a></sup></p>
<p>Another way to look at performance vs scalability:</p>
<ul>
<li>If you have a <strong>performance</strong> problem, your system is
slow for a single user.</li>
<li>If you have a <strong>scalability</strong> problem, your system is
fast for a single user but slow under heavy load.</li>
</ul>
<h3 id="sources-and-further-reading-1">Source(s) and further
reading</h3>
<ul>
<li><a
href="http://www.allthingsdistributed.com/2006/03/a_word_on_scalability.html">A
word on scalability</a></li>
<li><a
href="http://www.slideshare.net/jboner/scalability-availability-stability-patterns/">Scalability,
availability, stability, patterns</a></li>
</ul>
<h2 id="latency-vs-throughput">Latency vs throughput</h2>
<p><strong>Latency</strong> is the time to perform some action or to
produce some result.</p>
<p><strong>Throughput</strong> is the number of such actions or results
per unit of time.</p>
<p>Generally, you should aim for <strong>maximal throughput</strong>
with <strong>acceptable latency</strong>.</p>
<h3 id="sources-and-further-reading-2">Source(s) and further
reading</h3>
<ul>
<li><a
href="https://community.cadence.com/cadence_blogs_8/b/fv/posts/understanding-latency-vs-throughput">Understanding
latency vs throughput</a></li>
</ul>
<h2 id="availability-vs-consistency">Availability vs consistency</h2>
<h3 id="cap-theorem">CAP theorem</h3>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/bgLMI2u.png"> <br/>
<i><a href=http://robertgreiner.com/2014/08/cap-theorem-revisited>Source:
CAP theorem revisited</a></i>
</p>
<p>In a distributed computer system, you can only support two of the
following guarantees:</p>
<ul>
<li><strong>Consistency</strong> - Every read receives the most recent
write or an error</li>
<li><strong>Availability</strong> - Every request receives a response,
without guarantee that it contains the most recent version of the
information</li>
<li><strong>Partition Tolerance</strong> - The system continues to
operate despite arbitrary partitioning due to network failures</li>
</ul>
<p><em>Networks aren’t reliable, so you’ll need to support partition
tolerance. You’ll need to make a software tradeoff between consistency
and availability.</em></p>
<h4 id="cp---consistency-and-partition-tolerance">CP - consistency and
partition tolerance</h4>
<p>Waiting for a response from the partitioned node might result in a
timeout error. CP is a good choice if your business needs require atomic
reads and writes.</p>
<h4 id="ap---availability-and-partition-tolerance">AP - availability and
partition tolerance</h4>
<p>Responses return the most readily available version of the data
available on any node, which might not be the latest. Writes might take
some time to propagate when the partition is resolved.</p>
<p>AP is a good choice if the business needs to allow for <a
href="#eventual-consistency">eventual consistency</a> or when the system
needs to continue working despite external errors.</p>
<h3 id="sources-and-further-reading-3">Source(s) and further
reading</h3>
<ul>
<li><a
href="http://robertgreiner.com/2014/08/cap-theorem-revisited/">CAP
theorem revisited</a></li>
<li><a
href="http://ksat.me/a-plain-english-introduction-to-cap-theorem">A
plain english introduction to CAP theorem</a></li>
<li><a href="https://github.com/henryr/cap-faq" target="_blank">CAP FAQ</a></li>
<li><a href="https://www.youtube.com/watch?v=k-Yaq8AHlFA" target="_blank">The CAP
theorem</a></li>
</ul>
<h2 id="consistency-patterns">Consistency patterns</h2>
<p>With multiple copies of the same data, we are faced with options on
how to synchronize them so clients have a consistent view of the data.
Recall the definition of consistency from the <a href="#cap-theorem">CAP
theorem</a> - Every read receives the most recent write or an error.</p>
<h3 id="weak-consistency">Weak consistency</h3>
<p>After a write, reads may or may not see it. A best effort approach is
taken.</p>
<p>This approach is seen in systems such as memcached. Weak consistency
works well in real time use cases such as VoIP, video chat, and realtime
multiplayer games. For example, if you are on a phone call and lose
reception for a few seconds, when you regain connection you do not hear
what was spoken during connection loss.</p>
<h3 id="eventual-consistency">Eventual consistency</h3>
<p>After a write, reads will eventually see it (typically within
milliseconds). Data is replicated asynchronously.</p>
<p>This approach is seen in systems such as DNS and email. Eventual
consistency works well in highly available systems.</p>
<h3 id="strong-consistency">Strong consistency</h3>
<p>After a write, reads will see it. Data is replicated
synchronously.</p>
<p>This approach is seen in file systems and RDBMSes. Strong consistency
works well in systems that need transactions.</p>
<h3 id="sources-and-further-reading-4">Source(s) and further
reading</h3>
<ul>
<li><a
href="http://snarfed.org/transactions_across_datacenters_io.html">Transactions
across data centers</a></li>
</ul>
<h2 id="availability-patterns">Availability patterns</h2>
<p>There are two complementary patterns to support high availability:
<strong>fail-over</strong> and <strong>replication</strong>.</p>
<h3 id="fail-over">Fail-over</h3>
<h4 id="active-passive">Active-passive</h4>
<p>With active-passive fail-over, heartbeats are sent between the active
and the passive server on standby. If the heartbeat is interrupted, the
passive server takes over the active’s IP address and resumes
service.</p>
<p>The length of downtime is determined by whether the passive server is
already running in ‘hot’ standby or whether it needs to start up from
‘cold’ standby. Only the active server handles traffic.</p>
<p>Active-passive failover can also be referred to as master-slave
failover.</p>
<h4 id="active-active">Active-active</h4>
<p>In active-active, both servers are managing traffic, spreading the
load between them.</p>
<p>If the servers are public-facing, the DNS would need to know about
the public IPs of both servers. If the servers are internal-facing,
application logic would need to know about both servers.</p>
<p>Active-active failover can also be referred to as master-master
failover.</p>
<h3 id="disadvantages-failover">Disadvantage(s): failover</h3>
<ul>
<li>Fail-over adds more hardware and additional complexity.</li>
<li>There is a potential for loss of data if the active system fails
before any newly written data can be replicated to the passive.</li>
</ul>
<h3 id="replication">Replication</h3>
<h4 id="master-slave-and-master-master">Master-slave and
master-master</h4>
<p>This topic is further discussed in the <a
href="#database">Database</a> section:</p>
<ul>
<li><a href="#master-slave-replication">Master-slave
replication</a></li>
<li><a href="#master-master-replication">Master-master
replication</a></li>
</ul>
<h3 id="availability-in-numbers">Availability in numbers</h3>
<p>Availability is often quantified by uptime (or downtime) as a
percentage of time the service is available. Availability is generally
measured in number of 9s–a service with 99.99% availability is described
as having four 9s.</p>
<h4 id="availability---three-9s">99.9% availability - three 9s</h4>
<table>
<thead>
<tr>
<th>Duration</th>
<th>Acceptable downtime</th>
</tr>
</thead>
<tbody>
<tr>
<td>Downtime per year</td>
<td>8h 45min 57s</td>
</tr>
<tr>
<td>Downtime per month</td>
<td>43m 49.7s</td>
</tr>
<tr>
<td>Downtime per week</td>
<td>10m 4.8s</td>
</tr>
<tr>
<td>Downtime per day</td>
<td>1m 26.4s</td>
</tr>
</tbody>
</table>
<h4 id="availability---four-9s">99.99% availability - four 9s</h4>
<table>
<thead>
<tr>
<th>Duration</th>
<th>Acceptable downtime</th>
</tr>
</thead>
<tbody>
<tr>
<td>Downtime per year</td>
<td>52min 35.7s</td>
</tr>
<tr>
<td>Downtime per month</td>
<td>4m 23s</td>
</tr>
<tr>
<td>Downtime per week</td>
<td>1m 5s</td>
</tr>
<tr>
<td>Downtime per day</td>
<td>8.6s</td>
</tr>
</tbody>
</table>
<h4 id="availability-in-parallel-vs-in-sequence">Availability in
parallel vs in sequence</h4>
<p>If a service consists of multiple components prone to failure, the
service’s overall availability depends on whether the components are in
sequence or in parallel.</p>
<h6 id="in-sequence">In sequence</h6>
<p>Overall availability decreases when two components with availability
&lt; 100% are in sequence:</p>
<pre><code>Availability (Total) = Availability (Foo) * Availability (Bar)</code></pre>
<p>If both <code>Foo</code> and <code>Bar</code> each had 99.9%
availability, their total availability in sequence would be 99.8%.</p>
<h6 id="in-parallel">In parallel</h6>
<p>Overall availability increases when two components with availability
&lt; 100% are in parallel:</p>
<pre><code>Availability (Total) = 1 - (1 - Availability (Foo)) * (1 - Availability (Bar))</code></pre>
<p>If both <code>Foo</code> and <code>Bar</code> each had 99.9%
availability, their total availability in parallel would be
99.9999%.</p>
<h2 id="domain-name-system">Domain name system</h2>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/IOyLj4i.jpg"> <br/>
<i><a href=http://www.slideshare.net/srikrupa5/dns-security-presentation-issa>Source:
DNS security presentation</a></i>
</p>
<p>A Domain Name System (DNS) translates a domain name such as
www.example.com to an IP address.</p>
<p>DNS is hierarchical, with a few authoritative servers at the top
level. Your router or ISP provides information about which DNS server(s)
to contact when doing a lookup. Lower level DNS servers cache mappings,
which could become stale due to DNS propagation delays. DNS results can
also be cached by your browser or OS for a certain period of time,
determined by the <a
href="https://en.wikipedia.org/wiki/Time_to_live">time to live
(TTL)</a>.</p>
<ul>
<li><strong>NS record (name server)</strong> - Specifies the DNS servers
for your domain/subdomain.</li>
<li><strong>MX record (mail exchange)</strong> - Specifies the mail
servers for accepting messages.</li>
<li><strong>A record (address)</strong> - Points a name to an IP
address.</li>
<li><strong>CNAME (canonical)</strong> - Points a name to another name
or <code>CNAME</code> (example.com to www.example.com) or to an
<code>A</code> record.</li>
</ul>
<p>Services such as <a
href="https://www.cloudflare.com/dns/">CloudFlare</a> and <a
href="https://aws.amazon.com/route53/">Route 53</a> provide managed DNS
services. Some DNS services can route traffic through various
methods:</p>
<ul>
<li><a
href="https://www.jscape.com/blog/load-balancing-algorithms">Weighted
round robin</a>
<ul>
<li>Prevent traffic from going to servers under maintenance</li>
<li>Balance between varying cluster sizes</li>
<li>A/B testing</li>
</ul></li>
<li><a
href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-policy-latency.html">Latency-based</a></li>
<li><a
href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-policy-geo.html">Geolocation-based</a></li>
</ul>
<h3 id="disadvantages-dns">Disadvantage(s): DNS</h3>
<ul>
<li>Accessing a DNS server introduces a slight delay, although mitigated
by caching described above.</li>
<li>DNS server management could be complex and is generally managed by
<a
href="http://superuser.com/questions/472695/who-controls-the-dns-servers/472729">governments,
ISPs, and large companies</a>.</li>
<li>DNS services have recently come under <a
href="http://dyn.com/blog/dyn-analysis-summary-of-friday-october-21-attack/">DDoS
attack</a>, preventing users from accessing websites such as Twitter
without knowing Twitter’s IP address(es).</li>
</ul>
<h3 id="sources-and-further-reading-5">Source(s) and further
reading</h3>
<ul>
<li><a
href="https://technet.microsoft.com/en-us/library/dd197427(v=ws.10).aspx">DNS
architecture</a></li>
<li><a
href="https://en.wikipedia.org/wiki/Domain_Name_System">Wikipedia</a></li>
<li><a href="https://support.dnsimple.com/categories/dns/" target="_blank">DNS
articles</a></li>
</ul>
<h2 id="content-delivery-network">Content delivery network</h2>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/h9TAuGI.jpg"> <br/>
<i><a href=https://www.creative-artworks.eu/why-use-a-content-delivery-network-cdn/>Source:
Why use a CDN</a></i>
</p>
<p>A content delivery network (CDN) is a globally distributed network of
proxy servers, serving content from locations closer to the user.
Generally, static files such as HTML/CSS/JS, photos, and videos are
served from CDN, although some CDNs such as Amazon’s CloudFront support
dynamic content. The site’s DNS resolution will tell clients which
server to contact.</p>
<p>Serving content from CDNs can significantly improve performance in
two ways:</p>
<ul>
<li>Users receive content from data centers close to them</li>
<li>Your servers do not have to serve requests that the CDN
fulfills</li>
</ul>
<h3 id="push-cdns">Push CDNs</h3>
<p>Push CDNs receive new content whenever changes occur on your server.
You take full responsibility for providing content, uploading directly
to the CDN and rewriting URLs to point to the CDN. You can configure
when content expires and when it is updated. Content is uploaded only
when it is new or changed, minimizing traffic, but maximizing
storage.</p>
<p>Sites with a small amount of traffic or sites with content that isn’t
often updated work well with push CDNs. Content is placed on the CDNs
once, instead of being re-pulled at regular intervals.</p>
<h3 id="pull-cdns">Pull CDNs</h3>
<p>Pull CDNs grab new content from your server when the first user
requests the content. You leave the content on your server and rewrite
URLs to point to the CDN. This results in a slower request until the
content is cached on the CDN.</p>
<p>A <a href="https://en.wikipedia.org/wiki/Time_to_live" target="_blank">time-to-live
(TTL)</a> determines how long content is cached. Pull CDNs minimize
storage space on the CDN, but can create redundant traffic if files
expire and are pulled before they have actually changed.</p>
<p>Sites with heavy traffic work well with pull CDNs, as traffic is
spread out more evenly with only recently-requested content remaining on
the CDN.</p>
<h3 id="disadvantages-cdn">Disadvantage(s): CDN</h3>
<ul>
<li>CDN costs could be significant depending on traffic, although this
should be weighed with additional costs you would incur not using a
CDN.</li>
<li>Content might be stale if it is updated before the TTL expires
it.</li>
<li>CDNs require changing URLs for static content to point to the
CDN.</li>
</ul>
<h3 id="sources-and-further-reading-6">Source(s) and further
reading</h3>
<ul>
<li><a
href="https://figshare.com/articles/Globally_distributed_content_delivery/6605972">Globally
distributed content delivery</a></li>
<li><a
href="http://www.travelblogadvice.com/technical/the-differences-between-push-and-pull-cdns/">The
differences between push and pull CDNs</a></li>
<li><a
href="https://en.wikipedia.org/wiki/Content_delivery_network">Wikipedia</a></li>
</ul>
<h2 id="load-balancer">Load balancer</h2>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/h81n9iK.png"> <br/>
<i><a href=http://horicky.blogspot.com/2010/10/scalable-system-design-patterns.html>Source:
Scalable system design patterns</a></i>
</p>
<p>Load balancers distribute incoming client requests to computing
resources such as application servers and databases. In each case, the
load balancer returns the response from the computing resource to the
appropriate client. Load balancers are effective at:</p>
<ul>
<li>Preventing requests from going to unhealthy servers</li>
<li>Preventing overloading resources</li>
<li>Helping to eliminate a single point of failure</li>
</ul>
<p>Load balancers can be implemented with hardware (expensive) or with
software such as HAProxy.</p>
<p>Additional benefits include:</p>
<ul>
<li><strong>SSL termination</strong> - Decrypt incoming requests and
encrypt server responses so backend servers do not have to perform these
potentially expensive operations
<ul>
<li>Removes the need to install <a
href="https://en.wikipedia.org/wiki/X.509">X.509 certificates</a> on
each server</li>
</ul></li>
<li><strong>Session persistence</strong> - Issue cookies and route a
specific client’s requests to same instance if the web apps do not keep
track of sessions</li>
</ul>
<p>To protect against failures, it’s common to set up multiple load
balancers, either in <a href="#active-passive">active-passive</a> or <a
href="#active-active">active-active</a> mode.</p>
<p>Load balancers can route traffic based on various metrics,
including:</p>
<ul>
<li>Random</li>
<li>Least loaded</li>
<li>Session/cookies</li>
<li><a
href="https://www.g33kinfo.com/info/round-robin-vs-weighted-round-robin-lb">Round
robin or weighted round robin</a></li>
<li><a href="#layer-4-load-balancing">Layer 4</a></li>
<li><a href="#layer-7-load-balancing">Layer 7</a></li>
</ul>
<h3 id="layer-4-load-balancing">Layer 4 load balancing</h3>
<p>Layer 4 load balancers look at info at the <a
href="#communication">transport layer</a> to decide how to distribute
requests. Generally, this involves the source, destination IP addresses,
and ports in the header, but not the contents of the packet. Layer 4
load balancers forward network packets to and from the upstream server,
performing <a
href="https://www.nginx.com/resources/glossary/layer-4-load-balancing/">Network
Address Translation (NAT)</a>.</p>
<h3 id="layer-7-load-balancing">Layer 7 load balancing</h3>
<p>Layer 7 load balancers look at the <a
href="#communication">application layer</a> to decide how to distribute
requests. This can involve contents of the header, message, and cookies.
Layer 7 load balancers terminate network traffic, reads the message,
makes a load-balancing decision, then opens a connection to the selected
server. For example, a layer 7 load balancer can direct video traffic to
servers that host videos while directing more sensitive user billing
traffic to security-hardened servers.</p>
<p>At the cost of flexibility, layer 4 load balancing requires less time
and computing resources than Layer 7, although the performance impact
can be minimal on modern commodity hardware.</p>
<h3 id="horizontal-scaling">Horizontal scaling</h3>
<p>Load balancers can also help with horizontal scaling, improving
performance and availability. Scaling out using commodity machines is
more cost efficient and results in higher availability than scaling up a
single server on more expensive hardware, called <strong>Vertical
Scaling</strong>. It is also easier to hire for talent working on
commodity hardware than it is for specialized enterprise systems.</p>
<h4 id="disadvantages-horizontal-scaling">Disadvantage(s): horizontal
scaling</h4>
<ul>
<li>Scaling horizontally introduces complexity and involves cloning
servers
<ul>
<li>Servers should be stateless: they should not contain any
user-related data like sessions or profile pictures</li>
<li>Sessions can be stored in a centralized data store such as a <a
href="#database">database</a> (SQL, NoSQL) or a persistent <a
href="#cache">cache</a> (Redis, Memcached)</li>
</ul></li>
<li>Downstream servers such as caches and databases need to handle more
simultaneous connections as upstream servers scale out</li>
</ul>
<h3 id="disadvantages-load-balancer">Disadvantage(s): load balancer</h3>
<ul>
<li>The load balancer can become a performance bottleneck if it does not
have enough resources or if it is not configured properly.</li>
<li>Introducing a load balancer to help eliminate a single point of
failure results in increased complexity.</li>
<li>A single load balancer is a single point of failure, configuring
multiple load balancers further increases complexity.</li>
</ul>
<h3 id="sources-and-further-reading-7">Source(s) and further
reading</h3>
<ul>
<li><a
href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/">NGINX
architecture</a></li>
<li><a
href="http://www.haproxy.org/download/1.2/doc/architecture.txt">HAProxy
architecture guide</a></li>
<li><a
href="https://web.archive.org/web/20220530193911/https://www.lecloud.net/post/7295452622/scalability-for-dummies-part-1-clones">Scalability</a></li>
<li><a
href="https://en.wikipedia.org/wiki/Load_balancing_(computing)">Wikipedia</a></li>
<li><a
href="https://www.nginx.com/resources/glossary/layer-4-load-balancing/">Layer
4 load balancing</a></li>
<li><a
href="https://www.nginx.com/resources/glossary/layer-7-load-balancing/">Layer
7 load balancing</a></li>
<li><a
href="http://docs.aws.amazon.com/elasticloadbalancing/latest/classic/elb-listener-config.html">ELB
listener config</a></li>
</ul>
<h2 id="reverse-proxy-web-server">Reverse proxy (web server)</h2>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/n41Azff.png"> <br/>
<i><a href=https://upload.wikimedia.org/wikipedia/commons/6/67/Reverse_proxy_h2g2bob.svg>Source:
Wikipedia</a></i> <br/>
</p>
<p>A reverse proxy is a web server that centralizes internal services
and provides unified interfaces to the public. Requests from clients are
forwarded to a server that can fulfill it before the reverse proxy
returns the server’s response to the client.</p>
<p>Additional benefits include:</p>
<ul>
<li><strong>Increased security</strong> - Hide information about backend
servers, blacklist IPs, limit number of connections per client</li>
<li><strong>Increased scalability and flexibility</strong> - Clients
only see the reverse proxy’s IP, allowing you to scale servers or change
their configuration</li>
<li><strong>SSL termination</strong> - Decrypt incoming requests and
encrypt server responses so backend servers do not have to perform these
potentially expensive operations
<ul>
<li>Removes the need to install <a
href="https://en.wikipedia.org/wiki/X.509">X.509 certificates</a> on
each server</li>
</ul></li>
<li><strong>Compression</strong> - Compress server responses</li>
<li><strong>Caching</strong> - Return the response for cached
requests</li>
<li><strong>Static content</strong> - Serve static content directly
<ul>
<li>HTML/CSS/JS</li>
<li>Photos</li>
<li>Videos</li>
<li>Etc</li>
</ul></li>
</ul>
<h3 id="load-balancer-vs-reverse-proxy">Load balancer vs reverse
proxy</h3>
<ul>
<li>Deploying a load balancer is useful when you have multiple servers.
Often, load balancers route traffic to a set of servers serving the same
function.</li>
<li>Reverse proxies can be useful even with just one web server or
application server, opening up the benefits described in the previous
section.</li>
<li>Solutions such as NGINX and HAProxy can support both layer 7 reverse
proxying and load balancing.</li>
</ul>
<h3 id="disadvantages-reverse-proxy">Disadvantage(s): reverse proxy</h3>
<ul>
<li>Introducing a reverse proxy results in increased complexity.</li>
<li>A single reverse proxy is a single point of failure, configuring
multiple reverse proxies (ie a <a
href="https://en.wikipedia.org/wiki/Failover">failover</a>) further
increases complexity.</li>
</ul>
<h3 id="sources-and-further-reading-8">Source(s) and further
reading</h3>
<ul>
<li><a
href="https://www.nginx.com/resources/glossary/reverse-proxy-vs-load-balancer/">Reverse
proxy vs load balancer</a></li>
<li><a
href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/">NGINX
architecture</a></li>
<li><a
href="http://www.haproxy.org/download/1.2/doc/architecture.txt">HAProxy
architecture guide</a></li>
<li><a
href="https://en.wikipedia.org/wiki/Reverse_proxy">Wikipedia</a></li>
</ul>
<h2 id="application-layer">Application layer</h2>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/yB5SYwm.png"> <br/>
<i><a href=http://lethain.com/introduction-to-architecting-systems-for-scale/#platform_layer>Source:
Intro to architecting systems for scale</a></i>
</p>
<p>Separating out the web layer from the application layer (also known
as platform layer) allows you to scale and configure both layers
independently. Adding a new API results in adding application servers
without necessarily adding additional web servers. The <strong>single
responsibility principle</strong> advocates for small and autonomous
services that work together. Small teams with small services can plan
more aggressively for rapid growth.</p>
<p>Workers in the application layer also help enable <a
href="#asynchronism">asynchronism</a>.</p>
<h3 id="microservices">Microservices</h3>
<p>Related to this discussion are <a
href="https://en.wikipedia.org/wiki/Microservices">microservices</a>,
which can be described as a suite of independently deployable, small,
modular services. Each service runs a unique process and communicates
through a well-defined, lightweight mechanism to serve a business goal.
<sup><a href=https://smartbear.com/learn/api-design/what-are-microservices>1</a></sup></p>
<p>Pinterest, for example, could have the following microservices: user
profile, follower, feed, search, photo upload, etc.</p>
<h3 id="service-discovery">Service Discovery</h3>
<p>Systems such as <a
href="https://www.consul.io/docs/index.html">Consul</a>, <a
href="https://coreos.com/etcd/docs/latest">Etcd</a>, and <a
href="http://www.slideshare.net/sauravhaloi/introduction-to-apache-zookeeper">Zookeeper</a>
can help services find each other by keeping track of registered names,
addresses, and ports. <a
href="https://www.consul.io/intro/getting-started/checks.html">Health
checks</a> help verify service integrity and are often done using an <a
href="#hypertext-transfer-protocol-http">HTTP</a> endpoint. Both Consul
and Etcd have a built in <a href="#key-value-store">key-value store</a>
that can be useful for storing config values and other shared data.</p>
<h3 id="disadvantages-application-layer">Disadvantage(s): application
layer</h3>
<ul>
<li>Adding an application layer with loosely coupled services requires a
different approach from an architectural, operations, and process
viewpoint (vs a monolithic system).</li>
<li>Microservices can add complexity in terms of deployments and
operations.</li>
</ul>
<h3 id="sources-and-further-reading-9">Source(s) and further
reading</h3>
<ul>
<li><a
href="http://lethain.com/introduction-to-architecting-systems-for-scale">Intro
to architecting systems for scale</a></li>
<li><a
href="http://www.puncsky.com/blog/2016-02-13-crack-the-system-design-interview">Crack
the system design interview</a></li>
<li><a
href="https://en.wikipedia.org/wiki/Service-oriented_architecture">Service
oriented architecture</a></li>
<li><a
href="http://www.slideshare.net/sauravhaloi/introduction-to-apache-zookeeper">Introduction
to Zookeeper</a></li>
<li><a
href="https://cloudncode.wordpress.com/2016/07/22/msa-getting-started/">Here’s
what you need to know about building microservices</a></li>
</ul>
<h2 id="database">Database</h2>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/Xkm5CXz.png"> <br/>
<i><a href=https://www.youtube.com/watch?v=kKjm4ehYiMs>Source: Scaling
up to your first 10 million users</a></i>
</p>
<h3 id="relational-database-management-system-rdbms">Relational database
management system (RDBMS)</h3>
<p>A relational database like SQL is a collection of data items
organized in tables.</p>
<p><strong>ACID</strong> is a set of properties of relational database
<a
href="https://en.wikipedia.org/wiki/Database_transaction">transactions</a>.</p>
<ul>
<li><strong>Atomicity</strong> - Each transaction is all or nothing</li>
<li><strong>Consistency</strong> - Any transaction will bring the
database from one valid state to another</li>
<li><strong>Isolation</strong> - Executing transactions concurrently has
the same results as if the transactions were executed serially</li>
<li><strong>Durability</strong> - Once a transaction has been committed,
it will remain so</li>
</ul>
<p>There are many techniques to scale a relational database:
<strong>master-slave replication</strong>, <strong>master-master
replication</strong>, <strong>federation</strong>,
<strong>sharding</strong>, <strong>denormalization</strong>, and
<strong>SQL tuning</strong>.</p>
<h4 id="master-slave-replication">Master-slave replication</h4>
<p>The master serves reads and writes, replicating writes to one or more
slaves, which serve only reads. Slaves can also replicate to additional
slaves in a tree-like fashion. If the master goes offline, the system
can continue to operate in read-only mode until a slave is promoted to a
master or a new master is provisioned.</p>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/C9ioGtn.png"> <br/>
<i><a href=http://www.slideshare.net/jboner/scalability-availability-stability-patterns/>Source:
Scalability, availability, stability, patterns</a></i>
</p>
<h5 id="disadvantages-master-slave-replication">Disadvantage(s):
master-slave replication</h5>
<ul>
<li>Additional logic is needed to promote a slave to a master.</li>
<li>See <a href="#disadvantages-replication">Disadvantage(s):
replication</a> for points related to <strong>both</strong> master-slave
and master-master.</li>
</ul>
<h4 id="master-master-replication">Master-master replication</h4>
<p>Both masters serve reads and writes and coordinate with each other on
writes. If either master goes down, the system can continue to operate
with both reads and writes.</p>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/krAHLGg.png"> <br/>
<i><a href=http://www.slideshare.net/jboner/scalability-availability-stability-patterns/>Source:
Scalability, availability, stability, patterns</a></i>
</p>
<h5 id="disadvantages-master-master-replication">Disadvantage(s):
master-master replication</h5>
<ul>
<li>You’ll need a load balancer or you’ll need to make changes to your
application logic to determine where to write.</li>
<li>Most master-master systems are either loosely consistent (violating
ACID) or have increased write latency due to synchronization.</li>
<li>Conflict resolution comes more into play as more write nodes are
added and as latency increases.</li>
<li>See <a href="#disadvantages-replication">Disadvantage(s):
replication</a> for points related to <strong>both</strong> master-slave
and master-master.</li>
</ul>
<h5 id="disadvantages-replication">Disadvantage(s): replication</h5>
<ul>
<li>There is a potential for loss of data if the master fails before any
newly written data can be replicated to other nodes.</li>
<li>Writes are replayed to the read replicas. If there are a lot of
writes, the read replicas can get bogged down with replaying writes and
can’t do as many reads.</li>
<li>The more read slaves, the more you have to replicate, which leads to
greater replication lag.</li>
<li>On some systems, writing to the master can spawn multiple threads to
write in parallel, whereas read replicas only support writing
sequentially with a single thread.</li>
<li>Replication adds more hardware and additional complexity.</li>
</ul>
<h5 id="sources-and-further-reading-replication">Source(s) and further
reading: replication</h5>
<ul>
<li><a
href="http://www.slideshare.net/jboner/scalability-availability-stability-patterns/">Scalability,
availability, stability, patterns</a></li>
<li><a
href="https://en.wikipedia.org/wiki/Multi-master_replication">Multi-master
replication</a></li>
</ul>
<h4 id="federation">Federation</h4>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/U3qV33e.png"> <br/>
<i><a href=https://www.youtube.com/watch?v=kKjm4ehYiMs>Source: Scaling
up to your first 10 million users</a></i>
</p>
<p>Federation (or functional partitioning) splits up databases by
function. For example, instead of a single, monolithic database, you
could have three databases: <strong>forums</strong>,
<strong>users</strong>, and <strong>products</strong>, resulting in less
read and write traffic to each database and therefore less replication
lag. Smaller databases result in more data that can fit in memory, which
in turn results in more cache hits due to improved cache locality. With
no single central master serializing writes you can write in parallel,
increasing throughput.</p>
<h5 id="disadvantages-federation">Disadvantage(s): federation</h5>
<ul>
<li>Federation is not effective if your schema requires huge functions
or tables.</li>
<li>You’ll need to update your application logic to determine which
database to read and write.</li>
<li>Joining data from two databases is more complex with a <a
href="http://stackoverflow.com/questions/5145637/querying-data-by-joining-two-tables-in-two-database-on-different-servers">server
link</a>.</li>
<li>Federation adds more hardware and additional complexity.</li>
</ul>
<h5 id="sources-and-further-reading-federation">Source(s) and further
reading: federation</h5>
<ul>
<li><a href="https://www.youtube.com/watch?v=kKjm4ehYiMs" target="_blank">Scaling up to
your first 10 million users</a></li>
</ul>
<h4 id="sharding">Sharding</h4>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/wU8x5Id.png"> <br/>
<i><a href=http://www.slideshare.net/jboner/scalability-availability-stability-patterns/>Source:
Scalability, availability, stability, patterns</a></i>
</p>
<p>Sharding distributes data across different databases such that each
database can only manage a subset of the data. Taking a users database
as an example, as the number of users increases, more shards are added
to the cluster.</p>
<p>Similar to the advantages of <a href="#federation">federation</a>,
sharding results in less read and write traffic, less replication, and
more cache hits. Index size is also reduced, which generally improves
performance with faster queries. If one shard goes down, the other
shards are still operational, although you’ll want to add some form of
replication to avoid data loss. Like federation, there is no single
central master serializing writes, allowing you to write in parallel
with increased throughput.</p>
<p>Common ways to shard a table of users is either through the user’s
last name initial or the user’s geographic location.</p>
<h5 id="disadvantages-sharding">Disadvantage(s): sharding</h5>
<ul>
<li>You’ll need to update your application logic to work with shards,
which could result in complex SQL queries.</li>
<li>Data distribution can become lopsided in a shard. For example, a set
of power users on a shard could result in increased load to that shard
compared to others.
<ul>
<li>Rebalancing adds additional complexity. A sharding function based on
<a
href="http://www.paperplanes.de/2011/12/9/the-magic-of-consistent-hashing.html">consistent
hashing</a> can reduce the amount of transferred data.</li>
</ul></li>
<li>Joining data from multiple shards is more complex.</li>
<li>Sharding adds more hardware and additional complexity.</li>
</ul>
<h5 id="sources-and-further-reading-sharding">Source(s) and further
reading: sharding</h5>
<ul>
<li><a
href="http://highscalability.com/blog/2009/8/6/an-unorthodox-approach-to-database-design-the-coming-of-the.html">The
coming of the shard</a></li>
<li><a
href="https://en.wikipedia.org/wiki/Shard_(database_architecture)">Shard
database architecture</a></li>
<li><a
href="http://www.paperplanes.de/2011/12/9/the-magic-of-consistent-hashing.html">Consistent
hashing</a></li>
</ul>
<h4 id="denormalization">Denormalization</h4>
<p>Denormalization attempts to improve read performance at the expense
of some write performance. Redundant copies of the data are written in
multiple tables to avoid expensive joins. Some RDBMS such as <a
href="https://en.wikipedia.org/wiki/PostgreSQL">PostgreSQL</a> and
Oracle support <a
href="https://en.wikipedia.org/wiki/Materialized_view">materialized
views</a> which handle the work of storing redundant information and
keeping redundant copies consistent.</p>
<p>Once data becomes distributed with techniques such as <a
href="#federation">federation</a> and <a href="#sharding">sharding</a>,
managing joins across data centers further increases complexity.
Denormalization might circumvent the need for such complex joins.</p>
<p>In most systems, reads can heavily outnumber writes 100:1 or even
1000:1. A read resulting in a complex database join can be very
expensive, spending a significant amount of time on disk operations.</p>
<h5 id="disadvantages-denormalization">Disadvantage(s):
denormalization</h5>
<ul>
<li>Data is duplicated.</li>
<li>Constraints can help redundant copies of information stay in sync,
which increases complexity of the database design.</li>
<li>A denormalized database under heavy write load might perform worse
than its normalized counterpart.</li>
</ul>
<h6 id="sources-and-further-reading-denormalization">Source(s) and
further reading: denormalization</h6>
<ul>
<li><a
href="https://en.wikipedia.org/wiki/Denormalization">Denormalization</a></li>
</ul>
<h4 id="sql-tuning">SQL tuning</h4>
<p>SQL tuning is a broad topic and many <a
href="https://www.amazon.com/s/ref=nb_sb_noss_2?url=search-alias%3Daps&amp;field-keywords=sql+tuning">books</a>
have been written as reference.</p>
<p>It’s important to <strong>benchmark</strong> and
<strong>profile</strong> to simulate and uncover bottlenecks.</p>
<ul>
<li><strong>Benchmark</strong> - Simulate high-load situations with
tools such as <a
href="http://httpd.apache.org/docs/2.2/programs/ab.html">ab</a>.</li>
<li><strong>Profile</strong> - Enable tools such as the <a
href="http://dev.mysql.com/doc/refman/5.7/en/slow-query-log.html">slow
query log</a> to help track performance issues.</li>
</ul>
<p>Benchmarking and profiling might point you to the following
optimizations.</p>
<h5 id="tighten-up-the-schema">Tighten up the schema</h5>
<ul>
<li>MySQL dumps to disk in contiguous blocks for fast access.</li>
<li>Use <code>CHAR</code> instead of <code>VARCHAR</code> for
fixed-length fields.
<ul>
<li><code>CHAR</code> effectively allows for fast, random access,
whereas with <code>VARCHAR</code>, you must find the end of a string
before moving onto the next one.</li>
</ul></li>
<li>Use <code>TEXT</code> for large blocks of text such as blog posts.
<code>TEXT</code> also allows for boolean searches. Using a
<code>TEXT</code> field results in storing a pointer on disk that is
used to locate the text block.</li>
<li>Use <code>INT</code> for larger numbers up to 2^32 or 4
billion.</li>
<li>Use <code>DECIMAL</code> for currency to avoid floating point
representation errors.</li>
<li>Avoid storing large <code>BLOBS</code>, store the location of where
to get the object instead.</li>
<li><code>VARCHAR(255)</code> is the largest number of characters that
can be counted in an 8 bit number, often maximizing the use of a byte in
some RDBMS.</li>
<li>Set the <code>NOT NULL</code> constraint where applicable to <a
href="http://stackoverflow.com/questions/1017239/how-do-null-values-affect-performance-in-a-database-search">improve
search performance</a>.</li>
</ul>
<h5 id="use-good-indices">Use good indices</h5>
<ul>
<li>Columns that you are querying (<code>SELECT</code>,
<code>GROUP BY</code>, <code>ORDER BY</code>, <code>JOIN</code>) could
be faster with indices.</li>
<li>Indices are usually represented as self-balancing <a
href="https://en.wikipedia.org/wiki/B-tree">B-tree</a> that keeps data
sorted and allows searches, sequential access, insertions, and deletions
in logarithmic time.</li>
<li>Placing an index can keep the data in memory, requiring more
space.</li>
<li>Writes could also be slower since the index also needs to be
updated.</li>
<li>When loading large amounts of data, it might be faster to disable
indices, load the data, then rebuild the indices.</li>
</ul>
<h5 id="avoid-expensive-joins">Avoid expensive joins</h5>
<ul>
<li><a href="#denormalization">Denormalize</a> where performance demands
it.</li>
</ul>
<h5 id="partition-tables">Partition tables</h5>
<ul>
<li>Break up a table by putting hot spots in a separate table to help
keep it in memory.</li>
</ul>
<h5 id="tune-the-query-cache">Tune the query cache</h5>
<ul>
<li>In some cases, the <a
href="https://dev.mysql.com/doc/refman/5.7/en/query-cache.html">query
cache</a> could lead to <a
href="https://www.percona.com/blog/2016/10/12/mysql-5-7-performance-tuning-immediately-after-installation/">performance
issues</a>.</li>
</ul>
<h5 id="sources-and-further-reading-sql-tuning">Source(s) and further
reading: SQL tuning</h5>
<ul>
<li><a
href="http://aiddroid.com/10-tips-optimizing-mysql-queries-dont-suck/">Tips
for optimizing MySQL queries</a></li>
<li><a
href="http://stackoverflow.com/questions/1217466/is-there-a-good-reason-i-see-varchar255-used-so-often-as-opposed-to-another-l">Is
there a good reason i see VARCHAR(255) used so often?</a></li>
<li><a
href="http://stackoverflow.com/questions/1017239/how-do-null-values-affect-performance-in-a-database-search">How
do null values affect performance?</a></li>
<li><a
href="http://dev.mysql.com/doc/refman/5.7/en/slow-query-log.html">Slow
query log</a></li>
</ul>
<h3 id="nosql">NoSQL</h3>
<p>NoSQL is a collection of data items represented in a
<strong>key-value store</strong>, <strong>document store</strong>,
<strong>wide column store</strong>, or a <strong>graph
database</strong>. Data is denormalized, and joins are generally done in
the application code. Most NoSQL stores lack true ACID transactions and
favor <a href="#eventual-consistency">eventual consistency</a>.</p>
<p><strong>BASE</strong> is often used to describe the properties of
NoSQL databases. In comparison with the <a href="#cap-theorem">CAP
Theorem</a>, BASE chooses availability over consistency.</p>
<ul>
<li><strong>Basically available</strong> - the system guarantees
availability.</li>
<li><strong>Soft state</strong> - the state of the system may change
over time, even without input.</li>
<li><strong>Eventual consistency</strong> - the system will become
consistent over a period of time, given that the system doesn’t receive
input during that period.</li>
</ul>
<p>In addition to choosing between <a href="#sql-or-nosql">SQL or
NoSQL</a>, it is helpful to understand which type of NoSQL database best
fits your use case(s). We’ll review <strong>key-value stores</strong>,
<strong>document stores</strong>, <strong>wide column stores</strong>,
and <strong>graph databases</strong> in the next section.</p>
<h4 id="key-value-store">Key-value store</h4>
<blockquote>
<p>Abstraction: hash table</p>
</blockquote>
<p>A key-value store generally allows for O(1) reads and writes and is
often backed by memory or SSD. Data stores can maintain keys in <a
href="https://en.wikipedia.org/wiki/Lexicographical_order">lexicographic
order</a>, allowing efficient retrieval of key ranges. Key-value stores
can allow for storing of metadata with a value.</p>
<p>Key-value stores provide high performance and are often used for
simple data models or for rapidly-changing data, such as an in-memory
cache layer. Since they offer only a limited set of operations,
complexity is shifted to the application layer if additional operations
are needed.</p>
<p>A key-value store is the basis for more complex systems such as a
document store, and in some cases, a graph database.</p>
<h5 id="sources-and-further-reading-key-value-store">Source(s) and
further reading: key-value store</h5>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Key-value_database" target="_blank">Key-value
database</a></li>
<li><a
href="http://stackoverflow.com/questions/4056093/what-are-the-disadvantages-of-using-a-key-value-table-over-nullable-columns-or">Disadvantages
of key-value stores</a></li>
<li><a href="http://qnimate.com/overview-of-redis-architecture/" target="_blank">Redis
architecture</a></li>
<li><a
href="https://adayinthelifeof.nl/2011/02/06/memcache-internals/">Memcached
architecture</a></li>
</ul>
<h4 id="document-store">Document store</h4>
<blockquote>
<p>Abstraction: key-value store with documents stored as values</p>
</blockquote>
<p>A document store is centered around documents (XML, JSON, binary,
etc), where a document stores all information for a given object.
Document stores provide APIs or a query language to query based on the
internal structure of the document itself. <em>Note, many key-value
stores include features for working with a value’s metadata, blurring
the lines between these two storage types.</em></p>
<p>Based on the underlying implementation, documents are organized by
collections, tags, metadata, or directories. Although documents can be
organized or grouped together, documents may have fields that are
completely different from each other.</p>
<p>Some document stores like <a
href="https://www.mongodb.com/mongodb-architecture">MongoDB</a> and <a
href="https://blog.couchdb.org/2016/08/01/couchdb-2-0-architecture/">CouchDB</a>
also provide a SQL-like language to perform complex queries. <a
href="http://www.read.seas.harvard.edu/~kohler/class/cs239-w08/decandia07dynamo.pdf">DynamoDB</a>
supports both key-values and documents.</p>
<p>Document stores provide high flexibility and are often used for
working with occasionally changing data.</p>
<h5 id="sources-and-further-reading-document-store">Source(s) and
further reading: document store</h5>
<ul>
<li><a
href="https://en.wikipedia.org/wiki/Document-oriented_database">Document-oriented
database</a></li>
<li><a href="https://www.mongodb.com/mongodb-architecture" target="_blank">MongoDB
architecture</a></li>
<li><a
href="https://blog.couchdb.org/2016/08/01/couchdb-2-0-architecture/">CouchDB
architecture</a></li>
<li><a
href="https://www.elastic.co/blog/found-elasticsearch-from-the-bottom-up">Elasticsearch
architecture</a></li>
</ul>
<h4 id="wide-column-store">Wide column store</h4>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/n16iOGk.png"> <br/>
<i><a href=http://blog.grio.com/2015/11/sql-nosql-a-brief-history.html>Source:
SQL &amp; NoSQL, a brief history</a></i>
</p>
<blockquote>
<p>Abstraction: nested map
<code>ColumnFamily&lt;RowKey, Columns&lt;ColKey, Value, Timestamp&gt;&gt;</code></p>
</blockquote>
<p>A wide column store’s basic unit of data is a column (name/value
pair). A column can be grouped in column families (analogous to a SQL
table). Super column families further group column families. You can
access each column independently with a row key, and columns with the
same row key form a row. Each value contains a timestamp for versioning
and for conflict resolution.</p>
<p>Google introduced <a
href="http://www.read.seas.harvard.edu/~kohler/class/cs239-w08/chang06bigtable.pdf">Bigtable</a>
as the first wide column store, which influenced the open-source <a
href="https://www.edureka.co/blog/hbase-architecture/">HBase</a>
often-used in the Hadoop ecosystem, and <a
href="http://docs.datastax.com/en/cassandra/3.0/cassandra/architecture/archIntro.html">Cassandra</a>
from Facebook. Stores such as BigTable, HBase, and Cassandra maintain
keys in lexicographic order, allowing efficient retrieval of selective
key ranges.</p>
<p>Wide column stores offer high availability and high scalability. They
are often used for very large data sets.</p>
<h5 id="sources-and-further-reading-wide-column-store">Source(s) and
further reading: wide column store</h5>
<ul>
<li><a
href="http://blog.grio.com/2015/11/sql-nosql-a-brief-history.html">SQL
&amp; NoSQL, a brief history</a></li>
<li><a
href="http://www.read.seas.harvard.edu/~kohler/class/cs239-w08/chang06bigtable.pdf">Bigtable
architecture</a></li>
<li><a href="https://www.edureka.co/blog/hbase-architecture/" target="_blank">HBase
architecture</a></li>
<li><a
href="http://docs.datastax.com/en/cassandra/3.0/cassandra/architecture/archIntro.html">Cassandra
architecture</a></li>
</ul>
<h4 id="graph-database">Graph database</h4>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/fNcl65g.png"> <br/>
<i><a href=https://en.wikipedia.org/wiki/File:GraphDatabase_PropertyGraph.png>Source:
Graph database</a></i>
</p>
<blockquote>
<p>Abstraction: graph</p>
</blockquote>
<p>In a graph database, each node is a record and each arc is a
relationship between two nodes. Graph databases are optimized to
represent complex relationships with many foreign keys or many-to-many
relationships.</p>
<p>Graphs databases offer high performance for data models with complex
relationships, such as a social network. They are relatively new and are
not yet widely-used; it might be more difficult to find development
tools and resources. Many graphs can only be accessed with <a
href="#representational-state-transfer-rest">REST APIs</a>.</p>
<h5 id="sources-and-further-reading-graph">Source(s) and further
reading: graph</h5>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Graph_database" target="_blank">Graph
database</a></li>
<li><a href="https://neo4j.com/" target="_blank">Neo4j</a></li>
<li><a
href="https://blog.twitter.com/2010/introducing-flockdb">FlockDB</a></li>
</ul>
<h4 id="sources-and-further-reading-nosql">Source(s) and further
reading: NoSQL</h4>
<ul>
<li><a
href="http://stackoverflow.com/questions/3342497/explanation-of-base-terminology">Explanation
of base terminology</a></li>
<li><a
href="https://medium.com/baqend-blog/nosql-databases-a-survey-and-decision-guidance-ea7823a822d#.wskogqenq">NoSQL
databases a survey and decision guidance</a></li>
<li><a
href="https://web.archive.org/web/20220602114024/https://www.lecloud.net/post/7994751381/scalability-for-dummies-part-2-database">Scalability</a></li>
<li><a href="https://www.youtube.com/watch?v=qI_g07C_Q5I" target="_blank">Introduction
to NoSQL</a></li>
<li><a
href="http://horicky.blogspot.com/2009/11/nosql-patterns.html">NoSQL
patterns</a></li>
</ul>
<h3 id="sql-or-nosql">SQL or NoSQL</h3>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/wXGqG5f.png"> <br/>
<i><a href=https://www.infoq.com/articles/Transition-RDBMS-NoSQL/>Source:
Transitioning from RDBMS to NoSQL</a></i>
</p>
<p>Reasons for <strong>SQL</strong>:</p>
<ul>
<li>Structured data</li>
<li>Strict schema</li>
<li>Relational data</li>
<li>Need for complex joins</li>
<li>Transactions</li>
<li>Clear patterns for scaling</li>
<li>More established: developers, community, code, tools, etc</li>
<li>Lookups by index are very fast</li>
</ul>
<p>Reasons for <strong>NoSQL</strong>:</p>
<ul>
<li>Semi-structured data</li>
<li>Dynamic or flexible schema</li>
<li>Non-relational data</li>
<li>No need for complex joins</li>
<li>Store many TB (or PB) of data</li>
<li>Very data intensive workload</li>
<li>Very high throughput for IOPS</li>
</ul>
<p>Sample data well-suited for NoSQL:</p>
<ul>
<li>Rapid ingest of clickstream and log data</li>
<li>Leaderboard or scoring data</li>
<li>Temporary data, such as a shopping cart</li>
<li>Frequently accessed (‘hot’) tables</li>
<li>Metadata/lookup tables</li>
</ul>
<h5 id="sources-and-further-reading-sql-or-nosql">Source(s) and further
reading: SQL or NoSQL</h5>
<ul>
<li><a href="https://www.youtube.com/watch?v=kKjm4ehYiMs" target="_blank">Scaling up to
your first 10 million users</a></li>
<li><a href="https://www.sitepoint.com/sql-vs-nosql-differences/" target="_blank">SQL vs
NoSQL differences</a></li>
</ul>
<h2 id="cache">Cache</h2>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/Q6z24La.png"> <br/>
<i><a href=http://horicky.blogspot.com/2010/10/scalable-system-design-patterns.html>Source:
Scalable system design patterns</a></i>
</p>
<p>Caching improves page load times and can reduce the load on your
servers and databases. In this model, the dispatcher will first lookup
if the request has been made before and try to find the previous result
to return, in order to save the actual execution.</p>
<p>Databases often benefit from a uniform distribution of reads and
writes across its partitions. Popular items can skew the distribution,
causing bottlenecks. Putting a cache in front of a database can help
absorb uneven loads and spikes in traffic.</p>
<h3 id="client-caching">Client caching</h3>
<p>Caches can be located on the client side (OS or browser), <a
href="#reverse-proxy-web-server">server side</a>, or in a distinct cache
layer.</p>
<h3 id="cdn-caching">CDN caching</h3>
<p><a href="#content-delivery-network">CDNs</a> are considered a type of
cache.</p>
<h3 id="web-server-caching">Web server caching</h3>
<p><a href="#reverse-proxy-web-server">Reverse proxies</a> and caches
such as <a href="https://www.varnish-cache.org/" target="_blank">Varnish</a> can serve
static and dynamic content directly. Web servers can also cache
requests, returning responses without having to contact application
servers.</p>
<h3 id="database-caching">Database caching</h3>
<p>Your database usually includes some level of caching in a default
configuration, optimized for a generic use case. Tweaking these settings
for specific usage patterns can further boost performance.</p>
<h3 id="application-caching">Application caching</h3>
<p>In-memory caches such as Memcached and Redis are key-value stores
between your application and your data storage. Since the data is held
in RAM, it is much faster than typical databases where data is stored on
disk. RAM is more limited than disk, so <a
href="https://en.wikipedia.org/wiki/Cache_algorithms">cache
invalidation</a> algorithms such as <a
href="https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_recently_used_(LRU)">least
recently used (LRU)</a> can help invalidate ‘cold’ entries and keep
‘hot’ data in RAM.</p>
<p>Redis has the following additional features:</p>
<ul>
<li>Persistence option</li>
<li>Built-in data structures such as sorted sets and lists</li>
</ul>
<p>There are multiple levels you can cache that fall into two general
categories: <strong>database queries</strong> and
<strong>objects</strong>:</p>
<ul>
<li>Row level</li>
<li>Query-level</li>
<li>Fully-formed serializable objects</li>
<li>Fully-rendered HTML</li>
</ul>
<p>Generally, you should try to avoid file-based caching, as it makes
cloning and auto-scaling more difficult.</p>
<h3 id="caching-at-the-database-query-level">Caching at the database
query level</h3>
<p>Whenever you query the database, hash the query as a key and store
the result to the cache. This approach suffers from expiration
issues:</p>
<ul>
<li>Hard to delete a cached result with complex queries</li>
<li>If one piece of data changes such as a table cell, you need to
delete all cached queries that might include the changed cell</li>
</ul>
<h3 id="caching-at-the-object-level">Caching at the object level</h3>
<p>See your data as an object, similar to what you do with your
application code. Have your application assemble the dataset from the
database into a class instance or a data structure(s):</p>
<ul>
<li>Remove the object from cache if its underlying data has changed</li>
<li>Allows for asynchronous processing: workers assemble objects by
consuming the latest cached object</li>
</ul>
<p>Suggestions of what to cache:</p>
<ul>
<li>User sessions</li>
<li>Fully rendered web pages</li>
<li>Activity streams</li>
<li>User graph data</li>
</ul>
<h3 id="when-to-update-the-cache">When to update the cache</h3>
<p>Since you can only store a limited amount of data in cache, you’ll
need to determine which cache update strategy works best for your use
case.</p>
<h4 id="cache-aside">Cache-aside</h4>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/ONjORqk.png"> <br/>
<i><a href=http://www.slideshare.net/tmatyashovsky/from-cache-to-in-memory-data-grid-introduction-to-hazelcast>Source:
From cache to in-memory data grid</a></i>
</p>
<p>The application is responsible for reading and writing from storage.
The cache does not interact with storage directly. The application does
the following:</p>
<ul>
<li>Look for entry in cache, resulting in a cache miss</li>
<li>Load entry from the database</li>
<li>Add entry to cache</li>
<li>Return entry</li>
</ul>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_user(<span class="va">self</span>, user_id):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    user <span class="op">=</span> cache.get(<span class="st">&quot;user.</span><span class="sc">{0}</span><span class="st">&quot;</span>, user_id)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> user <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>        user <span class="op">=</span> db.query(<span class="st">&quot;SELECT * FROM users WHERE user_id = </span><span class="sc">{0}</span><span class="st">&quot;</span>, user_id)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> user <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>            key <span class="op">=</span> <span class="st">&quot;user.</span><span class="sc">{0}</span><span class="st">&quot;</span>.<span class="bu">format</span>(user_id)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>            cache.<span class="bu">set</span>(key, json.dumps(user))</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> user</span></code></pre></div>
<p><a href="https://memcached.org/" target="_blank">Memcached</a> is generally used in
this manner.</p>
<p>Subsequent reads of data added to cache are fast. Cache-aside is also
referred to as lazy loading. Only requested data is cached, which avoids
filling up the cache with data that isn’t requested.</p>
<h5 id="disadvantages-cache-aside">Disadvantage(s): cache-aside</h5>
<ul>
<li>Each cache miss results in three trips, which can cause a noticeable
delay.</li>
<li>Data can become stale if it is updated in the database. This issue
is mitigated by setting a time-to-live (TTL) which forces an update of
the cache entry, or by using write-through.</li>
<li>When a node fails, it is replaced by a new, empty node, increasing
latency.</li>
</ul>
<h4 id="write-through">Write-through</h4>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/0vBc0hN.png"> <br/>
<i><a href=http://www.slideshare.net/jboner/scalability-availability-stability-patterns/>Source:
Scalability, availability, stability, patterns</a></i>
</p>
<p>The application uses the cache as the main data store, reading and
writing data to it, while the cache is responsible for reading and
writing to the database:</p>
<ul>
<li>Application adds/updates entry in cache</li>
<li>Cache synchronously writes entry to data store</li>
<li>Return</li>
</ul>
<p>Application code:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>set_user(<span class="dv">12345</span>, {<span class="st">&quot;foo&quot;</span>:<span class="st">&quot;bar&quot;</span>})</span></code></pre></div>
<p>Cache code:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_user(user_id, values):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    user <span class="op">=</span> db.query(<span class="st">&quot;UPDATE Users WHERE id = </span><span class="sc">{0}</span><span class="st">&quot;</span>, user_id, values)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    cache.<span class="bu">set</span>(user_id, user)</span></code></pre></div>
<p>Write-through is a slow overall operation due to the write operation,
but subsequent reads of just written data are fast. Users are generally
more tolerant of latency when updating data than reading data. Data in
the cache is not stale.</p>
<h5 id="disadvantages-write-through">Disadvantage(s): write through</h5>
<ul>
<li>When a new node is created due to failure or scaling, the new node
will not cache entries until the entry is updated in the database.
Cache-aside in conjunction with write through can mitigate this
issue.</li>
<li>Most data written might never be read, which can be minimized with a
TTL.</li>
</ul>
<h4 id="write-behind-write-back">Write-behind (write-back)</h4>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/rgSrvjG.png"> <br/>
<i><a href=http://www.slideshare.net/jboner/scalability-availability-stability-patterns/>Source:
Scalability, availability, stability, patterns</a></i>
</p>
<p>In write-behind, the application does the following:</p>
<ul>
<li>Add/update entry in cache</li>
<li>Asynchronously write entry to the data store, improving write
performance</li>
</ul>
<h5 id="disadvantages-write-behind">Disadvantage(s): write-behind</h5>
<ul>
<li>There could be data loss if the cache goes down prior to its
contents hitting the data store.</li>
<li>It is more complex to implement write-behind than it is to implement
cache-aside or write-through.</li>
</ul>
<h4 id="refresh-ahead">Refresh-ahead</h4>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/kxtjqgE.png"> <br/>
<i><a href=http://www.slideshare.net/tmatyashovsky/from-cache-to-in-memory-data-grid-introduction-to-hazelcast>Source:
From cache to in-memory data grid</a></i>
</p>
<p>You can configure the cache to automatically refresh any recently
accessed cache entry prior to its expiration.</p>
<p>Refresh-ahead can result in reduced latency vs read-through if the
cache can accurately predict which items are likely to be needed in the
future.</p>
<h5 id="disadvantages-refresh-ahead">Disadvantage(s): refresh-ahead</h5>
<ul>
<li>Not accurately predicting which items are likely to be needed in the
future can result in reduced performance than without
refresh-ahead.</li>
</ul>
<h3 id="disadvantages-cache">Disadvantage(s): cache</h3>
<ul>
<li>Need to maintain consistency between caches and the source of truth
such as the database through <a
href="https://en.wikipedia.org/wiki/Cache_algorithms">cache
invalidation</a>.</li>
<li>Cache invalidation is a difficult problem, there is additional
complexity associated with when to update the cache.</li>
<li>Need to make application changes such as adding Redis or
memcached.</li>
</ul>
<h3 id="sources-and-further-reading-10">Source(s) and further
reading</h3>
<ul>
<li><a
href="http://www.slideshare.net/tmatyashovsky/from-cache-to-in-memory-data-grid-introduction-to-hazelcast">From
cache to in-memory data grid</a></li>
<li><a
href="http://horicky.blogspot.com/2010/10/scalable-system-design-patterns.html">Scalable
system design patterns</a></li>
<li><a
href="http://lethain.com/introduction-to-architecting-systems-for-scale/">Introduction
to architecting systems for scale</a></li>
<li><a
href="http://www.slideshare.net/jboner/scalability-availability-stability-patterns/">Scalability,
availability, stability, patterns</a></li>
<li><a
href="https://web.archive.org/web/20230126233752/https://www.lecloud.net/post/9246290032/scalability-for-dummies-part-3-cache">Scalability</a></li>
<li><a
href="http://docs.aws.amazon.com/AmazonElastiCache/latest/UserGuide/Strategies.html">AWS
ElastiCache strategies</a></li>
<li><a
href="https://en.wikipedia.org/wiki/Cache_(computing)">Wikipedia</a></li>
</ul>
<h2 id="asynchronism">Asynchronism</h2>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/54GYsSx.png"> <br/>
<i><a href=http://lethain.com/introduction-to-architecting-systems-for-scale/#platform_layer>Source:
Intro to architecting systems for scale</a></i>
</p>
<p>Asynchronous workflows help reduce request times for expensive
operations that would otherwise be performed in-line. They can also help
by doing time-consuming work in advance, such as periodic aggregation of
data.</p>
<h3 id="message-queues">Message queues</h3>
<p>Message queues receive, hold, and deliver messages. If an operation
is too slow to perform inline, you can use a message queue with the
following workflow:</p>
<ul>
<li>An application publishes a job to the queue, then notifies the user
of job status</li>
<li>A worker picks up the job from the queue, processes it, then signals
the job is complete</li>
</ul>
<p>The user is not blocked and the job is processed in the background.
During this time, the client might optionally do a small amount of
processing to make it seem like the task has completed. For example, if
posting a tweet, the tweet could be instantly posted to your timeline,
but it could take some time before your tweet is actually delivered to
all of your followers.</p>
<p><strong><a href="https://redis.io/" target="_blank">Redis</a></strong> is useful as a
simple message broker but messages can be lost.</p>
<p><strong><a href="https://www.rabbitmq.com/" target="_blank">RabbitMQ</a></strong> is
popular but requires you to adapt to the ‘AMQP’ protocol and manage your
own nodes.</p>
<p><strong><a href="https://aws.amazon.com/sqs/" target="_blank">Amazon SQS</a></strong>
is hosted but can have high latency and has the possibility of messages
being delivered twice.</p>
<h3 id="task-queues">Task queues</h3>
<p>Tasks queues receive tasks and their related data, runs them, then
delivers their results. They can support scheduling and can be used to
run computationally-intensive jobs in the background.</p>
<p><strong><a
href="https://docs.celeryproject.org/en/stable/">Celery</a></strong> has
support for scheduling and primarily has python support.</p>
<h3 id="back-pressure">Back pressure</h3>
<p>If queues start to grow significantly, the queue size can become
larger than memory, resulting in cache misses, disk reads, and even
slower performance. <a
href="http://mechanical-sympathy.blogspot.com/2012/05/apply-back-pressure-when-overloaded.html">Back
pressure</a> can help by limiting the queue size, thereby maintaining a
high throughput rate and good response times for jobs already in the
queue. Once the queue fills up, clients get a server busy or HTTP 503
status code to try again later. Clients can retry the request at a later
time, perhaps with <a
href="https://en.wikipedia.org/wiki/Exponential_backoff">exponential
backoff</a>.</p>
<h3 id="disadvantages-asynchronism">Disadvantage(s): asynchronism</h3>
<ul>
<li>Use cases such as inexpensive calculations and realtime workflows
might be better suited for synchronous operations, as introducing queues
can add delays and complexity.</li>
</ul>
<h3 id="sources-and-further-reading-11">Source(s) and further
reading</h3>
<ul>
<li><a href="https://www.youtube.com/watch?v=1KRYH75wgy4" target="_blank">It’s all a
numbers game</a></li>
<li><a
href="http://mechanical-sympathy.blogspot.com/2012/05/apply-back-pressure-when-overloaded.html">Applying
back pressure when overloaded</a></li>
<li><a href="https://en.wikipedia.org/wiki/Little%27s_law" target="_blank">Little’s
law</a></li>
<li><a
href="https://www.quora.com/What-is-the-difference-between-a-message-queue-and-a-task-queue-Why-would-a-task-queue-require-a-message-broker-like-RabbitMQ-Redis-Celery-or-IronMQ-to-function">What
is the difference between a message queue and a task queue?</a></li>
</ul>
<h2 id="communication">Communication</h2>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/5KeocQs.jpg"> <br/>
<i><a href=http://www.escotal.com/osilayer.html>Source: OSI 7 layer
model</a></i>
</p>
<h3 id="hypertext-transfer-protocol-http">Hypertext transfer protocol
(HTTP)</h3>
<p>HTTP is a method for encoding and transporting data between a client
and a server. It is a request/response protocol: clients issue requests
and servers issue responses with relevant content and completion status
info about the request. HTTP is self-contained, allowing requests and
responses to flow through many intermediate routers and servers that
perform load balancing, caching, encryption, and compression.</p>
<p>A basic HTTP request consists of a verb (method) and a resource
(endpoint). Below are common HTTP verbs:</p>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr>
<th>Verb</th>
<th>Description</th>
<th>Idempotent*</th>
<th>Safe</th>
<th>Cacheable</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>Reads a resource</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>POST</td>
<td>Creates a resource or trigger a process that handles data</td>
<td>No</td>
<td>No</td>
<td>Yes if response contains freshness info</td>
</tr>
<tr>
<td>PUT</td>
<td>Creates or replace a resource</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td>PATCH</td>
<td>Partially updates a resource</td>
<td>No</td>
<td>No</td>
<td>Yes if response contains freshness info</td>
</tr>
<tr>
<td>DELETE</td>
<td>Deletes a resource</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
</tbody>
</table>
<p>*Can be called many times without different outcomes.</p>
<p>HTTP is an application layer protocol relying on lower-level
protocols such as <strong>TCP</strong> and <strong>UDP</strong>.</p>
<h4 id="sources-and-further-reading-http">Source(s) and further reading:
HTTP</h4>
<ul>
<li><a href="https://www.nginx.com/resources/glossary/http/" target="_blank">What is
HTTP?</a></li>
<li><a
href="https://www.quora.com/What-is-the-difference-between-HTTP-protocol-and-TCP-protocol">Difference
between HTTP and TCP</a></li>
<li><a
href="https://laracasts.com/discuss/channels/general-discussion/whats-the-differences-between-put-and-patch?page=1">Difference
between PUT and PATCH</a></li>
</ul>
<h3 id="transmission-control-protocol-tcp">Transmission control protocol
(TCP)</h3>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/JdAsdvG.jpg"> <br/>
<i><a href=http://www.wildbunny.co.uk/blog/2012/10/09/how-to-make-a-multi-player-game-part-1/>Source:
How to make a multiplayer game</a></i>
</p>
<p>TCP is a connection-oriented protocol over an <a
href="https://en.wikipedia.org/wiki/Internet_Protocol">IP network</a>.
Connection is established and terminated using a <a
href="https://en.wikipedia.org/wiki/Handshaking">handshake</a>. All
packets sent are guaranteed to reach the destination in the original
order and without corruption through:</p>
<ul>
<li>Sequence numbers and <a
href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol#Checksum_computation">checksum
fields</a> for each packet</li>
<li><a
href="https://en.wikipedia.org/wiki/Acknowledgement_(data_networks)">Acknowledgement</a>
packets and automatic retransmission</li>
</ul>
<p>If the sender does not receive a correct response, it will resend the
packets. If there are multiple timeouts, the connection is dropped. TCP
also implements <a
href="https://en.wikipedia.org/wiki/Flow_control_(data)">flow
control</a> and <a
href="https://en.wikipedia.org/wiki/Network_congestion#Congestion_control">congestion
control</a>. These guarantees cause delays and generally result in less
efficient transmission than UDP.</p>
<p>To ensure high throughput, web servers can keep a large number of TCP
connections open, resulting in high memory usage. It can be expensive to
have a large number of open connections between web server threads and
say, a <a href="https://memcached.org/" target="_blank">memcached</a> server. <a
href="https://en.wikipedia.org/wiki/Connection_pool">Connection
pooling</a> can help in addition to switching to UDP where
applicable.</p>
<p>TCP is useful for applications that require high reliability but are
less time critical. Some examples include web servers, database info,
SMTP, FTP, and SSH.</p>
<p>Use TCP over UDP when:</p>
<ul>
<li>You need all of the data to arrive intact</li>
<li>You want to automatically make a best estimate use of the network
throughput</li>
</ul>
<h3 id="user-datagram-protocol-udp">User datagram protocol (UDP)</h3>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/yzDrJtA.jpg"> <br/>
<i><a href=http://www.wildbunny.co.uk/blog/2012/10/09/how-to-make-a-multi-player-game-part-1/>Source:
How to make a multiplayer game</a></i>
</p>
<p>UDP is connectionless. Datagrams (analogous to packets) are
guaranteed only at the datagram level. Datagrams might reach their
destination out of order or not at all. UDP does not support congestion
control. Without the guarantees that TCP support, UDP is generally more
efficient.</p>
<p>UDP can broadcast, sending datagrams to all devices on the subnet.
This is useful with <a
href="https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol">DHCP</a>
because the client has not yet received an IP address, thus preventing a
way for TCP to stream without the IP address.</p>
<p>UDP is less reliable but works well in real time use cases such as
VoIP, video chat, streaming, and realtime multiplayer games.</p>
<p>Use UDP over TCP when:</p>
<ul>
<li>You need the lowest latency</li>
<li>Late data is worse than loss of data</li>
<li>You want to implement your own error correction</li>
</ul>
<h4 id="sources-and-further-reading-tcp-and-udp">Source(s) and further
reading: TCP and UDP</h4>
<ul>
<li><a
href="http://gafferongames.com/networking-for-game-programmers/udp-vs-tcp/">Networking
for game programming</a></li>
<li><a
href="http://www.cyberciti.biz/faq/key-differences-between-tcp-and-udp-protocols/">Key
differences between TCP and UDP protocols</a></li>
<li><a
href="http://stackoverflow.com/questions/5970383/difference-between-tcp-and-udp">Difference
between TCP and UDP</a></li>
<li><a
href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">Transmission
control protocol</a></li>
<li><a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol" target="_blank">User
datagram protocol</a></li>
<li><a
href="http://www.cs.bu.edu/~jappavoo/jappavoo.github.com/451/papers/memcache-fb.pdf">Scaling
memcache at Facebook</a></li>
</ul>
<h3 id="remote-procedure-call-rpc">Remote procedure call (RPC)</h3>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/iF4Mkb5.png"> <br/>
<i><a href=http://www.puncsky.com/blog/2016-02-13-crack-the-system-design-interview>Source:
Crack the system design interview</a></i>
</p>
<p>In an RPC, a client causes a procedure to execute on a different
address space, usually a remote server. The procedure is coded as if it
were a local procedure call, abstracting away the details of how to
communicate with the server from the client program. Remote calls are
usually slower and less reliable than local calls so it is helpful to
distinguish RPC calls from local calls. Popular RPC frameworks include
<a href="https://developers.google.com/protocol-buffers/" target="_blank">Protobuf</a>,
<a href="https://thrift.apache.org/" target="_blank">Thrift</a>, and <a
href="https://avro.apache.org/docs/current/">Avro</a>.</p>
<p>RPC is a request-response protocol:</p>
<ul>
<li><strong>Client program</strong> - Calls the client stub procedure.
The parameters are pushed onto the stack like a local procedure
call.</li>
<li><strong>Client stub procedure</strong> - Marshals (packs) procedure
id and arguments into a request message.</li>
<li><strong>Client communication module</strong> - OS sends the message
from the client to the server.</li>
<li><strong>Server communication module</strong> - OS passes the
incoming packets to the server stub procedure.</li>
<li><strong>Server stub procedure</strong> - Unmarshalls the results,
calls the server procedure matching the procedure id and passes the
given arguments.</li>
<li>The server response repeats the steps above in reverse order.</li>
</ul>
<p>Sample RPC calls:</p>
<pre><code>GET /someoperation?data=anId

POST /anotheroperation
{
  &quot;data&quot;:&quot;anId&quot;;
  &quot;anotherdata&quot;: &quot;another value&quot;
}</code></pre>
<p>RPC is focused on exposing behaviors. RPCs are often used for
performance reasons with internal communications, as you can hand-craft
native calls to better fit your use cases.</p>
<p>Choose a native library (aka SDK) when:</p>
<ul>
<li>You know your target platform.</li>
<li>You want to control how your “logic” is accessed.</li>
<li>You want to control how error control happens off your library.</li>
<li>Performance and end user experience is your primary concern.</li>
</ul>
<p>HTTP APIs following <strong>REST</strong> tend to be used more often
for public APIs.</p>
<h4 id="disadvantages-rpc">Disadvantage(s): RPC</h4>
<ul>
<li>RPC clients become tightly coupled to the service
implementation.</li>
<li>A new API must be defined for every new operation or use case.</li>
<li>It can be difficult to debug RPC.</li>
<li>You might not be able to leverage existing technologies out of the
box. For example, it might require additional effort to ensure <a
href="https://web.archive.org/web/20170608193645/http://etherealbits.com/2012/12/debunking-the-myths-of-rpc-rest/">RPC
calls are properly cached</a> on caching servers such as <a
href="http://www.squid-cache.org/">Squid</a>.</li>
</ul>
<h3 id="representational-state-transfer-rest">Representational state
transfer (REST)</h3>
<p>REST is an architectural style enforcing a client/server model where
the client acts on a set of resources managed by the server. The server
provides a representation of resources and actions that can either
manipulate or get a new representation of resources. All communication
must be stateless and cacheable.</p>
<p>There are four qualities of a RESTful interface:</p>
<ul>
<li><strong>Identify resources (URI in HTTP)</strong> - use the same URI
regardless of any operation.</li>
<li><strong>Change with representations (Verbs in HTTP)</strong> - use
verbs, headers, and body.</li>
<li><strong>Self-descriptive error message (status response in
HTTP)</strong> - Use status codes, don’t reinvent the wheel.</li>
<li><strong><a
href="http://restcookbook.com/Basics/hateoas/">HATEOAS</a> (HTML
interface for HTTP)</strong> - your web service should be fully
accessible in a browser.</li>
</ul>
<p>Sample REST calls:</p>
<pre><code>GET /someresources/anId

PUT /someresources/anId
{&quot;anotherdata&quot;: &quot;another value&quot;}</code></pre>
<p>REST is focused on exposing data. It minimizes the coupling between
client/server and is often used for public HTTP APIs. REST uses a more
generic and uniform method of exposing resources through URIs, <a
href="https://github.com/for-GET/know-your-http-well/blob/master/headers.md">representation
through headers</a>, and actions through verbs such as GET, POST, PUT,
DELETE, and PATCH. Being stateless, REST is great for horizontal scaling
and partitioning.</p>
<h4 id="disadvantages-rest">Disadvantage(s): REST</h4>
<ul>
<li>With REST being focused on exposing data, it might not be a good fit
if resources are not naturally organized or accessed in a simple
hierarchy. For example, returning all updated records from the past hour
matching a particular set of events is not easily expressed as a path.
With REST, it is likely to be implemented with a combination of URI
path, query parameters, and possibly the request body.</li>
<li>REST typically relies on a few verbs (GET, POST, PUT, DELETE, and
PATCH) which sometimes doesn’t fit your use case. For example, moving
expired documents to the archive folder might not cleanly fit within
these verbs.</li>
<li>Fetching complicated resources with nested hierarchies requires
multiple round trips between the client and server to render single
views, e.g. fetching content of a blog entry and the comments on that
entry. For mobile applications operating in variable network conditions,
these multiple roundtrips are highly undesirable.</li>
<li>Over time, more fields might be added to an API response and older
clients will receive all new data fields, even those that they do not
need, as a result, it bloats the payload size and leads to larger
latencies.</li>
</ul>
<h3 id="rpc-and-rest-calls-comparison">RPC and REST calls
comparison</h3>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Operation</th>
<th>RPC</th>
<th>REST</th>
</tr>
</thead>
<tbody>
<tr>
<td>Signup</td>
<td><strong>POST</strong> /signup</td>
<td><strong>POST</strong> /persons</td>
</tr>
<tr>
<td>Resign</td>
<td><strong>POST</strong> /resign<br/>{<br/>“personid”:
“1234”<br/>}</td>
<td><strong>DELETE</strong> /persons/1234</td>
</tr>
<tr>
<td>Read a person</td>
<td><strong>GET</strong> /readPerson?personid=1234</td>
<td><strong>GET</strong> /persons/1234</td>
</tr>
<tr>
<td>Read a person’s items list</td>
<td><strong>GET</strong> /readUsersItemsList?personid=1234</td>
<td><strong>GET</strong> /persons/1234/items</td>
</tr>
<tr>
<td>Add an item to a person’s items</td>
<td><strong>POST</strong> /addItemToUsersItemsList<br/>{<br/>“personid”:
“1234”;<br/>“itemid”: “456”<br/>}</td>
<td><strong>POST</strong> /persons/1234/items<br/>{<br/>“itemid”:
“456”<br/>}</td>
</tr>
<tr>
<td>Update an item</td>
<td><strong>POST</strong> /modifyItem<br/>{<br/>“itemid”:
“456”;<br/>“key”: “value”<br/>}</td>
<td><strong>PUT</strong> /items/456<br/>{<br/>“key”: “value”<br/>}</td>
</tr>
<tr>
<td>Delete an item</td>
<td><strong>POST</strong> /removeItem<br/>{<br/>“itemid”:
“456”<br/>}</td>
<td><strong>DELETE</strong> /items/456</td>
</tr>
</tbody>
</table>
<p align="center">
<i><a href=https://apihandyman.io/do-you-really-know-why-you-prefer-rest-over-rpc/>Source:
Do you really know why you prefer REST over RPC</a></i>
</p>
<h4 id="sources-and-further-reading-rest-and-rpc">Source(s) and further
reading: REST and RPC</h4>
<ul>
<li><a
href="https://apihandyman.io/do-you-really-know-why-you-prefer-rest-over-rpc/">Do
you really know why you prefer REST over RPC</a></li>
<li><a href="http://programmers.stackexchange.com/a/181186" target="_blank">When are
RPC-ish approaches more appropriate than REST?</a></li>
<li><a
href="http://stackoverflow.com/questions/15056878/rest-vs-json-rpc">REST
vs JSON-RPC</a></li>
<li><a
href="https://web.archive.org/web/20170608193645/http://etherealbits.com/2012/12/debunking-the-myths-of-rpc-rest/">Debunking
the myths of RPC and REST</a></li>
<li><a
href="https://www.quora.com/What-are-the-drawbacks-of-using-RESTful-APIs">What
are the drawbacks of using REST</a></li>
<li><a
href="http://www.puncsky.com/blog/2016-02-13-crack-the-system-design-interview">Crack
the system design interview</a></li>
<li><a
href="https://code.facebook.com/posts/1468950976659943/">Thrift</a></li>
<li><a href="http://arstechnica.com/civis/viewtopic.php?t=1190508" target="_blank">Why
REST for internal use and not RPC</a></li>
</ul>
<h2 id="security">Security</h2>
<p>This section could use some updates. Consider <a
href="#contributing">contributing</a>!</p>
<p>Security is a broad topic. Unless you have considerable experience, a
security background, or are applying for a position that requires
knowledge of security, you probably won’t need to know more than the
basics:</p>
<ul>
<li>Encrypt in transit and at rest.</li>
<li>Sanitize all user inputs or any input parameters exposed to user to
prevent <a
href="https://en.wikipedia.org/wiki/Cross-site_scripting">XSS</a> and <a
href="https://en.wikipedia.org/wiki/SQL_injection">SQL
injection</a>.</li>
<li>Use parameterized queries to prevent SQL injection.</li>
<li>Use the principle of <a
href="https://en.wikipedia.org/wiki/Principle_of_least_privilege">least
privilege</a>.</li>
</ul>
<h3 id="sources-and-further-reading-12">Source(s) and further
reading</h3>
<ul>
<li><a href="https://github.com/shieldfy/API-Security-Checklist" target="_blank">API
security checklist</a></li>
<li><a
href="https://github.com/FallibleInc/security-guide-for-developers">Security
guide for developers</a></li>
<li><a
href="https://www.owasp.org/index.php/OWASP_Top_Ten_Cheat_Sheet">OWASP
top ten</a></li>
</ul>
<h2 id="appendix">Appendix</h2>
<p>You’ll sometimes be asked to do ‘back-of-the-envelope’ estimates. For
example, you might need to determine how long it will take to generate
100 image thumbnails from disk or how much memory a data structure will
take. The <strong>Powers of two table</strong> and <strong>Latency
numbers every programmer should know</strong> are handy references.</p>
<h3 id="powers-of-two-table">Powers of two table</h3>
<pre><code>Power           Exact Value         Approx Value        Bytes
---------------------------------------------------------------
7                             128
8                             256
10                           1024   1 thousand           1 KB
16                         65,536                       64 KB
20                      1,048,576   1 million            1 MB
30                  1,073,741,824   1 billion            1 GB
32                  4,294,967,296                        4 GB
40              1,099,511,627,776   1 trillion           1 TB</code></pre>
<h4 id="sources-and-further-reading-13">Source(s) and further
reading</h4>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Power_of_two" target="_blank">Powers of
two</a></li>
</ul>
<h3 id="latency-numbers-every-programmer-should-know">Latency numbers
every programmer should know</h3>
<pre><code>Latency Comparison Numbers
--------------------------
L1 cache reference                           0.5 ns
Branch mispredict                            5   ns
L2 cache reference                           7   ns                      14x L1 cache
Mutex lock/unlock                           25   ns
Main memory reference                      100   ns                      20x L2 cache, 200x L1 cache
Compress 1K bytes with Zippy            10,000   ns       10 us
Send 1 KB bytes over 1 Gbps network     10,000   ns       10 us
Read 4 KB randomly from SSD*           150,000   ns      150 us          ~1GB/sec SSD
Read 1 MB sequentially from memory     250,000   ns      250 us
Round trip within same datacenter      500,000   ns      500 us
Read 1 MB sequentially from SSD*     1,000,000   ns    1,000 us    1 ms  ~1GB/sec SSD, 4X memory
HDD seek                            10,000,000   ns   10,000 us   10 ms  20x datacenter roundtrip
Read 1 MB sequentially from 1 Gbps  10,000,000   ns   10,000 us   10 ms  40x memory, 10X SSD
Read 1 MB sequentially from HDD     30,000,000   ns   30,000 us   30 ms 120x memory, 30X SSD
Send packet CA-&gt;Netherlands-&gt;CA    150,000,000   ns  150,000 us  150 ms

Notes
-----
1 ns = 10^-9 seconds
1 us = 10^-6 seconds = 1,000 ns
1 ms = 10^-3 seconds = 1,000 us = 1,000,000 ns</code></pre>
<p>Handy metrics based on numbers above:</p>
<ul>
<li>Read sequentially from HDD at 30 MB/s</li>
<li>Read sequentially from 1 Gbps Ethernet at 100 MB/s</li>
<li>Read sequentially from SSD at 1 GB/s</li>
<li>Read sequentially from main memory at 4 GB/s</li>
<li>6-7 world-wide round trips per second</li>
<li>2,000 round trips per second within a data center</li>
</ul>
<h4 id="latency-numbers-visualized">Latency numbers visualized</h4>
<p><img
src="https://camo.githubusercontent.com/77f72259e1eb58596b564d1ad823af1853bc60a3/687474703a2f2f692e696d6775722e636f6d2f6b307431652e706e67" /></p>
<h4 id="sources-and-further-reading-14">Source(s) and further
reading</h4>
<ul>
<li><a href="https://gist.github.com/jboner/2841832" target="_blank">Latency numbers
every programmer should know - 1</a></li>
<li><a href="https://gist.github.com/hellerbarde/2843375" target="_blank">Latency
numbers every programmer should know - 2</a></li>
<li><a
href="http://www.cs.cornell.edu/projects/ladis2009/talks/dean-keynote-ladis2009.pdf">Designs,
lessons, and advice from building large distributed systems</a></li>
<li><a
href="https://static.googleusercontent.com/media/research.google.com/en//people/jeff/stanford-295-talk.pdf">Software
Engineering Advice from Building Large-Scale Distributed
Systems</a></li>
</ul>
<h3 id="additional-system-design-interview-questions">Additional system
design interview questions</h3>
<blockquote>
<p>Common system design interview questions, with links to resources on
how to solve each.</p>
</blockquote>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>Question</th>
<th>Reference(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Design a file sync service like Dropbox</td>
<td><a
href="https://www.youtube.com/watch?v=PE4gwstWhmc">youtube.com</a></td>
</tr>
<tr>
<td>Design a search engine like Google</td>
<td><a
href="http://queue.acm.org/detail.cfm?id=988407">queue.acm.org</a><br/><a
href="http://programmers.stackexchange.com/questions/38324/interview-question-how-would-you-implement-google-search">stackexchange.com</a><br/><a
href="http://www.ardendertat.com/2012/01/11/implementing-search-engines/">ardendertat.com</a><br/><a
href="http://infolab.stanford.edu/~backrub/google.html">stanford.edu</a></td>
</tr>
<tr>
<td>Design a scalable web crawler like Google</td>
<td><a
href="https://www.quora.com/How-can-I-build-a-web-crawler-from-scratch">quora.com</a></td>
</tr>
<tr>
<td>Design Google docs</td>
<td><a
href="https://code.google.com/p/google-mobwrite/">code.google.com</a><br/><a
href="https://neil.fraser.name/writing/sync/">neil.fraser.name</a></td>
</tr>
<tr>
<td>Design a key-value store like Redis</td>
<td><a
href="http://www.slideshare.net/dvirsky/introduction-to-redis">slideshare.net</a></td>
</tr>
<tr>
<td>Design a cache system like Memcached</td>
<td><a
href="http://www.slideshare.net/oemebamo/introduction-to-memcached">slideshare.net</a></td>
</tr>
<tr>
<td>Design a recommendation system like Amazon’s</td>
<td><a
href="https://web.archive.org/web/20170406065247/http://tech.hulu.com/blog/2011/09/19/recommendation-system.html">hulu.com</a><br/><a
href="http://ijcai13.org/files/tutorial_slides/td3.pdf">ijcai13.org</a></td>
</tr>
<tr>
<td>Design a tinyurl system like Bitly</td>
<td><a
href="http://n00tc0d3r.blogspot.com/">n00tc0d3r.blogspot.com</a></td>
</tr>
<tr>
<td>Design a chat app like WhatsApp</td>
<td><a
href="http://highscalability.com/blog/2014/2/26/the-whatsapp-architecture-facebook-bought-for-19-billion.html">highscalability.com</a></td>
</tr>
<tr>
<td>Design a picture sharing system like Instagram</td>
<td><a
href="http://highscalability.com/flickr-architecture">highscalability.com</a><br/><a
href="http://highscalability.com/blog/2011/12/6/instagram-architecture-14-million-users-terabytes-of-photos.html">highscalability.com</a></td>
</tr>
<tr>
<td>Design the Facebook news feed function</td>
<td><a
href="http://www.quora.com/What-are-best-practices-for-building-something-like-a-News-Feed">quora.com</a><br/><a
href="http://www.quora.com/Activity-Streams/What-are-the-scaling-issues-to-keep-in-mind-while-developing-a-social-network-feed">quora.com</a><br/><a
href="http://www.slideshare.net/danmckinley/etsy-activity-feeds-architecture">slideshare.net</a></td>
</tr>
<tr>
<td>Design the Facebook timeline function</td>
<td><a
href="https://www.facebook.com/note.php?note_id=10150468255628920">facebook.com</a><br/><a
href="http://highscalability.com/blog/2012/1/23/facebook-timeline-brought-to-you-by-the-power-of-denormaliza.html">highscalability.com</a></td>
</tr>
<tr>
<td>Design the Facebook chat function</td>
<td><a
href="http://www.erlang-factory.com/upload/presentations/31/EugeneLetuchy-ErlangatFacebook.pdf">erlang-factory.com</a><br/><a
href="https://www.facebook.com/note.php?note_id=14218138919&amp;id=9445547199&amp;index=0">facebook.com</a></td>
</tr>
<tr>
<td>Design a graph search function like Facebook’s</td>
<td><a
href="https://www.facebook.com/notes/facebook-engineering/under-the-hood-building-out-the-infrastructure-for-graph-search/10151347573598920">facebook.com</a><br/><a
href="https://www.facebook.com/notes/facebook-engineering/under-the-hood-indexing-and-ranking-in-graph-search/10151361720763920">facebook.com</a><br/><a
href="https://www.facebook.com/notes/facebook-engineering/under-the-hood-the-natural-language-interface-of-graph-search/10151432733048920">facebook.com</a></td>
</tr>
<tr>
<td>Design a content delivery network like CloudFlare</td>
<td><a
href="https://figshare.com/articles/Globally_distributed_content_delivery/6605972">figshare.com</a></td>
</tr>
<tr>
<td>Design a trending topic system like Twitter’s</td>
<td><a
href="http://www.michael-noll.com/blog/2013/01/18/implementing-real-time-trending-topics-in-storm/">michael-noll.com</a><br/><a
href="http://snikolov.wordpress.com/2012/11/14/early-detection-of-twitter-trends/">snikolov
.wordpress.com</a></td>
</tr>
<tr>
<td>Design a random ID generation system</td>
<td><a
href="https://blog.twitter.com/2010/announcing-snowflake">blog.twitter.com</a><br/><a
href="https://github.com/twitter/snowflake/">github.com</a></td>
</tr>
<tr>
<td>Return the top k requests during a time interval</td>
<td><a
href="https://www.cs.ucsb.edu/sites/default/files/documents/2005-23.pdf">cs.ucsb.edu</a><br/><a
href="http://davis.wpi.edu/xmdv/docs/EDBT11-diyang.pdf">wpi.edu</a></td>
</tr>
<tr>
<td>Design a system that serves data from multiple data centers</td>
<td><a
href="http://highscalability.com/blog/2009/8/24/how-google-serves-data-from-multiple-datacenters.html">highscalability.com</a></td>
</tr>
<tr>
<td>Design an online multiplayer card game</td>
<td><a
href="https://web.archive.org/web/20180929181117/http://www.indieflashblog.com/how-to-create-an-asynchronous-multiplayer-game.html">indieflashblog.com</a><br/><a
href="http://buildnewgames.com/real-time-multiplayer/">buildnewgames.com</a></td>
</tr>
<tr>
<td>Design a garbage collection system</td>
<td><a
href="http://journal.stuffwithstuff.com/2013/12/08/babys-first-garbage-collector/">stuffwithstuff.com</a><br/><a
href="http://courses.cs.washington.edu/courses/csep521/07wi/prj/rick.pdf">washington.edu</a></td>
</tr>
<tr>
<td>Design an API rate limiter</td>
<td><a
href="https://stripe.com/blog/rate-limiters">https://stripe.com/blog/</a></td>
</tr>
<tr>
<td>Design a Stock Exchange (like NASDAQ or Binance)</td>
<td><a href="https://youtu.be/b1e4t2k2KJY" target="_blank">Jane Street</a><br/><a
href="https://around25.com/blog/building-a-trading-engine-for-a-crypto-exchange/">Golang
Implementation</a><br/><a
href="http://bhomnick.net/building-a-simple-limit-order-in-go/">Go
Implementation</a></td>
</tr>
<tr>
<td>Add a system design question</td>
<td><a href="#contributing">Contribute</a></td>
</tr>
</tbody>
</table>
<h3 id="real-world-architectures">Real world architectures</h3>
<blockquote>
<p>Articles on how real world systems are designed.</p>
</blockquote>
<p align="center">
<img src="https://raw.githubusercontent.com/donnemartin/system-design-primer/master/images/TcUo2fw.png"> <br/>
<i><a href=https://www.infoq.com/presentations/Twitter-Timeline-Scalability>Source:
Twitter timelines at scale</a></i>
</p>
<p><strong>Don’t focus on nitty gritty details for the following
articles, instead:</strong></p>
<ul>
<li>Identify shared principles, common technologies, and patterns within
these articles</li>
<li>Study what problems are solved by each component, where it works,
where it doesn’t</li>
<li>Review the lessons learned</li>
</ul>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th>Type</th>
<th>System</th>
<th>Reference(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Data processing</td>
<td><strong>MapReduce</strong> - Distributed data processing from
Google</td>
<td><a
href="http://static.googleusercontent.com/media/research.google.com/zh-CN/us/archive/mapreduce-osdi04.pdf">research.google.com</a></td>
</tr>
<tr>
<td>Data processing</td>
<td><strong>Spark</strong> - Distributed data processing from
Databricks</td>
<td><a
href="http://www.slideshare.net/AGrishchenko/apache-spark-architecture">slideshare.net</a></td>
</tr>
<tr>
<td>Data processing</td>
<td><strong>Storm</strong> - Distributed data processing from
Twitter</td>
<td><a
href="http://www.slideshare.net/previa/storm-16094009">slideshare.net</a></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>Bigtable</strong> - Distributed column-oriented database
from Google</td>
<td><a
href="http://www.read.seas.harvard.edu/~kohler/class/cs239-w08/chang06bigtable.pdf">harvard.edu</a></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>HBase</strong> - Open source implementation of Bigtable</td>
<td><a
href="http://www.slideshare.net/alexbaranau/intro-to-hbase">slideshare.net</a></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>Cassandra</strong> - Distributed column-oriented database
from Facebook</td>
<td><a
href="http://www.slideshare.net/planetcassandra/cassandra-introduction-features-30103666">slideshare.net</a></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>DynamoDB</strong> - Document-oriented database from
Amazon</td>
<td><a
href="http://www.read.seas.harvard.edu/~kohler/class/cs239-w08/decandia07dynamo.pdf">harvard.edu</a></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>MongoDB</strong> - Document-oriented database</td>
<td><a
href="http://www.slideshare.net/mdirolf/introduction-to-mongodb">slideshare.net</a></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>Spanner</strong> - Globally-distributed database from
Google</td>
<td><a
href="http://research.google.com/archive/spanner-osdi2012.pdf">research.google.com</a></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>Memcached</strong> - Distributed memory caching system</td>
<td><a
href="http://www.slideshare.net/oemebamo/introduction-to-memcached">slideshare.net</a></td>
</tr>
<tr>
<td>Data store</td>
<td><strong>Redis</strong> - Distributed memory caching system with
persistence and value types</td>
<td><a
href="http://www.slideshare.net/dvirsky/introduction-to-redis">slideshare.net</a></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>File system</td>
<td><strong>Google File System (GFS)</strong> - Distributed file
system</td>
<td><a
href="http://static.googleusercontent.com/media/research.google.com/zh-CN/us/archive/gfs-sosp2003.pdf">research.google.com</a></td>
</tr>
<tr>
<td>File system</td>
<td><strong>Hadoop File System (HDFS)</strong> - Open source
implementation of GFS</td>
<td><a
href="http://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-hdfs/HdfsDesign.html">apache.org</a></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Misc</td>
<td><strong>Chubby</strong> - Lock service for loosely-coupled
distributed systems from Google</td>
<td><a
href="http://static.googleusercontent.com/external_content/untrusted_dlcp/research.google.com/en/us/archive/chubby-osdi06.pdf">research.google.com</a></td>
</tr>
<tr>
<td>Misc</td>
<td><strong>Dapper</strong> - Distributed systems tracing
infrastructure</td>
<td><a
href="http://static.googleusercontent.com/media/research.google.com/en//pubs/archive/36356.pdf">research.google.com</a></td>
</tr>
<tr>
<td>Misc</td>
<td><strong>Kafka</strong> - Pub/sub message queue from LinkedIn</td>
<td><a
href="http://www.slideshare.net/mumrah/kafka-talk-tri-hug">slideshare.net</a></td>
</tr>
<tr>
<td>Misc</td>
<td><strong>Zookeeper</strong> - Centralized infrastructure and services
enabling synchronization</td>
<td><a
href="http://www.slideshare.net/sauravhaloi/introduction-to-apache-zookeeper">slideshare.net</a></td>
</tr>
<tr>
<td></td>
<td>Add an architecture</td>
<td><a href="#contributing">Contribute</a></td>
</tr>
</tbody>
</table>
<h3 id="company-architectures">Company architectures</h3>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>Company</th>
<th>Reference(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Amazon</td>
<td><a href="http://highscalability.com/amazon-architecture" target="_blank">Amazon
architecture</a></td>
</tr>
<tr>
<td>Cinchcast</td>
<td><a
href="http://highscalability.com/blog/2012/7/16/cinchcast-architecture-producing-1500-hours-of-audio-every-d.html">Producing
1,500 hours of audio every day</a></td>
</tr>
<tr>
<td>DataSift</td>
<td><a
href="http://highscalability.com/blog/2011/11/29/datasift-architecture-realtime-datamining-at-120000-tweets-p.html">Realtime
datamining At 120,000 tweets per second</a></td>
</tr>
<tr>
<td>Dropbox</td>
<td><a href="https://www.youtube.com/watch?v=PE4gwstWhmc" target="_blank">How we’ve
scaled Dropbox</a></td>
</tr>
<tr>
<td>ESPN</td>
<td><a
href="http://highscalability.com/blog/2013/11/4/espns-architecture-at-scale-operating-at-100000-duh-nuh-nuhs.html">Operating
At 100,000 duh nuh nuhs per second</a></td>
</tr>
<tr>
<td>Google</td>
<td><a href="http://highscalability.com/google-architecture" target="_blank">Google
architecture</a></td>
</tr>
<tr>
<td>Instagram</td>
<td><a
href="http://highscalability.com/blog/2011/12/6/instagram-architecture-14-million-users-terabytes-of-photos.html">14
million users, terabytes of photos</a><br/><a
href="http://instagram-engineering.tumblr.com/post/13649370142/what-powers-instagram-hundreds-of-instances">What
powers Instagram</a></td>
</tr>
<tr>
<td>Justin.tv</td>
<td><a
href="http://highscalability.com/blog/2010/3/16/justintvs-live-video-broadcasting-architecture.html">Justin.Tv’s
live video broadcasting architecture</a></td>
</tr>
<tr>
<td>Facebook</td>
<td><a
href="https://cs.uwaterloo.ca/~brecht/courses/854-Emerging-2014/readings/key-value/fb-memcached-nsdi-2013.pdf">Scaling
memcached at Facebook</a><br/><a
href="https://cs.uwaterloo.ca/~brecht/courses/854-Emerging-2014/readings/data-store/tao-facebook-distributed-datastore-atc-2013.pdf">TAO:
Facebook’s distributed data store for the social graph</a><br/><a
href="https://www.usenix.org/legacy/event/osdi10/tech/full_papers/Beaver.pdf">Facebook’s
photo storage</a><br/><a
href="http://highscalability.com/blog/2016/6/27/how-facebook-live-streams-to-800000-simultaneous-viewers.html">How
Facebook Live Streams To 800,000 Simultaneous Viewers</a></td>
</tr>
<tr>
<td>Flickr</td>
<td><a href="http://highscalability.com/flickr-architecture" target="_blank">Flickr
architecture</a></td>
</tr>
<tr>
<td>Mailbox</td>
<td><a
href="http://highscalability.com/blog/2013/6/18/scaling-mailbox-from-0-to-one-million-users-in-6-weeks-and-1.html">From
0 to one million users in 6 weeks</a></td>
</tr>
<tr>
<td>Netflix</td>
<td><a
href="http://highscalability.com/blog/2015/11/9/a-360-degree-view-of-the-entire-netflix-stack.html">A
360 Degree View Of The Entire Netflix Stack</a><br/><a
href="http://highscalability.com/blog/2017/12/11/netflix-what-happens-when-you-press-play.html">Netflix:
What Happens When You Press Play?</a></td>
</tr>
<tr>
<td>Pinterest</td>
<td><a
href="http://highscalability.com/blog/2013/4/15/scaling-pinterest-from-0-to-10s-of-billions-of-page-views-a.html">From
0 To 10s of billions of page views a month</a><br/><a
href="http://highscalability.com/blog/2012/5/21/pinterest-architecture-update-18-million-visitors-10x-growth.html">18
million visitors, 10x growth, 12 employees</a></td>
</tr>
<tr>
<td>Playfish</td>
<td><a
href="http://highscalability.com/blog/2010/9/21/playfishs-social-gaming-architecture-50-million-monthly-user.html">50
million monthly users and growing</a></td>
</tr>
<tr>
<td>PlentyOfFish</td>
<td><a
href="http://highscalability.com/plentyoffish-architecture">PlentyOfFish
architecture</a></td>
</tr>
<tr>
<td>Salesforce</td>
<td><a
href="http://highscalability.com/blog/2013/9/23/salesforce-architecture-how-they-handle-13-billion-transacti.html">How
they handle 1.3 billion transactions a day</a></td>
</tr>
<tr>
<td>Stack Overflow</td>
<td><a
href="http://highscalability.com/blog/2009/8/5/stack-overflow-architecture.html">Stack
Overflow architecture</a></td>
</tr>
<tr>
<td>TripAdvisor</td>
<td><a
href="http://highscalability.com/blog/2011/6/27/tripadvisor-architecture-40m-visitors-200m-dynamic-page-view.html">40M
visitors, 200M dynamic page views, 30TB data</a></td>
</tr>
<tr>
<td>Tumblr</td>
<td><a
href="http://highscalability.com/blog/2012/2/13/tumblr-architecture-15-billion-page-views-a-month-and-harder.html">15
billion page views a month</a></td>
</tr>
<tr>
<td>Twitter</td>
<td><a
href="http://highscalability.com/scaling-twitter-making-twitter-10000-percent-faster">Making
Twitter 10000 percent faster</a><br/><a
href="http://highscalability.com/blog/2011/12/19/how-twitter-stores-250-million-tweets-a-day-using-mysql.html">Storing
250 million tweets a day using MySQL</a><br/><a
href="http://highscalability.com/blog/2013/7/8/the-architecture-twitter-uses-to-deal-with-150m-active-users.html">150M
active users, 300K QPS, a 22 MB/S firehose</a><br/><a
href="https://www.infoq.com/presentations/Twitter-Timeline-Scalability">Timelines
at scale</a><br/><a
href="https://www.youtube.com/watch?v=5cKTP36HVgI">Big and small data at
Twitter</a><br/><a
href="https://www.youtube.com/watch?v=z8LU0Cj6BOU">Operations at
Twitter: scaling beyond 100 million users</a><br/><a
href="http://highscalability.com/blog/2016/4/20/how-twitter-handles-3000-images-per-second.html">How
Twitter Handles 3,000 Images Per Second</a></td>
</tr>
<tr>
<td>Uber</td>
<td><a
href="http://highscalability.com/blog/2015/9/14/how-uber-scales-their-real-time-market-platform.html">How
Uber scales their real-time market platform</a><br/><a
href="http://highscalability.com/blog/2016/10/12/lessons-learned-from-scaling-uber-to-2000-engineers-1000-ser.html">Lessons
Learned From Scaling Uber To 2000 Engineers, 1000 Services, And 8000 Git
Repositories</a></td>
</tr>
<tr>
<td>WhatsApp</td>
<td><a
href="http://highscalability.com/blog/2014/2/26/the-whatsapp-architecture-facebook-bought-for-19-billion.html">The
WhatsApp architecture Facebook bought for $19 billion</a></td>
</tr>
<tr>
<td>YouTube</td>
<td><a href="https://www.youtube.com/watch?v=w5WVu624fY8" target="_blank">YouTube
scalability</a><br/><a
href="http://highscalability.com/youtube-architecture">YouTube
architecture</a></td>
</tr>
</tbody>
</table>
<h3 id="company-engineering-blogs">Company engineering blogs</h3>
<blockquote>
<p>Architectures for companies you are interviewing with.</p>
<p>Questions you encounter might be from the same domain.</p>
</blockquote>
<ul>
<li><a href="http://nerds.airbnb.com/" target="_blank">Airbnb Engineering</a></li>
<li><a href="https://developer.atlassian.com/blog/" target="_blank">Atlassian
Developers</a></li>
<li><a href="https://aws.amazon.com/blogs/aws/" target="_blank">AWS Blog</a></li>
<li><a href="http://word.bitly.com/" target="_blank">Bitly Engineering Blog</a></li>
<li><a href="https://blog.box.com/blog/category/engineering" target="_blank">Box
Blogs</a></li>
<li><a href="http://blog.cloudera.com/" target="_blank">Cloudera Developer Blog</a></li>
<li><a href="https://tech.dropbox.com/" target="_blank">Dropbox Tech Blog</a></li>
<li><a href="https://www.quora.com/q/quoraengineering" target="_blank">Engineering at
Quora</a></li>
<li><a href="http://www.ebaytechblog.com/" target="_blank">Ebay Tech Blog</a></li>
<li><a href="https://blog.evernote.com/tech/" target="_blank">Evernote Tech
Blog</a></li>
<li><a href="http://codeascraft.com/" target="_blank">Etsy Code as Craft</a></li>
<li><a href="https://www.facebook.com/Engineering" target="_blank">Facebook
Engineering</a></li>
<li><a href="http://code.flickr.net/" target="_blank">Flickr Code</a></li>
<li><a href="http://engineering.foursquare.com/" target="_blank">Foursquare Engineering
Blog</a></li>
<li><a href="https://github.blog/category/engineering" target="_blank">GitHub
Engineering Blog</a></li>
<li><a href="http://googleresearch.blogspot.com/" target="_blank">Google Research
Blog</a></li>
<li><a href="https://engineering.groupon.com/" target="_blank">Groupon Engineering
Blog</a></li>
<li><a href="https://engineering.heroku.com/" target="_blank">Heroku Engineering
Blog</a></li>
<li><a href="http://product.hubspot.com/blog/topic/engineering" target="_blank">Hubspot
Engineering Blog</a></li>
<li><a href="http://highscalability.com/" target="_blank">High Scalability</a></li>
<li><a href="http://instagram-engineering.tumblr.com/" target="_blank">Instagram
Engineering</a></li>
<li><a href="https://software.intel.com/en-us/blogs/" target="_blank">Intel Software
Blog</a></li>
<li><a href="https://blogs.janestreet.com/category/ocaml/" target="_blank">Jane Street
Tech Blog</a></li>
<li><a href="http://engineering.linkedin.com/blog" target="_blank">LinkedIn
Engineering</a></li>
<li><a href="https://engineering.microsoft.com/" target="_blank">Microsoft
Engineering</a></li>
<li><a
href="https://blogs.msdn.microsoft.com/pythonengineering/">Microsoft
Python Engineering</a></li>
<li><a href="http://techblog.netflix.com/" target="_blank">Netflix Tech Blog</a></li>
<li><a href="https://medium.com/paypal-engineering" target="_blank">Paypal Developer
Blog</a></li>
<li><a href="https://medium.com/@Pinterest_Engineering" target="_blank">Pinterest
Engineering Blog</a></li>
<li><a href="http://www.redditblog.com/" target="_blank">Reddit Blog</a></li>
<li><a
href="https://developer.salesforce.com/blogs/engineering/">Salesforce
Engineering Blog</a></li>
<li><a href="https://slack.engineering/" target="_blank">Slack Engineering Blog</a></li>
<li><a href="https://labs.spotify.com/" target="_blank">Spotify Labs</a></li>
<li><a href="https://stripe.com/blog/engineering" target="_blank">Stripe Engineering
Blog</a></li>
<li><a href="http://www.twilio.com/engineering" target="_blank">Twilio Engineering
Blog</a></li>
<li><a href="https://blog.twitter.com/engineering/" target="_blank">Twitter
Engineering</a></li>
<li><a href="http://eng.uber.com/" target="_blank">Uber Engineering Blog</a></li>
<li><a href="http://yahooeng.tumblr.com/" target="_blank">Yahoo Engineering
Blog</a></li>
<li><a href="http://engineeringblog.yelp.com/" target="_blank">Yelp Engineering
Blog</a></li>
<li><a href="https://www.zynga.com/blogs/engineering" target="_blank">Zynga Engineering
Blog</a></li>
</ul>
<h4 id="sources-and-further-reading-15">Source(s) and further
reading</h4>
<p>Looking to add a blog? To avoid duplicating work, consider adding
your company blog to the following repo:</p>
<ul>
<li><a
href="https://github.com/kilimchoi/engineering-blogs">kilimchoi/engineering-blogs</a></li>
</ul>
<h2 id="under-development">Under development</h2>
<p>Interested in adding a section or helping complete one in-progress?
<a href="#contributing">Contribute</a>!</p>
<ul>
<li>Distributed computing with MapReduce</li>
<li>Consistent hashing</li>
<li>Scatter gather</li>
<li><a href="#contributing">Contribute</a></li>
</ul>
<h2 id="credits">Credits</h2>
<p>Credits and sources are provided throughout this repo.</p>
<p>Special thanks to:</p>
<ul>
<li><a
href="http://www.hiredintech.com/system-design/the-system-design-process/">Hired
in tech</a></li>
<li><a href="https://www.amazon.com/dp/0984782850/" target="_blank">Cracking the coding
interview</a></li>
<li><a href="http://highscalability.com/" target="_blank">High scalability</a></li>
<li><a
href="https://github.com/checkcheckzz/system-design-interview">checkcheckzz/system-design-interview</a></li>
<li><a
href="https://github.com/shashank88/system_design">shashank88/system_design</a></li>
<li><a
href="https://github.com/mmcgrana/services-engineering">mmcgrana/services-engineering</a></li>
<li><a
href="https://gist.github.com/vasanthk/485d1c25737e8e72759f">System
design cheat sheet</a></li>
<li><a href="http://dancres.github.io/Pages/" target="_blank">A distributed systems
reading list</a></li>
<li><a
href="http://www.puncsky.com/blog/2016-02-13-crack-the-system-design-interview">Cracking
the system design interview</a></li>
</ul>
<h2 id="contact-info">Contact info</h2>
<p>Feel free to contact me to discuss any issues, questions, or
comments.</p>
<p>My contact info can be found on my <a
href="https://github.com/donnemartin">GitHub page</a>.</p>
<h2 id="license">License</h2>
<p><em>I am providing code and resources in this repository to you under
an open source license. Because this is my personal repository, the
license you receive to my code and resources is from me and not my
employer (Facebook).</em></p>
<pre><code>Copyright 2017 Donne Martin

Creative Commons Attribution 4.0 International License (CC BY 4.0)

http://creativecommons.org/licenses/by/4.0/</code></pre>
<h1 id="contributing-1">CONTRIBUTING</h1>
<h1 id="contributing-2">Contributing</h1>
<p>Contributions are welcome!</p>
<p><strong>Please carefully read this page to make the code review
process go as smoothly as possible and to maximize the likelihood of
your contribution being merged.</strong></p>
<h2 id="bug-reports">Bug Reports</h2>
<p>For bug reports or requests <a
href="https://github.com/donnemartin/system-design-primer/issues">submit
an issue</a>.</p>
<h2 id="pull-requests">Pull Requests</h2>
<p>The preferred way to contribute is to fork the <a
href="https://github.com/donnemartin/system-design-primer">main
repository</a> on GitHub.</p>
<ol type="1">
<li><p>Fork the <a
href="https://github.com/donnemartin/system-design-primer">main
repository</a>. Click on the ‘Fork’ button near the top of the page.
This creates a copy of the code under your account on the GitHub
server.</p></li>
<li><p>Clone this copy to your local disk:</p>
<pre><code> $ git clone git@github.com:YourLogin/system-design-primer.git
 $ cd system-design-primer</code></pre></li>
<li><p>Create a branch to hold your changes and start making changes.
Don’t work in the <code>master</code> branch!</p>
<pre><code> $ git checkout -b my-feature</code></pre></li>
<li><p>Work on this copy on your computer using Git to do the version
control. When you’re done editing, run the following to record your
changes in Git:</p>
<pre><code> $ git add modified_files
 $ git commit</code></pre></li>
<li><p>Push your changes to GitHub with:</p>
<pre><code> $ git push -u origin my-feature</code></pre></li>
<li><p>Finally, go to the web page of your fork of the
<code>system-design-primer</code> repo and click ‘Pull Request’ to send
your changes for review.</p></li>
</ol>
<h3 id="github-pull-requests-docs">GitHub Pull Requests Docs</h3>
<p>If you are not familiar with pull requests, review the <a
href="https://help.github.com/articles/using-pull-requests/">pull
request docs</a>.</p>
<h2 id="translations">Translations</h2>
<p>We’d like for the guide to be available in many languages. Here is
the process for maintaining translations:</p>
<ul>
<li>This original version and content of the guide is maintained in
English.</li>
<li>Translations follow the content of the original. Contributors must
speak at least some English, so that translations do not diverge.</li>
<li>Each translation has a maintainer to update the translation as the
original evolves and to review others’ changes. This doesn’t require a
lot of time, but a review by the maintainer is important to maintain
quality.</li>
</ul>
<p>See <a href="#translations">Translations</a>.</p>
<h3 id="changes-to-translations">Changes to translations</h3>
<ul>
<li>Changes to content should be made to the English version first, and
then translated to each other language.</li>
<li>Changes that improve translations should be made directly on the
file for that language. Pull requests should only modify one language at
a time.</li>
<li>Submit a pull request with changes to the file in that language.
Each language has a maintainer, who reviews changes in that language.
Then the primary maintainer <a
href="https://github.com/donnemartin"><span class="citation"
data-cites="donnemartin">@donnemartin</span></a> merges it in.</li>
<li>Prefix pull requests and issues with language codes if they are for
that translation only, e.g. “es: Improve grammar”, so maintainers can
find them easily.</li>
<li>Tag the translation maintainer for a code review, see the list of <a
href="#translations">translation maintainers</a>.
<ul>
<li>You will need to get a review from a native speaker (preferably the
language maintainer) before your pull request is merged.</li>
</ul></li>
</ul>
<h3 id="adding-translations-to-new-languages">Adding translations to new
languages</h3>
<p>Translations to new languages are always welcome! Keep in mind a
translation must be maintained.</p>
<ul>
<li>Do you have time to be a maintainer for a new language? Please see
the list of <a href="#translations">translations</a> and tell us so we
know we can count on you in the future.</li>
<li>Check the <a href="#translations">translations</a>, issues, and pull
requests to see if a translation is in progress or stalled. If it’s in
progress, offer to help. If it’s stalled, consider becoming the
maintainer if you can commit to it.</li>
<li>If a translation has not yet been started, file an issue for your
language so people know you are working on it and we’ll coordinate.
Confirm you are native level in the language and are willing to maintain
the translation, so it’s not orphaned.</li>
<li>To get started, fork the repo, then submit a pull request to the
main repo with the single file README-xx.md added, where xx is the
language code. Use standard <a
href="https://www.w3.org/International/articles/language-tags/">IETF
language tags</a>, i.e. the same as is used by Wikipedia, <em>not</em>
the code for a single country. These are usually just the two-letter
lowercase code, for example, <code>fr</code> for French and
<code>uk</code> for Ukrainian (not <code>ua</code>, which is for the
country). For languages that have variations, use the shortest tag, such
as <code>zh-Hant</code>.</li>
<li>Feel free to invite friends to help your original translation by
having them fork your repo, then merging their pull requests to your
forked repo. Translations are difficult and usually have errors that
others need to find.</li>
<li>Add links to your translation at the top of every README-XX.md file.
For consistency, the link should be added in alphabetical order by ISO
code, and the anchor text should be in the native language.</li>
<li>When you’ve fully translated the English README.md, comment on the
pull request in the main repo that it’s ready to be merged.
<ul>
<li>You’ll need to have a complete and reviewed translation of the
English README.md before your translation will be merged into the
<code>master</code> branch.</li>
<li>Once accepted, your pull request will be squashed into a single
commit into the <code>master</code> branch.</li>
</ul></li>
</ul>
<h3 id="translation-template-credits">Translation template credits</h3>
<p>Thanks to <a
href="https://github.com/jlevy/the-art-of-command-line">The Art of
Command Line</a> for the translation template.</p>
<h1 id="system-design-pastebin">System Design: Pastebin</h1>
<h1 id="design-pastebin.com-or-bit.ly-1">Design Pastebin.com (or
Bit.ly)</h1>
<p><em>Note: This document links directly to relevant areas found in the
<a
href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system
design topics</a> to avoid duplication. Refer to the linked content for
general talking points, tradeoffs, and alternatives.</em></p>
<p><strong>Design Bit.ly</strong> - is a similar question, except
pastebin requires storing the paste contents instead of the original
unshortened url.</p>
<h2 id="step-1-outline-use-cases-and-constraints">Step 1: Outline use
cases and constraints</h2>
<blockquote>
<p>Gather requirements and scope the problem. Ask questions to clarify
use cases and constraints. Discuss assumptions.</p>
</blockquote>
<p>Without an interviewer to address clarifying questions, we’ll define
some use cases and constraints.</p>
<h3 id="use-cases">Use cases</h3>
<h4
id="well-scope-the-problem-to-handle-only-the-following-use-cases">We’ll
scope the problem to handle only the following use cases</h4>
<ul>
<li><strong>User</strong> enters a block of text and gets a randomly
generated link
<ul>
<li>Expiration
<ul>
<li>Default setting does not expire</li>
<li>Can optionally set a timed expiration</li>
</ul></li>
</ul></li>
<li><strong>User</strong> enters a paste’s url and views the
contents</li>
<li><strong>User</strong> is anonymous</li>
<li><strong>Service</strong> tracks analytics of pages
<ul>
<li>Monthly visit stats</li>
</ul></li>
<li><strong>Service</strong> deletes expired pastes</li>
<li><strong>Service</strong> has high availability</li>
</ul>
<h4 id="out-of-scope">Out of scope</h4>
<ul>
<li><strong>User</strong> registers for an account
<ul>
<li><strong>User</strong> verifies email</li>
</ul></li>
<li><strong>User</strong> logs into a registered account
<ul>
<li><strong>User</strong> edits the document</li>
</ul></li>
<li><strong>User</strong> can set visibility</li>
<li><strong>User</strong> can set the shortlink</li>
</ul>
<h3 id="constraints-and-assumptions">Constraints and assumptions</h3>
<h4 id="state-assumptions">State assumptions</h4>
<ul>
<li>Traffic is not evenly distributed</li>
<li>Following a short link should be fast</li>
<li>Pastes are text only</li>
<li>Page view analytics do not need to be realtime</li>
<li>10 million users</li>
<li>10 million paste writes per month</li>
<li>100 million paste reads per month</li>
<li>10:1 read to write ratio</li>
</ul>
<h4 id="calculate-usage">Calculate usage</h4>
<p><strong>Clarify with your interviewer if you should run
back-of-the-envelope usage calculations.</strong></p>
<ul>
<li>Size per paste
<ul>
<li>1 KB content per paste</li>
<li><code>shortlink</code> - 7 bytes</li>
<li><code>expiration_length_in_minutes</code> - 4 bytes</li>
<li><code>created_at</code> - 5 bytes</li>
<li><code>paste_path</code> - 255 bytes</li>
<li>total = ~1.27 KB</li>
</ul></li>
<li>12.7 GB of new paste content per month
<ul>
<li>1.27 KB per paste * 10 million pastes per month</li>
<li>~450 GB of new paste content in 3 years</li>
<li>360 million shortlinks in 3 years</li>
<li>Assume most are new pastes instead of updates to existing ones</li>
</ul></li>
<li>4 paste writes per second on average</li>
<li>40 read requests per second on average</li>
</ul>
<p>Handy conversion guide:</p>
<ul>
<li>2.5 million seconds per month</li>
<li>1 request per second = 2.5 million requests per month</li>
<li>40 requests per second = 100 million requests per month</li>
<li>400 requests per second = 1 billion requests per month</li>
</ul>
<h2 id="step-2-create-a-high-level-design-1">Step 2: Create a high level
design</h2>
<blockquote>
<p>Outline a high level design with all important components.</p>
</blockquote>
<figure>
<img src="http://i.imgur.com/BKsBnmG.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h2 id="step-3-design-core-components-1">Step 3: Design core
components</h2>
<blockquote>
<p>Dive into details for each core component.</p>
</blockquote>
<h3
id="use-case-user-enters-a-block-of-text-and-gets-a-randomly-generated-link">Use
case: User enters a block of text and gets a randomly generated
link</h3>
<p>We could use a <a
href="https://github.com/donnemartin/system-design-primer#relational-database-management-system-rdbms">relational
database</a> as a large hash table, mapping the generated url to a file
server and path containing the paste file.</p>
<p>Instead of managing a file server, we could use a managed
<strong>Object Store</strong> such as Amazon S3 or a <a
href="https://github.com/donnemartin/system-design-primer#document-store">NoSQL
document store</a>.</p>
<p>An alternative to a relational database acting as a large hash table,
we could use a <a
href="https://github.com/donnemartin/system-design-primer#key-value-store">NoSQL
key-value store</a>. We should discuss the <a
href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">tradeoffs
between choosing SQL or NoSQL</a>. The following discussion uses the
relational database approach.</p>
<ul>
<li>The <strong>Client</strong> sends a create paste request to the
<strong>Web Server</strong>, running as a <a
href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">reverse
proxy</a></li>
<li>The <strong>Web Server</strong> forwards the request to the
<strong>Write API</strong> server</li>
<li>The <strong>Write API</strong> server does the following:
<ul>
<li>Generates a unique url
<ul>
<li>Checks if the url is unique by looking at the <strong>SQL
Database</strong> for a duplicate</li>
<li>If the url is not unique, it generates another url</li>
<li>If we supported a custom url, we could use the user-supplied (also
check for a duplicate)</li>
</ul></li>
<li>Saves to the <strong>SQL Database</strong> <code>pastes</code>
table</li>
<li>Saves the paste data to the <strong>Object Store</strong></li>
<li>Returns the url</li>
</ul></li>
</ul>
<p><strong>Clarify with your interviewer how much code you are expected
to write</strong>.</p>
<p>The <code>pastes</code> table could have the following structure:</p>
<pre><code>shortlink char(7) NOT NULL
expiration_length_in_minutes int NOT NULL
created_at datetime NOT NULL
paste_path varchar(255) NOT NULL
PRIMARY KEY(shortlink)</code></pre>
<p>Setting the primary key to be based on the <code>shortlink</code>
column creates an <a
href="https://github.com/donnemartin/system-design-primer#use-good-indices">index</a>
that the database uses to enforce uniqueness. We’ll create an additional
index on <code>created_at</code> to speed up lookups (log-time instead
of scanning the entire table) and to keep the data in memory. Reading 1
MB sequentially from memory takes about 250 microseconds, while reading
from SSD takes 4x and from disk takes 80x
longer.<sup><a href=https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know>1</a></sup></p>
<p>To generate the unique url, we could:</p>
<ul>
<li>Take the <a
href="https://en.wikipedia.org/wiki/MD5"><strong>MD5</strong></a> hash
of the user’s ip_address + timestamp
<ul>
<li>MD5 is a widely used hashing function that produces a 128-bit hash
value</li>
<li>MD5 is uniformly distributed</li>
<li>Alternatively, we could also take the MD5 hash of randomly-generated
data</li>
</ul></li>
<li><a
href="https://www.kerstner.at/2012/07/shortening-strings-using-base-62-encoding/"><strong>Base
62</strong></a> encode the MD5 hash
<ul>
<li>Base 62 encodes to <code>[a-zA-Z0-9]</code> which works well for
urls, eliminating the need for escaping special characters</li>
<li>There is only one hash result for the original input and Base 62 is
deterministic (no randomness involved)</li>
<li>Base 64 is another popular encoding but provides issues for urls
because of the additional <code>+</code> and <code>/</code>
characters</li>
<li>The following <a
href="http://stackoverflow.com/questions/742013/how-to-code-a-url-shortener">Base
62 pseudocode</a> runs in O(k) time where k is the number of digits =
7:</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> base_encode(num, base<span class="op">=</span><span class="dv">62</span>):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    digits <span class="op">=</span> []</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> num <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>      remainder <span class="op">=</span> modulo(num, base)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>      digits.push(remainder)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>      num <span class="op">=</span> divide(num, base)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    digits <span class="op">=</span> digits.reverse</span></code></pre></div>
<ul>
<li>Take the first 7 characters of the output, which results in 62^7
possible values and should be sufficient to handle our constraint of 360
million shortlinks in 3 years:</li>
</ul>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> base_encode(md5(ip_address<span class="op">+</span>timestamp))[:URL_LENGTH]</span></code></pre></div>
<p>We’ll use a public <a
href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest"><strong>REST
API</strong></a>:</p>
<pre><code>$ curl -X POST --data &#39;{ &quot;expiration_length_in_minutes&quot;: &quot;60&quot;, \
    &quot;paste_contents&quot;: &quot;Hello World!&quot; }&#39; https://pastebin.com/api/v1/paste</code></pre>
<p>Response:</p>
<pre><code>{
    &quot;shortlink&quot;: &quot;foobar&quot;
}</code></pre>
<p>For internal communications, we could use <a
href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">Remote
Procedure Calls</a>.</p>
<h3 id="use-case-user-enters-a-pastes-url-and-views-the-contents">Use
case: User enters a paste’s url and views the contents</h3>
<ul>
<li>The <strong>Client</strong> sends a get paste request to the
<strong>Web Server</strong></li>
<li>The <strong>Web Server</strong> forwards the request to the
<strong>Read API</strong> server</li>
<li>The <strong>Read API</strong> server does the following:
<ul>
<li>Checks the <strong>SQL Database</strong> for the generated url
<ul>
<li>If the url is in the <strong>SQL Database</strong>, fetch the paste
contents from the <strong>Object Store</strong></li>
<li>Else, return an error message for the user</li>
</ul></li>
</ul></li>
</ul>
<p>REST API:</p>
<pre><code>$ curl https://pastebin.com/api/v1/paste?shortlink=foobar</code></pre>
<p>Response:</p>
<pre><code>{
    &quot;paste_contents&quot;: &quot;Hello World&quot;
    &quot;created_at&quot;: &quot;YYYY-MM-DD HH:MM:SS&quot;
    &quot;expiration_length_in_minutes&quot;: &quot;60&quot;
}</code></pre>
<h3 id="use-case-service-tracks-analytics-of-pages">Use case: Service
tracks analytics of pages</h3>
<p>Since realtime analytics are not a requirement, we could simply
<strong>MapReduce</strong> the <strong>Web Server</strong> logs to
generate hit counts.</p>
<p><strong>Clarify with your interviewer how much code you are expected
to write</strong>.</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HitCounts(MRJob):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> extract_url(<span class="va">self</span>, line):</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Extract the generated url from the log line.&quot;&quot;&quot;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> extract_year_month(<span class="va">self</span>, line):</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Return the year and month portions of the timestamp.&quot;&quot;&quot;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mapper(<span class="va">self</span>, _, line):</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Parse each log line, extract and transform relevant lines.</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Emit key value pairs of the form:</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co">        (2016-01, url0), 1</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co">        (2016-01, url0), 1</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co">        (2016-01, url1), 1</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        url <span class="op">=</span> <span class="va">self</span>.extract_url(line)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        period <span class="op">=</span> <span class="va">self</span>.extract_year_month(line)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> (period, url), <span class="dv">1</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reducer(<span class="va">self</span>, key, values):</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Sum values for each key.</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="co">        (2016-01, url0), 2</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="co">        (2016-01, url1), 1</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> key, <span class="bu">sum</span>(values)</span></code></pre></div>
<h3 id="use-case-service-deletes-expired-pastes">Use case: Service
deletes expired pastes</h3>
<p>To delete expired pastes, we could just scan the <strong>SQL
Database</strong> for all entries whose expiration timestamp are older
than the current timestamp. All expired entries would then be deleted
(or marked as expired) from the table.</p>
<h2 id="step-4-scale-the-design-1">Step 4: Scale the design</h2>
<blockquote>
<p>Identify and address bottlenecks, given the constraints.</p>
</blockquote>
<figure>
<img src="http://i.imgur.com/4edXG0T.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<p><strong>Important: Do not simply jump right into the final design
from the initial design!</strong></p>
<p>State you would do this iteratively: 1) <strong>Benchmark/Load
Test</strong>, 2) <strong>Profile</strong> for bottlenecks 3) address
bottlenecks while evaluating alternatives and trade-offs, and 4) repeat.
See <a href="#scaling-aws">Design a system that scales to millions of
users on AWS</a> as a sample on how to iteratively scale the initial
design.</p>
<p>It’s important to discuss what bottlenecks you might encounter with
the initial design and how you might address each of them. For example,
what issues are addressed by adding a <strong>Load Balancer</strong>
with multiple <strong>Web Servers</strong>? <strong>CDN</strong>?
<strong>Master-Slave Replicas</strong>? What are the alternatives and
<strong>Trade-Offs</strong> for each?</p>
<p>We’ll introduce some components to complete the design and to address
scalability issues. Internal load balancers are not shown to reduce
clutter.</p>
<p><em>To avoid repeating discussions</em>, refer to the following <a
href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system
design topics</a> for main talking points, tradeoffs, and
alternatives:</p>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#domain-name-system">DNS</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#content-delivery-network">CDN</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#load-balancer">Load
balancer</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#horizontal-scaling">Horizontal
scaling</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">Web
server (reverse proxy)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#application-layer">API
server (application layer)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#cache">Cache</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#relational-database-management-system-rdbms">Relational
database management system (RDBMS)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#fail-over">SQL
write master-slave failover</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#master-slave-replication">Master-slave
replication</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#consistency-patterns">Consistency
patterns</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#availability-patterns">Availability
patterns</a></li>
</ul>
<p>The <strong>Analytics Database</strong> could use a data warehousing
solution such as Amazon Redshift or Google BigQuery.</p>
<p>An <strong>Object Store</strong> such as Amazon S3 can comfortably
handle the constraint of 12.7 GB of new content per month.</p>
<p>To address the 40 <em>average</em> read requests per second (higher
at peak), traffic for popular content should be handled by the
<strong>Memory Cache</strong> instead of the database. The
<strong>Memory Cache</strong> is also useful for handling the unevenly
distributed traffic and traffic spikes. The <strong>SQL Read
Replicas</strong> should be able to handle the cache misses, as long as
the replicas are not bogged down with replicating writes.</p>
<p>4 <em>average</em> paste writes per second (with higher at peak)
should be do-able for a single <strong>SQL Write Master-Slave</strong>.
Otherwise, we’ll need to employ additional SQL scaling patterns:</p>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#federation">Federation</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sharding">Sharding</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#denormalization">Denormalization</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-tuning">SQL
Tuning</a></li>
</ul>
<p>We should also consider moving some data to a <strong>NoSQL
Database</strong>.</p>
<h2 id="additional-talking-points">Additional talking points</h2>
<blockquote>
<p>Additional topics to dive into, depending on the problem scope and
time remaining.</p>
</blockquote>
<h4 id="nosql-1">NoSQL</h4>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#key-value-store">Key-value
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#document-store">Document
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#wide-column-store">Wide
column store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#graph-database">Graph
database</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">SQL
vs NoSQL</a></li>
</ul>
<h3 id="caching">Caching</h3>
<ul>
<li>Where to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#client-caching">Client
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#cdn-caching">CDN
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#web-server-caching">Web
server caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#database-caching">Database
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#application-caching">Application
caching</a></li>
</ul></li>
<li>What to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-database-query-level">Caching
at the database query level</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-object-level">Caching
at the object level</a></li>
</ul></li>
<li>When to update the cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#cache-aside">Cache-aside</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-through">Write-through</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-behind-write-back">Write-behind
(write-back)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#refresh-ahead">Refresh
ahead</a></li>
</ul></li>
</ul>
<h3 id="asynchronism-and-microservices">Asynchronism and
microservices</h3>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#message-queues">Message
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#task-queues">Task
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#back-pressure">Back
pressure</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#microservices">Microservices</a></li>
</ul>
<h3 id="communications">Communications</h3>
<ul>
<li>Discuss tradeoffs:
<ul>
<li>External communication with clients - <a
href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest">HTTP
APIs following REST</a></li>
<li>Internal communications - <a
href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">RPC</a></li>
</ul></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#service-discovery">Service
discovery</a></li>
</ul>
<h3 id="security-1">Security</h3>
<p>Refer to the <a
href="https://github.com/donnemartin/system-design-primer#security">security
section</a>.</p>
<h3 id="latency-numbers">Latency numbers</h3>
<p>See <a
href="https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know">Latency
numbers every programmer should know</a>.</p>
<h3 id="ongoing">Ongoing</h3>
<ul>
<li>Continue benchmarking and monitoring your system to address
bottlenecks as they come up</li>
<li>Scaling is an iterative process</li>
</ul>
<h1 id="system-design-twitter">System Design: Twitter</h1>
<h1 id="design-the-twitter-timeline-and-search">Design the Twitter
timeline and search</h1>
<p><em>Note: This document links directly to relevant areas found in the
<a
href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system
design topics</a> to avoid duplication. Refer to the linked content for
general talking points, tradeoffs, and alternatives.</em></p>
<p><strong>Design the Facebook feed</strong> and <strong>Design Facebook
search</strong> are similar questions.</p>
<h2 id="step-1-outline-use-cases-and-constraints-1">Step 1: Outline use
cases and constraints</h2>
<blockquote>
<p>Gather requirements and scope the problem. Ask questions to clarify
use cases and constraints. Discuss assumptions.</p>
</blockquote>
<p>Without an interviewer to address clarifying questions, we’ll define
some use cases and constraints.</p>
<h3 id="use-cases-1">Use cases</h3>
<h4
id="well-scope-the-problem-to-handle-only-the-following-use-cases-1">We’ll
scope the problem to handle only the following use cases</h4>
<ul>
<li><strong>User</strong> posts a tweet
<ul>
<li><strong>Service</strong> pushes tweets to followers, sending push
notifications and emails</li>
</ul></li>
<li><strong>User</strong> views the user timeline (activity from the
user)</li>
<li><strong>User</strong> views the home timeline (activity from people
the user is following)</li>
<li><strong>User</strong> searches keywords</li>
<li><strong>Service</strong> has high availability</li>
</ul>
<h4 id="out-of-scope-1">Out of scope</h4>
<ul>
<li><strong>Service</strong> pushes tweets to the Twitter Firehose and
other streams</li>
<li><strong>Service</strong> strips out tweets based on users’
visibility settings
<ul>
<li>Hide <span class="citation" data-cites="reply">@reply</span> if the
user is not also following the person being replied to</li>
<li>Respect ‘hide retweets’ setting</li>
</ul></li>
<li>Analytics</li>
</ul>
<h3 id="constraints-and-assumptions-1">Constraints and assumptions</h3>
<h4 id="state-assumptions-1">State assumptions</h4>
<p>General</p>
<ul>
<li>Traffic is not evenly distributed</li>
<li>Posting a tweet should be fast
<ul>
<li>Fanning out a tweet to all of your followers should be fast, unless
you have millions of followers</li>
</ul></li>
<li>100 million active users</li>
<li>500 million tweets per day or 15 billion tweets per month
<ul>
<li>Each tweet averages a fanout of 10 deliveries</li>
<li>5 billion total tweets delivered on fanout per day</li>
<li>150 billion tweets delivered on fanout per month</li>
</ul></li>
<li>250 billion read requests per month</li>
<li>10 billion searches per month</li>
</ul>
<p>Timeline</p>
<ul>
<li>Viewing the timeline should be fast</li>
<li>Twitter is more read heavy than write heavy
<ul>
<li>Optimize for fast reads of tweets</li>
</ul></li>
<li>Ingesting tweets is write heavy</li>
</ul>
<p>Search</p>
<ul>
<li>Searching should be fast</li>
<li>Search is read-heavy</li>
</ul>
<h4 id="calculate-usage-1">Calculate usage</h4>
<p><strong>Clarify with your interviewer if you should run
back-of-the-envelope usage calculations.</strong></p>
<ul>
<li>Size per tweet:
<ul>
<li><code>tweet_id</code> - 8 bytes</li>
<li><code>user_id</code> - 32 bytes</li>
<li><code>text</code> - 140 bytes</li>
<li><code>media</code> - 10 KB average</li>
<li>Total: ~10 KB</li>
</ul></li>
<li>150 TB of new tweet content per month
<ul>
<li>10 KB per tweet * 500 million tweets per day * 30 days per
month</li>
<li>5.4 PB of new tweet content in 3 years</li>
</ul></li>
<li>100 thousand read requests per second
<ul>
<li>250 billion read requests per month * (400 requests per second / 1
billion requests per month)</li>
</ul></li>
<li>6,000 tweets per second
<ul>
<li>15 billion tweets per month * (400 requests per second / 1 billion
requests per month)</li>
</ul></li>
<li>60 thousand tweets delivered on fanout per second
<ul>
<li>150 billion tweets delivered on fanout per month * (400 requests per
second / 1 billion requests per month)</li>
</ul></li>
<li>4,000 search requests per second
<ul>
<li>10 billion searches per month * (400 requests per second / 1 billion
requests per month)</li>
</ul></li>
</ul>
<p>Handy conversion guide:</p>
<ul>
<li>2.5 million seconds per month</li>
<li>1 request per second = 2.5 million requests per month</li>
<li>40 requests per second = 100 million requests per month</li>
<li>400 requests per second = 1 billion requests per month</li>
</ul>
<h2 id="step-2-create-a-high-level-design-2">Step 2: Create a high level
design</h2>
<blockquote>
<p>Outline a high level design with all important components.</p>
</blockquote>
<figure>
<img src="http://i.imgur.com/48tEA2j.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h2 id="step-3-design-core-components-2">Step 3: Design core
components</h2>
<blockquote>
<p>Dive into details for each core component.</p>
</blockquote>
<h3 id="use-case-user-posts-a-tweet">Use case: User posts a tweet</h3>
<p>We could store the user’s own tweets to populate the user timeline
(activity from the user) in a <a
href="https://github.com/donnemartin/system-design-primer#relational-database-management-system-rdbms">relational
database</a>. We should discuss the <a
href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">use
cases and tradeoffs between choosing SQL or NoSQL</a>.</p>
<p>Delivering tweets and building the home timeline (activity from
people the user is following) is trickier. Fanning out tweets to all
followers (60 thousand tweets delivered on fanout per second) will
overload a traditional <a
href="https://github.com/donnemartin/system-design-primer#relational-database-management-system-rdbms">relational
database</a>. We’ll probably want to choose a data store with fast
writes such as a <strong>NoSQL database</strong> or <strong>Memory
Cache</strong>. Reading 1 MB sequentially from memory takes about 250
microseconds, while reading from SSD takes 4x and from disk takes 80x
longer.<sup><a href=https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know>1</a></sup></p>
<p>We could store media such as photos or videos on an <strong>Object
Store</strong>.</p>
<ul>
<li>The <strong>Client</strong> posts a tweet to the <strong>Web
Server</strong>, running as a <a
href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">reverse
proxy</a></li>
<li>The <strong>Web Server</strong> forwards the request to the
<strong>Write API</strong> server</li>
<li>The <strong>Write API</strong> stores the tweet in the user’s
timeline on a <strong>SQL database</strong></li>
<li>The <strong>Write API</strong> contacts the <strong>Fan Out
Service</strong>, which does the following:
<ul>
<li>Queries the <strong>User Graph Service</strong> to find the user’s
followers stored in the <strong>Memory Cache</strong></li>
<li>Stores the tweet in the <em>home timeline of the user’s
followers</em> in a <strong>Memory Cache</strong>
<ul>
<li>O(n) operation: 1,000 followers = 1,000 lookups and inserts</li>
</ul></li>
<li>Stores the tweet in the <strong>Search Index Service</strong> to
enable fast searching</li>
<li>Stores media in the <strong>Object Store</strong></li>
<li>Uses the <strong>Notification Service</strong> to send out push
notifications to followers:
<ul>
<li>Uses a <strong>Queue</strong> (not pictured) to asynchronously send
out notifications</li>
</ul></li>
</ul></li>
</ul>
<p><strong>Clarify with your interviewer how much code you are expected
to write</strong>.</p>
<p>If our <strong>Memory Cache</strong> is Redis, we could use a native
Redis list with the following structure:</p>
<pre><code>           tweet n+2                   tweet n+1                   tweet n
| 8 bytes   8 bytes  1 byte | 8 bytes   8 bytes  1 byte | 8 bytes   8 bytes  1 byte |
| tweet_id  user_id  meta   | tweet_id  user_id  meta   | tweet_id  user_id  meta   |</code></pre>
<p>The new tweet would be placed in the <strong>Memory Cache</strong>,
which populates the user’s home timeline (activity from people the user
is following).</p>
<p>We’ll use a public <a
href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest"><strong>REST
API</strong></a>:</p>
<pre><code>$ curl -X POST --data &#39;{ &quot;user_id&quot;: &quot;123&quot;, &quot;auth_token&quot;: &quot;ABC123&quot;, \
    &quot;status&quot;: &quot;hello world!&quot;, &quot;media_ids&quot;: &quot;ABC987&quot; }&#39; \
    https://twitter.com/api/v1/tweet</code></pre>
<p>Response:</p>
<pre><code>{
    &quot;created_at&quot;: &quot;Wed Sep 05 00:37:15 +0000 2012&quot;,
    &quot;status&quot;: &quot;hello world!&quot;,
    &quot;tweet_id&quot;: &quot;987&quot;,
    &quot;user_id&quot;: &quot;123&quot;,
    ...
}</code></pre>
<p>For internal communications, we could use <a
href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">Remote
Procedure Calls</a>.</p>
<h3 id="use-case-user-views-the-home-timeline">Use case: User views the
home timeline</h3>
<ul>
<li>The <strong>Client</strong> posts a home timeline request to the
<strong>Web Server</strong></li>
<li>The <strong>Web Server</strong> forwards the request to the
<strong>Read API</strong> server</li>
<li>The <strong>Read API</strong> server contacts the <strong>Timeline
Service</strong>, which does the following:
<ul>
<li>Gets the timeline data stored in the <strong>Memory Cache</strong>,
containing tweet ids and user ids - O(1)</li>
<li>Queries the <strong>Tweet Info Service</strong> with a <a
href="http://redis.io/commands/mget">multiget</a> to obtain additional
info about the tweet ids - O(n)</li>
<li>Queries the <strong>User Info Service</strong> with a multiget to
obtain additional info about the user ids - O(n)</li>
</ul></li>
</ul>
<p>REST API:</p>
<pre><code>$ curl https://twitter.com/api/v1/home_timeline?user_id=123</code></pre>
<p>Response:</p>
<pre><code>{
    &quot;user_id&quot;: &quot;456&quot;,
    &quot;tweet_id&quot;: &quot;123&quot;,
    &quot;status&quot;: &quot;foo&quot;
},
{
    &quot;user_id&quot;: &quot;789&quot;,
    &quot;tweet_id&quot;: &quot;456&quot;,
    &quot;status&quot;: &quot;bar&quot;
},
{
    &quot;user_id&quot;: &quot;789&quot;,
    &quot;tweet_id&quot;: &quot;579&quot;,
    &quot;status&quot;: &quot;baz&quot;
},</code></pre>
<h3 id="use-case-user-views-the-user-timeline">Use case: User views the
user timeline</h3>
<ul>
<li>The <strong>Client</strong> posts a user timeline request to the
<strong>Web Server</strong></li>
<li>The <strong>Web Server</strong> forwards the request to the
<strong>Read API</strong> server</li>
<li>The <strong>Read API</strong> retrieves the user timeline from the
<strong>SQL Database</strong></li>
</ul>
<p>The REST API would be similar to the home timeline, except all tweets
would come from the user as opposed to the people the user is
following.</p>
<h3 id="use-case-user-searches-keywords">Use case: User searches
keywords</h3>
<ul>
<li>The <strong>Client</strong> sends a search request to the
<strong>Web Server</strong></li>
<li>The <strong>Web Server</strong> forwards the request to the
<strong>Search API</strong> server</li>
<li>The <strong>Search API</strong> contacts the <strong>Search
Service</strong>, which does the following:
<ul>
<li>Parses/tokenizes the input query, determining what needs to be
searched
<ul>
<li>Removes markup</li>
<li>Breaks up the text into terms</li>
<li>Fixes typos</li>
<li>Normalizes capitalization</li>
<li>Converts the query to use boolean operations</li>
</ul></li>
<li>Queries the <strong>Search Cluster</strong> (ie <a
href="https://lucene.apache.org/">Lucene</a>) for the results:
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#under-development">Scatter
gathers</a> each server in the cluster to determine if there are any
results for the query</li>
<li>Merges, ranks, sorts, and returns the results</li>
</ul></li>
</ul></li>
</ul>
<p>REST API:</p>
<pre><code>$ curl https://twitter.com/api/v1/search?query=hello+world</code></pre>
<p>The response would be similar to that of the home timeline, except
for tweets matching the given query.</p>
<h2 id="step-4-scale-the-design-2">Step 4: Scale the design</h2>
<blockquote>
<p>Identify and address bottlenecks, given the constraints.</p>
</blockquote>
<figure>
<img src="http://i.imgur.com/jrUBAF7.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<p><strong>Important: Do not simply jump right into the final design
from the initial design!</strong></p>
<p>State you would 1) <strong>Benchmark/Load Test</strong>, 2)
<strong>Profile</strong> for bottlenecks 3) address bottlenecks while
evaluating alternatives and trade-offs, and 4) repeat. See <a
href="#scaling-aws">Design a system that scales to millions of users on
AWS</a> as a sample on how to iteratively scale the initial design.</p>
<p>It’s important to discuss what bottlenecks you might encounter with
the initial design and how you might address each of them. For example,
what issues are addressed by adding a <strong>Load Balancer</strong>
with multiple <strong>Web Servers</strong>? <strong>CDN</strong>?
<strong>Master-Slave Replicas</strong>? What are the alternatives and
<strong>Trade-Offs</strong> for each?</p>
<p>We’ll introduce some components to complete the design and to address
scalability issues. Internal load balancers are not shown to reduce
clutter.</p>
<p><em>To avoid repeating discussions</em>, refer to the following <a
href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system
design topics</a> for main talking points, tradeoffs, and
alternatives:</p>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#domain-name-system">DNS</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#content-delivery-network">CDN</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#load-balancer">Load
balancer</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#horizontal-scaling">Horizontal
scaling</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">Web
server (reverse proxy)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#application-layer">API
server (application layer)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#cache">Cache</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#relational-database-management-system-rdbms">Relational
database management system (RDBMS)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#fail-over">SQL
write master-slave failover</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#master-slave-replication">Master-slave
replication</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#consistency-patterns">Consistency
patterns</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#availability-patterns">Availability
patterns</a></li>
</ul>
<p>The <strong>Fanout Service</strong> is a potential bottleneck.
Twitter users with millions of followers could take several minutes to
have their tweets go through the fanout process. This could lead to race
conditions with <span class="citation"
data-cites="replies">@replies</span> to the tweet, which we could
mitigate by re-ordering the tweets at serve time.</p>
<p>We could also avoid fanning out tweets from highly-followed users.
Instead, we could search to find tweets for highly-followed users, merge
the search results with the user’s home timeline results, then re-order
the tweets at serve time.</p>
<p>Additional optimizations include:</p>
<ul>
<li>Keep only several hundred tweets for each home timeline in the
<strong>Memory Cache</strong></li>
<li>Keep only active users’ home timeline info in the <strong>Memory
Cache</strong>
<ul>
<li>If a user was not previously active in the past 30 days, we could
rebuild the timeline from the <strong>SQL Database</strong>
<ul>
<li>Query the <strong>User Graph Service</strong> to determine who the
user is following</li>
<li>Get the tweets from the <strong>SQL Database</strong> and add them
to the <strong>Memory Cache</strong></li>
</ul></li>
</ul></li>
<li>Store only a month of tweets in the <strong>Tweet Info
Service</strong></li>
<li>Store only active users in the <strong>User Info
Service</strong></li>
<li>The <strong>Search Cluster</strong> would likely need to keep the
tweets in memory to keep latency low</li>
</ul>
<p>We’ll also want to address the bottleneck with the <strong>SQL
Database</strong>.</p>
<p>Although the <strong>Memory Cache</strong> should reduce the load on
the database, it is unlikely the <strong>SQL Read Replicas</strong>
alone would be enough to handle the cache misses. We’ll probably need to
employ additional SQL scaling patterns.</p>
<p>The high volume of writes would overwhelm a single <strong>SQL Write
Master-Slave</strong>, also pointing to a need for additional scaling
techniques.</p>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#federation">Federation</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sharding">Sharding</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#denormalization">Denormalization</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-tuning">SQL
Tuning</a></li>
</ul>
<p>We should also consider moving some data to a <strong>NoSQL
Database</strong>.</p>
<h2 id="additional-talking-points-1">Additional talking points</h2>
<blockquote>
<p>Additional topics to dive into, depending on the problem scope and
time remaining.</p>
</blockquote>
<h4 id="nosql-2">NoSQL</h4>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#key-value-store">Key-value
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#document-store">Document
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#wide-column-store">Wide
column store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#graph-database">Graph
database</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">SQL
vs NoSQL</a></li>
</ul>
<h3 id="caching-1">Caching</h3>
<ul>
<li>Where to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#client-caching">Client
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#cdn-caching">CDN
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#web-server-caching">Web
server caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#database-caching">Database
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#application-caching">Application
caching</a></li>
</ul></li>
<li>What to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-database-query-level">Caching
at the database query level</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-object-level">Caching
at the object level</a></li>
</ul></li>
<li>When to update the cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#cache-aside">Cache-aside</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-through">Write-through</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-behind-write-back">Write-behind
(write-back)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#refresh-ahead">Refresh
ahead</a></li>
</ul></li>
</ul>
<h3 id="asynchronism-and-microservices-1">Asynchronism and
microservices</h3>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#message-queues">Message
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#task-queues">Task
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#back-pressure">Back
pressure</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#microservices">Microservices</a></li>
</ul>
<h3 id="communications-1">Communications</h3>
<ul>
<li>Discuss tradeoffs:
<ul>
<li>External communication with clients - <a
href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest">HTTP
APIs following REST</a></li>
<li>Internal communications - <a
href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">RPC</a></li>
</ul></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#service-discovery">Service
discovery</a></li>
</ul>
<h3 id="security-2">Security</h3>
<p>Refer to the <a
href="https://github.com/donnemartin/system-design-primer#security">security
section</a>.</p>
<h3 id="latency-numbers-1">Latency numbers</h3>
<p>See <a
href="https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know">Latency
numbers every programmer should know</a>.</p>
<h3 id="ongoing-1">Ongoing</h3>
<ul>
<li>Continue benchmarking and monitoring your system to address
bottlenecks as they come up</li>
<li>Scaling is an iterative process</li>
</ul>
<h1 id="system-design-web-crawler">System Design: Web Crawler</h1>
<h1 id="design-a-web-crawler-1">Design a web crawler</h1>
<p><em>Note: This document links directly to relevant areas found in the
<a
href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system
design topics</a> to avoid duplication. Refer to the linked content for
general talking points, tradeoffs, and alternatives.</em></p>
<h2 id="step-1-outline-use-cases-and-constraints-2">Step 1: Outline use
cases and constraints</h2>
<blockquote>
<p>Gather requirements and scope the problem. Ask questions to clarify
use cases and constraints. Discuss assumptions.</p>
</blockquote>
<p>Without an interviewer to address clarifying questions, we’ll define
some use cases and constraints.</p>
<h3 id="use-cases-2">Use cases</h3>
<h4
id="well-scope-the-problem-to-handle-only-the-following-use-cases-2">We’ll
scope the problem to handle only the following use cases</h4>
<ul>
<li><strong>Service</strong> crawls a list of urls:
<ul>
<li>Generates reverse index of words to pages containing the search
terms</li>
<li>Generates titles and snippets for pages
<ul>
<li>Title and snippets are static, they do not change based on search
query</li>
</ul></li>
</ul></li>
<li><strong>User</strong> inputs a search term and sees a list of
relevant pages with titles and snippets the crawler generated
<ul>
<li>Only sketch high level components and interactions for this use
case, no need to go into depth</li>
</ul></li>
<li><strong>Service</strong> has high availability</li>
</ul>
<h4 id="out-of-scope-2">Out of scope</h4>
<ul>
<li>Search analytics</li>
<li>Personalized search results</li>
<li>Page rank</li>
</ul>
<h3 id="constraints-and-assumptions-2">Constraints and assumptions</h3>
<h4 id="state-assumptions-2">State assumptions</h4>
<ul>
<li>Traffic is not evenly distributed
<ul>
<li>Some searches are very popular, while others are only executed
once</li>
</ul></li>
<li>Support only anonymous users</li>
<li>Generating search results should be fast</li>
<li>The web crawler should not get stuck in an infinite loop
<ul>
<li>We get stuck in an infinite loop if the graph contains a cycle</li>
</ul></li>
<li>1 billion links to crawl
<ul>
<li>Pages need to be crawled regularly to ensure freshness</li>
<li>Average refresh rate of about once per week, more frequent for
popular sites
<ul>
<li>4 billion links crawled each month</li>
</ul></li>
<li>Average stored size per web page: 500 KB
<ul>
<li>For simplicity, count changes the same as new pages</li>
</ul></li>
</ul></li>
<li>100 billion searches per month</li>
</ul>
<p>Exercise the use of more traditional systems - don’t use existing
systems such as <a href="http://lucene.apache.org/solr/" target="_blank">solr</a> or <a
href="http://nutch.apache.org/">nutch</a>.</p>
<h4 id="calculate-usage-2">Calculate usage</h4>
<p><strong>Clarify with your interviewer if you should run
back-of-the-envelope usage calculations.</strong></p>
<ul>
<li>2 PB of stored page content per month
<ul>
<li>500 KB per page * 4 billion links crawled per month</li>
<li>72 PB of stored page content in 3 years</li>
</ul></li>
<li>1,600 write requests per second</li>
<li>40,000 search requests per second</li>
</ul>
<p>Handy conversion guide:</p>
<ul>
<li>2.5 million seconds per month</li>
<li>1 request per second = 2.5 million requests per month</li>
<li>40 requests per second = 100 million requests per month</li>
<li>400 requests per second = 1 billion requests per month</li>
</ul>
<h2 id="step-2-create-a-high-level-design-3">Step 2: Create a high level
design</h2>
<blockquote>
<p>Outline a high level design with all important components.</p>
</blockquote>
<figure>
<img src="http://i.imgur.com/xjdAAUv.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h2 id="step-3-design-core-components-3">Step 3: Design core
components</h2>
<blockquote>
<p>Dive into details for each core component.</p>
</blockquote>
<h3 id="use-case-service-crawls-a-list-of-urls">Use case: Service crawls
a list of urls</h3>
<p>We’ll assume we have an initial list of <code>links_to_crawl</code>
ranked initially based on overall site popularity. If this is not a
reasonable assumption, we can seed the crawler with popular sites that
link to outside content such as <a
href="https://www.yahoo.com/">Yahoo</a>, <a
href="http://www.dmoz.org/">DMOZ</a>, etc.</p>
<p>We’ll use a table <code>crawled_links</code> to store processed links
and their page signatures.</p>
<p>We could store <code>links_to_crawl</code> and
<code>crawled_links</code> in a key-value <strong>NoSQL
Database</strong>. For the ranked links in <code>links_to_crawl</code>,
we could use <a href="https://redis.io/" target="_blank">Redis</a> with sorted sets to
maintain a ranking of page links. We should discuss the <a
href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">use
cases and tradeoffs between choosing SQL or NoSQL</a>.</p>
<ul>
<li>The <strong>Crawler Service</strong> processes each page link by
doing the following in a loop:
<ul>
<li>Takes the top ranked page link to crawl
<ul>
<li>Checks <code>crawled_links</code> in the <strong>NoSQL
Database</strong> for an entry with a similar page signature
<ul>
<li>If we have a similar page, reduces the priority of the page link
<ul>
<li>This prevents us from getting into a cycle</li>
<li>Continue</li>
</ul></li>
<li>Else, crawls the link
<ul>
<li>Adds a job to the <strong>Reverse Index Service</strong> queue to
generate a <a
href="https://en.wikipedia.org/wiki/Search_engine_indexing">reverse
index</a></li>
<li>Adds a job to the <strong>Document Service</strong> queue to
generate a static title and snippet</li>
<li>Generates the page signature</li>
<li>Removes the link from <code>links_to_crawl</code> in the
<strong>NoSQL Database</strong></li>
<li>Inserts the page link and signature to <code>crawled_links</code> in
the <strong>NoSQL Database</strong></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p><strong>Clarify with your interviewer how much code you are expected
to write</strong>.</p>
<p><code>PagesDataStore</code> is an abstraction within the
<strong>Crawler Service</strong> that uses the <strong>NoSQL
Database</strong>:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PagesDataStore(<span class="bu">object</span>):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, db)<span class="op">;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.db <span class="op">=</span> db</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_link_to_crawl(<span class="va">self</span>, url):</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Add the given link to `links_to_crawl`.&quot;&quot;&quot;</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> remove_link_to_crawl(<span class="va">self</span>, url):</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Remove the given link from `links_to_crawl`.&quot;&quot;&quot;</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reduce_priority_link_to_crawl(<span class="va">self</span>, url)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Reduce the priority of a link in `links_to_crawl` to avoid cycles.&quot;&quot;&quot;</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> extract_max_priority_page(<span class="va">self</span>):</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Return the highest priority link in `links_to_crawl`.&quot;&quot;&quot;</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> insert_crawled_link(<span class="va">self</span>, url, signature):</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Add the given link to `crawled_links`.&quot;&quot;&quot;</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> crawled_similar(<span class="va">self</span>, signature):</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Determine if we&#39;ve already crawled a page matching the given signature&quot;&quot;&quot;</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>        ...</span></code></pre></div>
<p><code>Page</code> is an abstraction within the <strong>Crawler
Service</strong> that encapsulates a page, its contents, child urls, and
signature:</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Page(<span class="bu">object</span>):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, url, contents, child_urls, signature):</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.url <span class="op">=</span> url</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.contents <span class="op">=</span> contents</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.child_urls <span class="op">=</span> child_urls</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.signature <span class="op">=</span> signature</span></code></pre></div>
<p><code>Crawler</code> is the main class within <strong>Crawler
Service</strong>, composed of <code>Page</code> and
<code>PagesDataStore</code>.</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Crawler(<span class="bu">object</span>):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, data_store, reverse_index_queue, doc_index_queue):</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data_store <span class="op">=</span> data_store</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.reverse_index_queue <span class="op">=</span> reverse_index_queue</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.doc_index_queue <span class="op">=</span> doc_index_queue</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_signature(<span class="va">self</span>, page):</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Create signature based on url and contents.&quot;&quot;&quot;</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> crawl_page(<span class="va">self</span>, page):</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> url <span class="kw">in</span> page.child_urls:</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.data_store.add_link_to_crawl(url)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>        page.signature <span class="op">=</span> <span class="va">self</span>.create_signature(page)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data_store.remove_link_to_crawl(page.url)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data_store.insert_crawled_link(page.url, page.signature)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> crawl(<span class="va">self</span>):</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>            page <span class="op">=</span> <span class="va">self</span>.data_store.extract_max_priority_page()</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> page <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.data_store.crawled_similar(page.signature):</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.data_store.reduce_priority_link_to_crawl(page.url)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.crawl_page(page)</span></code></pre></div>
<h3 id="handling-duplicates">Handling duplicates</h3>
<p>We need to be careful the web crawler doesn’t get stuck in an
infinite loop, which happens when the graph contains a cycle.</p>
<p><strong>Clarify with your interviewer how much code you are expected
to write</strong>.</p>
<p>We’ll want to remove duplicate urls:</p>
<ul>
<li>For smaller lists we could use something like
<code>sort | unique</code></li>
<li>With 1 billion links to crawl, we could use
<strong>MapReduce</strong> to output only entries that have a frequency
of 1</li>
</ul>
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RemoveDuplicateUrls(MRJob):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mapper(<span class="va">self</span>, _, line):</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> line, <span class="dv">1</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reducer(<span class="va">self</span>, key, values):</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="bu">sum</span>(values)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> key, total</span></code></pre></div>
<p>Detecting duplicate content is more complex. We could generate a
signature based on the contents of the page and compare those two
signatures for similarity. Some potential algorithms are <a
href="https://en.wikipedia.org/wiki/Jaccard_index">Jaccard index</a> and
<a href="https://en.wikipedia.org/wiki/Cosine_similarity" target="_blank">cosine
similarity</a>.</p>
<h3 id="determining-when-to-update-the-crawl-results">Determining when
to update the crawl results</h3>
<p>Pages need to be crawled regularly to ensure freshness. Crawl results
could have a <code>timestamp</code> field that indicates the last time a
page was crawled. After a default time period, say one week, all pages
should be refreshed. Frequently updated or more popular sites could be
refreshed in shorter intervals.</p>
<p>Although we won’t dive into details on analytics, we could do some
data mining to determine the mean time before a particular page is
updated, and use that statistic to determine how often to re-crawl the
page.</p>
<p>We might also choose to support a <code>Robots.txt</code> file that
gives webmasters control of crawl frequency.</p>
<h3
id="use-case-user-inputs-a-search-term-and-sees-a-list-of-relevant-pages-with-titles-and-snippets">Use
case: User inputs a search term and sees a list of relevant pages with
titles and snippets</h3>
<ul>
<li>The <strong>Client</strong> sends a request to the <strong>Web
Server</strong>, running as a <a
href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">reverse
proxy</a></li>
<li>The <strong>Web Server</strong> forwards the request to the
<strong>Query API</strong> server</li>
<li>The <strong>Query API</strong> server does the following:
<ul>
<li>Parses the query
<ul>
<li>Removes markup</li>
<li>Breaks up the text into terms</li>
<li>Fixes typos</li>
<li>Normalizes capitalization</li>
<li>Converts the query to use boolean operations</li>
</ul></li>
<li>Uses the <strong>Reverse Index Service</strong> to find documents
matching the query
<ul>
<li>The <strong>Reverse Index Service</strong> ranks the matching
results and returns the top ones</li>
</ul></li>
<li>Uses the <strong>Document Service</strong> to return titles and
snippets</li>
</ul></li>
</ul>
<p>We’ll use a public <a
href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest"><strong>REST
API</strong></a>:</p>
<pre><code>$ curl https://search.com/api/v1/search?query=hello+world</code></pre>
<p>Response:</p>
<pre><code>{
    &quot;title&quot;: &quot;foo&#39;s title&quot;,
    &quot;snippet&quot;: &quot;foo&#39;s snippet&quot;,
    &quot;link&quot;: &quot;https://foo.com&quot;,
},
{
    &quot;title&quot;: &quot;bar&#39;s title&quot;,
    &quot;snippet&quot;: &quot;bar&#39;s snippet&quot;,
    &quot;link&quot;: &quot;https://bar.com&quot;,
},
{
    &quot;title&quot;: &quot;baz&#39;s title&quot;,
    &quot;snippet&quot;: &quot;baz&#39;s snippet&quot;,
    &quot;link&quot;: &quot;https://baz.com&quot;,
},</code></pre>
<p>For internal communications, we could use <a
href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">Remote
Procedure Calls</a>.</p>
<h2 id="step-4-scale-the-design-3">Step 4: Scale the design</h2>
<blockquote>
<p>Identify and address bottlenecks, given the constraints.</p>
</blockquote>
<figure>
<img src="http://i.imgur.com/bWxPtQA.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<p><strong>Important: Do not simply jump right into the final design
from the initial design!</strong></p>
<p>State you would 1) <strong>Benchmark/Load Test</strong>, 2)
<strong>Profile</strong> for bottlenecks 3) address bottlenecks while
evaluating alternatives and trade-offs, and 4) repeat. See <a
href="#scaling-aws">Design a system that scales to millions of users on
AWS</a> as a sample on how to iteratively scale the initial design.</p>
<p>It’s important to discuss what bottlenecks you might encounter with
the initial design and how you might address each of them. For example,
what issues are addressed by adding a <strong>Load Balancer</strong>
with multiple <strong>Web Servers</strong>? <strong>CDN</strong>?
<strong>Master-Slave Replicas</strong>? What are the alternatives and
<strong>Trade-Offs</strong> for each?</p>
<p>We’ll introduce some components to complete the design and to address
scalability issues. Internal load balancers are not shown to reduce
clutter.</p>
<p><em>To avoid repeating discussions</em>, refer to the following <a
href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system
design topics</a> for main talking points, tradeoffs, and
alternatives:</p>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#domain-name-system">DNS</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#load-balancer">Load
balancer</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#horizontal-scaling">Horizontal
scaling</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">Web
server (reverse proxy)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#application-layer">API
server (application layer)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#cache">Cache</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#nosql">NoSQL</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#consistency-patterns">Consistency
patterns</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#availability-patterns">Availability
patterns</a></li>
</ul>
<p>Some searches are very popular, while others are only executed once.
Popular queries can be served from a <strong>Memory Cache</strong> such
as Redis or Memcached to reduce response times and to avoid overloading
the <strong>Reverse Index Service</strong> and <strong>Document
Service</strong>. The <strong>Memory Cache</strong> is also useful for
handling the unevenly distributed traffic and traffic spikes. Reading 1
MB sequentially from memory takes about 250 microseconds, while reading
from SSD takes 4x and from disk takes 80x
longer.<sup><a href=https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know>1</a></sup></p>
<p>Below are a few other optimizations to the <strong>Crawling
Service</strong>:</p>
<ul>
<li>To handle the data size and request load, the <strong>Reverse Index
Service</strong> and <strong>Document Service</strong> will likely need
to make heavy use sharding and federation.</li>
<li>DNS lookup can be a bottleneck, the <strong>Crawler Service</strong>
can keep its own DNS lookup that is refreshed periodically</li>
<li>The <strong>Crawler Service</strong> can improve performance and
reduce memory usage by keeping many open connections at a time, referred
to as <a href="https://en.wikipedia.org/wiki/Connection_pool" target="_blank">connection
pooling</a>
<ul>
<li>Switching to <a
href="https://github.com/donnemartin/system-design-primer#user-datagram-protocol-udp">UDP</a>
could also boost performance</li>
</ul></li>
<li>Web crawling is bandwidth intensive, ensure there is enough
bandwidth to sustain high throughput</li>
</ul>
<h2 id="additional-talking-points-2">Additional talking points</h2>
<blockquote>
<p>Additional topics to dive into, depending on the problem scope and
time remaining.</p>
</blockquote>
<h3 id="sql-scaling-patterns">SQL scaling patterns</h3>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#master-slave-replication">Read
replicas</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#federation">Federation</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sharding">Sharding</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#denormalization">Denormalization</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-tuning">SQL
Tuning</a></li>
</ul>
<h4 id="nosql-3">NoSQL</h4>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#key-value-store">Key-value
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#document-store">Document
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#wide-column-store">Wide
column store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#graph-database">Graph
database</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">SQL
vs NoSQL</a></li>
</ul>
<h3 id="caching-2">Caching</h3>
<ul>
<li>Where to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#client-caching">Client
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#cdn-caching">CDN
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#web-server-caching">Web
server caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#database-caching">Database
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#application-caching">Application
caching</a></li>
</ul></li>
<li>What to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-database-query-level">Caching
at the database query level</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-object-level">Caching
at the object level</a></li>
</ul></li>
<li>When to update the cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#cache-aside">Cache-aside</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-through">Write-through</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-behind-write-back">Write-behind
(write-back)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#refresh-ahead">Refresh
ahead</a></li>
</ul></li>
</ul>
<h3 id="asynchronism-and-microservices-2">Asynchronism and
microservices</h3>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#message-queues">Message
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#task-queues">Task
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#back-pressure">Back
pressure</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#microservices">Microservices</a></li>
</ul>
<h3 id="communications-2">Communications</h3>
<ul>
<li>Discuss tradeoffs:
<ul>
<li>External communication with clients - <a
href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest">HTTP
APIs following REST</a></li>
<li>Internal communications - <a
href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">RPC</a></li>
</ul></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#service-discovery">Service
discovery</a></li>
</ul>
<h3 id="security-3">Security</h3>
<p>Refer to the <a
href="https://github.com/donnemartin/system-design-primer#security">security
section</a>.</p>
<h3 id="latency-numbers-2">Latency numbers</h3>
<p>See <a
href="https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know">Latency
numbers every programmer should know</a>.</p>
<h3 id="ongoing-2">Ongoing</h3>
<ul>
<li>Continue benchmarking and monitoring your system to address
bottlenecks as they come up</li>
<li>Scaling is an iterative process</li>
</ul>
<h1 id="system-design-mint">System Design: Mint</h1>
<h1 id="design-mint.com-1">Design Mint.com</h1>
<p><em>Note: This document links directly to relevant areas found in the
<a
href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system
design topics</a> to avoid duplication. Refer to the linked content for
general talking points, tradeoffs, and alternatives.</em></p>
<h2 id="step-1-outline-use-cases-and-constraints-3">Step 1: Outline use
cases and constraints</h2>
<blockquote>
<p>Gather requirements and scope the problem. Ask questions to clarify
use cases and constraints. Discuss assumptions.</p>
</blockquote>
<p>Without an interviewer to address clarifying questions, we’ll define
some use cases and constraints.</p>
<h3 id="use-cases-3">Use cases</h3>
<h4
id="well-scope-the-problem-to-handle-only-the-following-use-cases-3">We’ll
scope the problem to handle only the following use cases</h4>
<ul>
<li><strong>User</strong> connects to a financial account</li>
<li><strong>Service</strong> extracts transactions from the account
<ul>
<li>Updates daily</li>
<li>Categorizes transactions
<ul>
<li>Allows manual category override by the user</li>
<li>No automatic re-categorization</li>
</ul></li>
<li>Analyzes monthly spending, by category</li>
</ul></li>
<li><strong>Service</strong> recommends a budget
<ul>
<li>Allows users to manually set a budget</li>
<li>Sends notifications when approaching or exceeding budget</li>
</ul></li>
<li><strong>Service</strong> has high availability</li>
</ul>
<h4 id="out-of-scope-3">Out of scope</h4>
<ul>
<li><strong>Service</strong> performs additional logging and
analytics</li>
</ul>
<h3 id="constraints-and-assumptions-3">Constraints and assumptions</h3>
<h4 id="state-assumptions-3">State assumptions</h4>
<ul>
<li>Traffic is not evenly distributed</li>
<li>Automatic daily update of accounts applies only to users active in
the past 30 days</li>
<li>Adding or removing financial accounts is relatively rare</li>
<li>Budget notifications don’t need to be instant</li>
<li>10 million users
<ul>
<li>10 budget categories per user = 100 million budget items</li>
<li>Example categories:
<ul>
<li>Housing = $1,000</li>
<li>Food = $200</li>
<li>Gas = $100</li>
</ul></li>
<li>Sellers are used to determine transaction category
<ul>
<li>50,000 sellers</li>
</ul></li>
</ul></li>
<li>30 million financial accounts</li>
<li>5 billion transactions per month</li>
<li>500 million read requests per month</li>
<li>10:1 write to read ratio
<ul>
<li>Write-heavy, users make transactions daily, but few visit the site
daily</li>
</ul></li>
</ul>
<h4 id="calculate-usage-3">Calculate usage</h4>
<p><strong>Clarify with your interviewer if you should run
back-of-the-envelope usage calculations.</strong></p>
<ul>
<li>Size per transaction:
<ul>
<li><code>user_id</code> - 8 bytes</li>
<li><code>created_at</code> - 5 bytes</li>
<li><code>seller</code> - 32 bytes</li>
<li><code>amount</code> - 5 bytes</li>
<li>Total: ~50 bytes</li>
</ul></li>
<li>250 GB of new transaction content per month
<ul>
<li>50 bytes per transaction * 5 billion transactions per month</li>
<li>9 TB of new transaction content in 3 years</li>
<li>Assume most are new transactions instead of updates to existing
ones</li>
</ul></li>
<li>2,000 transactions per second on average</li>
<li>200 read requests per second on average</li>
</ul>
<p>Handy conversion guide:</p>
<ul>
<li>2.5 million seconds per month</li>
<li>1 request per second = 2.5 million requests per month</li>
<li>40 requests per second = 100 million requests per month</li>
<li>400 requests per second = 1 billion requests per month</li>
</ul>
<h2 id="step-2-create-a-high-level-design-4">Step 2: Create a high level
design</h2>
<blockquote>
<p>Outline a high level design with all important components.</p>
</blockquote>
<figure>
<img src="http://i.imgur.com/E8klrBh.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h2 id="step-3-design-core-components-4">Step 3: Design core
components</h2>
<blockquote>
<p>Dive into details for each core component.</p>
</blockquote>
<h3 id="use-case-user-connects-to-a-financial-account">Use case: User
connects to a financial account</h3>
<p>We could store info on the 10 million users in a <a
href="https://github.com/donnemartin/system-design-primer#relational-database-management-system-rdbms">relational
database</a>. We should discuss the <a
href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">use
cases and tradeoffs between choosing SQL or NoSQL</a>.</p>
<ul>
<li>The <strong>Client</strong> sends a request to the <strong>Web
Server</strong>, running as a <a
href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">reverse
proxy</a></li>
<li>The <strong>Web Server</strong> forwards the request to the
<strong>Accounts API</strong> server</li>
<li>The <strong>Accounts API</strong> server updates the <strong>SQL
Database</strong> <code>accounts</code> table with the newly entered
account info</li>
</ul>
<p><strong>Clarify with your interviewer how much code you are expected
to write</strong>.</p>
<p>The <code>accounts</code> table could have the following
structure:</p>
<pre><code>id int NOT NULL AUTO_INCREMENT
created_at datetime NOT NULL
last_update datetime NOT NULL
account_url varchar(255) NOT NULL
account_login varchar(32) NOT NULL
account_password_hash char(64) NOT NULL
user_id int NOT NULL
PRIMARY KEY(id)
FOREIGN KEY(user_id) REFERENCES users(id)</code></pre>
<p>We’ll create an <a
href="https://github.com/donnemartin/system-design-primer#use-good-indices">index</a>
on <code>id</code>, <code>user_id</code>, and <code>created_at</code> to
speed up lookups (log-time instead of scanning the entire table) and to
keep the data in memory. Reading 1 MB sequentially from memory takes
about 250 microseconds, while reading from SSD takes 4x and from disk
takes 80x
longer.<sup><a href=https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know>1</a></sup></p>
<p>We’ll use a public <a
href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest"><strong>REST
API</strong></a>:</p>
<pre><code>$ curl -X POST --data &#39;{ &quot;user_id&quot;: &quot;foo&quot;, &quot;account_url&quot;: &quot;bar&quot;, \
    &quot;account_login&quot;: &quot;baz&quot;, &quot;account_password&quot;: &quot;qux&quot; }&#39; \
    https://mint.com/api/v1/account</code></pre>
<p>For internal communications, we could use <a
href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">Remote
Procedure Calls</a>.</p>
<p>Next, the service extracts transactions from the account.</p>
<h3 id="use-case-service-extracts-transactions-from-the-account">Use
case: Service extracts transactions from the account</h3>
<p>We’ll want to extract information from an account in these cases:</p>
<ul>
<li>The user first links the account</li>
<li>The user manually refreshes the account</li>
<li>Automatically each day for users who have been active in the past 30
days</li>
</ul>
<p>Data flow:</p>
<ul>
<li>The <strong>Client</strong> sends a request to the <strong>Web
Server</strong></li>
<li>The <strong>Web Server</strong> forwards the request to the
<strong>Accounts API</strong> server</li>
<li>The <strong>Accounts API</strong> server places a job on a
<strong>Queue</strong> such as <a
href="https://aws.amazon.com/sqs/">Amazon SQS</a> or <a
href="https://www.rabbitmq.com/">RabbitMQ</a>
<ul>
<li>Extracting transactions could take awhile, we’d probably want to do
this <a
href="https://github.com/donnemartin/system-design-primer#asynchronism">asynchronously
with a queue</a>, although this introduces additional complexity</li>
</ul></li>
<li>The <strong>Transaction Extraction Service</strong> does the
following:
<ul>
<li>Pulls from the <strong>Queue</strong> and extracts transactions for
the given account from the financial institution, storing the results as
raw log files in the <strong>Object Store</strong></li>
<li>Uses the <strong>Category Service</strong> to categorize each
transaction</li>
<li>Uses the <strong>Budget Service</strong> to calculate aggregate
monthly spending by category
<ul>
<li>The <strong>Budget Service</strong> uses the <strong>Notification
Service</strong> to let users know if they are nearing or have exceeded
their budget</li>
</ul></li>
<li>Updates the <strong>SQL Database</strong> <code>transactions</code>
table with categorized transactions</li>
<li>Updates the <strong>SQL Database</strong>
<code>monthly_spending</code> table with aggregate monthly spending by
category</li>
<li>Notifies the user the transactions have completed through the
<strong>Notification Service</strong>:
<ul>
<li>Uses a <strong>Queue</strong> (not pictured) to asynchronously send
out notifications</li>
</ul></li>
</ul></li>
</ul>
<p>The <code>transactions</code> table could have the following
structure:</p>
<pre><code>id int NOT NULL AUTO_INCREMENT
created_at datetime NOT NULL
seller varchar(32) NOT NULL
amount decimal NOT NULL
user_id int NOT NULL
PRIMARY KEY(id)
FOREIGN KEY(user_id) REFERENCES users(id)</code></pre>
<p>We’ll create an <a
href="https://github.com/donnemartin/system-design-primer#use-good-indices">index</a>
on <code>id</code>, <code>user_id</code>, and
<code>created_at</code>.</p>
<p>The <code>monthly_spending</code> table could have the following
structure:</p>
<pre><code>id int NOT NULL AUTO_INCREMENT
month_year date NOT NULL
category varchar(32)
amount decimal NOT NULL
user_id int NOT NULL
PRIMARY KEY(id)
FOREIGN KEY(user_id) REFERENCES users(id)</code></pre>
<p>We’ll create an <a
href="https://github.com/donnemartin/system-design-primer#use-good-indices">index</a>
on <code>id</code> and <code>user_id</code>.</p>
<h4 id="category-service">Category service</h4>
<p>For the <strong>Category Service</strong>, we can seed a
seller-to-category dictionary with the most popular sellers. If we
estimate 50,000 sellers and estimate each entry to take less than 255
bytes, the dictionary would only take about 12 MB of memory.</p>
<p><strong>Clarify with your interviewer how much code you are expected
to write</strong>.</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DefaultCategories(Enum):</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    HOUSING <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    FOOD <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    GAS <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    SHOPPING <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>seller_category_map <span class="op">=</span> {}</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>seller_category_map[<span class="st">&#39;Exxon&#39;</span>] <span class="op">=</span> DefaultCategories.GAS</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>seller_category_map[<span class="st">&#39;Target&#39;</span>] <span class="op">=</span> DefaultCategories.SHOPPING</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>...</span></code></pre></div>
<p>For sellers not initially seeded in the map, we could use a
crowdsourcing effort by evaluating the manual category overrides our
users provide. We could use a heap to quickly lookup the top manual
override per seller in O(1) time.</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Categorizer(<span class="bu">object</span>):</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, seller_category_map, seller_category_crowd_overrides_map):</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.seller_category_map <span class="op">=</span> seller_category_map</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.seller_category_crowd_overrides_map <span class="op">=</span> <span class="op">\</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>            seller_category_crowd_overrides_map</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> categorize(<span class="va">self</span>, transaction):</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> transaction.seller <span class="kw">in</span> <span class="va">self</span>.seller_category_map:</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.seller_category_map[transaction.seller]</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> transaction.seller <span class="kw">in</span> <span class="va">self</span>.seller_category_crowd_overrides_map:</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.seller_category_map[transaction.seller] <span class="op">=</span> <span class="op">\</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.seller_category_crowd_overrides_map[transaction.seller].peek_min()</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.seller_category_map[transaction.seller]</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code></pre></div>
<p>Transaction implementation:</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Transaction(<span class="bu">object</span>):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, created_at, seller, amount):</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.created_at <span class="op">=</span> created_at</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.seller <span class="op">=</span> seller</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.amount <span class="op">=</span> amount</span></code></pre></div>
<h3 id="use-case-service-recommends-a-budget">Use case: Service
recommends a budget</h3>
<p>To start, we could use a generic budget template that allocates
category amounts based on income tiers. Using this approach, we would
not have to store the 100 million budget items identified in the
constraints, only those that the user overrides. If a user overrides a
budget category, which we could store the override in the
<code>TABLE budget_overrides</code>.</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Budget(<span class="bu">object</span>):</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, income):</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.income <span class="op">=</span> income</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.categories_to_budget_map <span class="op">=</span> <span class="va">self</span>.create_budget_template()</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_budget_template(<span class="va">self</span>):</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>            DefaultCategories.HOUSING: <span class="va">self</span>.income <span class="op">*</span> <span class="fl">.4</span>,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>            DefaultCategories.FOOD: <span class="va">self</span>.income <span class="op">*</span> <span class="fl">.2</span>,</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>            DefaultCategories.GAS: <span class="va">self</span>.income <span class="op">*</span> <span class="fl">.1</span>,</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>            DefaultCategories.SHOPPING: <span class="va">self</span>.income <span class="op">*</span> <span class="fl">.2</span>,</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>            ...</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> override_category_budget(<span class="va">self</span>, category, amount):</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.categories_to_budget_map[category] <span class="op">=</span> amount</span></code></pre></div>
<p>For the <strong>Budget Service</strong>, we can potentially run SQL
queries on the <code>transactions</code> table to generate the
<code>monthly_spending</code> aggregate table. The
<code>monthly_spending</code> table would likely have much fewer rows
than the total 5 billion transactions, since users typically have many
transactions per month.</p>
<p>As an alternative, we can run <strong>MapReduce</strong> jobs on the
raw transaction files to:</p>
<ul>
<li>Categorize each transaction</li>
<li>Generate aggregate monthly spending by category</li>
</ul>
<p>Running analyses on the transaction files could significantly reduce
the load on the database.</p>
<p>We could call the <strong>Budget Service</strong> to re-run the
analysis if the user updates a category.</p>
<p><strong>Clarify with your interviewer how much code you are expected
to write</strong>.</p>
<p>Sample log file format, tab delimited:</p>
<pre><code>user_id   timestamp   seller  amount</code></pre>
<p><strong>MapReduce</strong> implementation:</p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SpendingByCategory(MRJob):</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, categorizer):</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.categorizer <span class="op">=</span> categorizer</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.current_year_month <span class="op">=</span> calc_current_year_month()</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calc_current_year_month(<span class="va">self</span>):</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Return the current year and month.&quot;&quot;&quot;</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> extract_year_month(<span class="va">self</span>, timestamp):</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Return the year and month portions of the timestamp.&quot;&quot;&quot;</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> handle_budget_notifications(<span class="va">self</span>, key, total):</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Call notification API if nearing or exceeded budget.&quot;&quot;&quot;</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mapper(<span class="va">self</span>, _, line):</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Parse each log line, extract and transform relevant lines.</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a><span class="co">        Argument line will be of the form:</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a><span class="co">        user_id   timestamp   seller  amount</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Using the categorizer to convert seller to category,</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a><span class="co">        emit key value pairs of the form:</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a><span class="co">        (user_id, 2016-01, shopping), 25</span></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a><span class="co">        (user_id, 2016-01, shopping), 100</span></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a><span class="co">        (user_id, 2016-01, gas), 50</span></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>        user_id, timestamp, seller, amount <span class="op">=</span> line.split(<span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>)</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>        category <span class="op">=</span> <span class="va">self</span>.categorizer.categorize(seller)</span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>        period <span class="op">=</span> <span class="va">self</span>.extract_year_month(timestamp)</span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> period <span class="op">==</span> <span class="va">self</span>.current_year_month:</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> (user_id, period, category), amount</span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reducer(<span class="va">self</span>, key, value):</span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Sum values for each key.</span></span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a><span class="co">        (user_id, 2016-01, shopping), 125</span></span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a><span class="co">        (user_id, 2016-01, gas), 50</span></span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="bu">sum</span>(values)</span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> key, <span class="bu">sum</span>(values)</span></code></pre></div>
<h2 id="step-4-scale-the-design-4">Step 4: Scale the design</h2>
<blockquote>
<p>Identify and address bottlenecks, given the constraints.</p>
</blockquote>
<figure>
<img src="http://i.imgur.com/V5q57vU.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<p><strong>Important: Do not simply jump right into the final design
from the initial design!</strong></p>
<p>State you would 1) <strong>Benchmark/Load Test</strong>, 2)
<strong>Profile</strong> for bottlenecks 3) address bottlenecks while
evaluating alternatives and trade-offs, and 4) repeat. See <a
href="#scaling-aws">Design a system that scales to millions of users on
AWS</a> as a sample on how to iteratively scale the initial design.</p>
<p>It’s important to discuss what bottlenecks you might encounter with
the initial design and how you might address each of them. For example,
what issues are addressed by adding a <strong>Load Balancer</strong>
with multiple <strong>Web Servers</strong>? <strong>CDN</strong>?
<strong>Master-Slave Replicas</strong>? What are the alternatives and
<strong>Trade-Offs</strong> for each?</p>
<p>We’ll introduce some components to complete the design and to address
scalability issues. Internal load balancers are not shown to reduce
clutter.</p>
<p><em>To avoid repeating discussions</em>, refer to the following <a
href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system
design topics</a> for main talking points, tradeoffs, and
alternatives:</p>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#domain-name-system">DNS</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#content-delivery-network">CDN</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#load-balancer">Load
balancer</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#horizontal-scaling">Horizontal
scaling</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">Web
server (reverse proxy)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#application-layer">API
server (application layer)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#cache">Cache</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#relational-database-management-system-rdbms">Relational
database management system (RDBMS)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#fail-over">SQL
write master-slave failover</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#master-slave-replication">Master-slave
replication</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#asynchronism">Asynchronism</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#consistency-patterns">Consistency
patterns</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#availability-patterns">Availability
patterns</a></li>
</ul>
<p>We’ll add an additional use case: <strong>User</strong> accesses
summaries and transactions.</p>
<p>User sessions, aggregate stats by category, and recent transactions
could be placed in a <strong>Memory Cache</strong> such as Redis or
Memcached.</p>
<ul>
<li>The <strong>Client</strong> sends a read request to the <strong>Web
Server</strong></li>
<li>The <strong>Web Server</strong> forwards the request to the
<strong>Read API</strong> server
<ul>
<li>Static content can be served from the <strong>Object Store</strong>
such as S3, which is cached on the <strong>CDN</strong></li>
</ul></li>
<li>The <strong>Read API</strong> server does the following:
<ul>
<li>Checks the <strong>Memory Cache</strong> for the content
<ul>
<li>If the url is in the <strong>Memory Cache</strong>, returns the
cached contents</li>
<li>Else
<ul>
<li>If the url is in the <strong>SQL Database</strong>, fetches the
contents
<ul>
<li>Updates the <strong>Memory Cache</strong> with the contents</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p>Refer to <a
href="https://github.com/donnemartin/system-design-primer#when-to-update-the-cache">When
to update the cache</a> for tradeoffs and alternatives. The approach
above describes <a
href="https://github.com/donnemartin/system-design-primer#cache-aside">cache-aside</a>.</p>
<p>Instead of keeping the <code>monthly_spending</code> aggregate table
in the <strong>SQL Database</strong>, we could create a separate
<strong>Analytics Database</strong> using a data warehousing solution
such as Amazon Redshift or Google BigQuery.</p>
<p>We might only want to store a month of <code>transactions</code> data
in the database, while storing the rest in a data warehouse or in an
<strong>Object Store</strong>. An <strong>Object Store</strong> such as
Amazon S3 can comfortably handle the constraint of 250 GB of new content
per month.</p>
<p>To address the 200 <em>average</em> read requests per second (higher
at peak), traffic for popular content should be handled by the
<strong>Memory Cache</strong> instead of the database. The
<strong>Memory Cache</strong> is also useful for handling the unevenly
distributed traffic and traffic spikes. The <strong>SQL Read
Replicas</strong> should be able to handle the cache misses, as long as
the replicas are not bogged down with replicating writes.</p>
<p>2,000 <em>average</em> transaction writes per second (higher at peak)
might be tough for a single <strong>SQL Write Master-Slave</strong>. We
might need to employ additional SQL scaling patterns:</p>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#federation">Federation</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sharding">Sharding</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#denormalization">Denormalization</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-tuning">SQL
Tuning</a></li>
</ul>
<p>We should also consider moving some data to a <strong>NoSQL
Database</strong>.</p>
<h2 id="additional-talking-points-3">Additional talking points</h2>
<blockquote>
<p>Additional topics to dive into, depending on the problem scope and
time remaining.</p>
</blockquote>
<h4 id="nosql-4">NoSQL</h4>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#key-value-store">Key-value
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#document-store">Document
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#wide-column-store">Wide
column store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#graph-database">Graph
database</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">SQL
vs NoSQL</a></li>
</ul>
<h3 id="caching-3">Caching</h3>
<ul>
<li>Where to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#client-caching">Client
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#cdn-caching">CDN
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#web-server-caching">Web
server caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#database-caching">Database
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#application-caching">Application
caching</a></li>
</ul></li>
<li>What to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-database-query-level">Caching
at the database query level</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-object-level">Caching
at the object level</a></li>
</ul></li>
<li>When to update the cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#cache-aside">Cache-aside</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-through">Write-through</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-behind-write-back">Write-behind
(write-back)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#refresh-ahead">Refresh
ahead</a></li>
</ul></li>
</ul>
<h3 id="asynchronism-and-microservices-3">Asynchronism and
microservices</h3>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#message-queues">Message
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#task-queues">Task
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#back-pressure">Back
pressure</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#microservices">Microservices</a></li>
</ul>
<h3 id="communications-3">Communications</h3>
<ul>
<li>Discuss tradeoffs:
<ul>
<li>External communication with clients - <a
href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest">HTTP
APIs following REST</a></li>
<li>Internal communications - <a
href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">RPC</a></li>
</ul></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#service-discovery">Service
discovery</a></li>
</ul>
<h3 id="security-4">Security</h3>
<p>Refer to the <a
href="https://github.com/donnemartin/system-design-primer#security">security
section</a>.</p>
<h3 id="latency-numbers-3">Latency numbers</h3>
<p>See <a
href="https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know">Latency
numbers every programmer should know</a>.</p>
<h3 id="ongoing-3">Ongoing</h3>
<ul>
<li>Continue benchmarking and monitoring your system to address
bottlenecks as they come up</li>
<li>Scaling is an iterative process</li>
</ul>
<h1 id="system-design-social-graph">System Design: Social Graph</h1>
<h1 id="design-the-data-structures-for-a-social-network-1">Design the
data structures for a social network</h1>
<p><em>Note: This document links directly to relevant areas found in the
<a
href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system
design topics</a> to avoid duplication. Refer to the linked content for
general talking points, tradeoffs, and alternatives.</em></p>
<h2 id="step-1-outline-use-cases-and-constraints-4">Step 1: Outline use
cases and constraints</h2>
<blockquote>
<p>Gather requirements and scope the problem. Ask questions to clarify
use cases and constraints. Discuss assumptions.</p>
</blockquote>
<p>Without an interviewer to address clarifying questions, we’ll define
some use cases and constraints.</p>
<h3 id="use-cases-4">Use cases</h3>
<h4
id="well-scope-the-problem-to-handle-only-the-following-use-cases-4">We’ll
scope the problem to handle only the following use cases</h4>
<ul>
<li><strong>User</strong> searches for someone and sees the shortest
path to the searched person</li>
<li><strong>Service</strong> has high availability</li>
</ul>
<h3 id="constraints-and-assumptions-4">Constraints and assumptions</h3>
<h4 id="state-assumptions-4">State assumptions</h4>
<ul>
<li>Traffic is not evenly distributed
<ul>
<li>Some searches are more popular than others, while others are only
executed once</li>
</ul></li>
<li>Graph data won’t fit on a single machine</li>
<li>Graph edges are unweighted</li>
<li>100 million users</li>
<li>50 friends per user average</li>
<li>1 billion friend searches per month</li>
</ul>
<p>Exercise the use of more traditional systems - don’t use
graph-specific solutions such as <a
href="http://graphql.org/">GraphQL</a> or a graph database like <a
href="https://neo4j.com/">Neo4j</a></p>
<h4 id="calculate-usage-4">Calculate usage</h4>
<p><strong>Clarify with your interviewer if you should run
back-of-the-envelope usage calculations.</strong></p>
<ul>
<li>5 billion friend relationships
<ul>
<li>100 million users * 50 friends per user average</li>
</ul></li>
<li>400 search requests per second</li>
</ul>
<p>Handy conversion guide:</p>
<ul>
<li>2.5 million seconds per month</li>
<li>1 request per second = 2.5 million requests per month</li>
<li>40 requests per second = 100 million requests per month</li>
<li>400 requests per second = 1 billion requests per month</li>
</ul>
<h2 id="step-2-create-a-high-level-design-5">Step 2: Create a high level
design</h2>
<blockquote>
<p>Outline a high level design with all important components.</p>
</blockquote>
<figure>
<img src="http://i.imgur.com/wxXyq2J.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h2 id="step-3-design-core-components-5">Step 3: Design core
components</h2>
<blockquote>
<p>Dive into details for each core component.</p>
</blockquote>
<h3
id="use-case-user-searches-for-someone-and-sees-the-shortest-path-to-the-searched-person">Use
case: User searches for someone and sees the shortest path to the
searched person</h3>
<p><strong>Clarify with your interviewer how much code you are expected
to write</strong>.</p>
<p>Without the constraint of millions of users (vertices) and billions
of friend relationships (edges), we could solve this unweighted shortest
path task with a general BFS approach:</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Graph(Graph):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> shortest_path(<span class="va">self</span>, source, dest):</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> source <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> dest <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> source <span class="kw">is</span> dest:</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [source.key]</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>        prev_node_keys <span class="op">=</span> <span class="va">self</span>._shortest_path(source, dest)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> prev_node_keys <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>            path_ids <span class="op">=</span> [dest.key]</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>            prev_node_key <span class="op">=</span> prev_node_keys[dest.key]</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> prev_node_key <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>                path_ids.append(prev_node_key)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>                prev_node_key <span class="op">=</span> prev_node_keys[prev_node_key]</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> path_ids[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _shortest_path(<span class="va">self</span>, source, dest):</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>        queue <span class="op">=</span> deque()</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>        queue.append(source)</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>        prev_node_keys <span class="op">=</span> {source.key: <span class="va">None</span>}</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>        source.visit_state <span class="op">=</span> State.visited</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> queue:</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>            node <span class="op">=</span> queue.popleft()</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> node <span class="kw">is</span> dest:</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> prev_node_keys</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>            prev_node <span class="op">=</span> node</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> adj_node <span class="kw">in</span> node.adj_nodes.values():</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> adj_node.visit_state <span class="op">==</span> State.unvisited:</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>                    queue.append(adj_node)</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>                    prev_node_keys[adj_node.key] <span class="op">=</span> prev_node.key</span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>                    adj_node.visit_state <span class="op">=</span> State.visited</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code></pre></div>
<p>We won’t be able to fit all users on the same machine, we’ll need to
<a
href="https://github.com/donnemartin/system-design-primer#sharding">shard</a>
users across <strong>Person Servers</strong> and access them with a
<strong>Lookup Service</strong>.</p>
<ul>
<li>The <strong>Client</strong> sends a request to the <strong>Web
Server</strong>, running as a <a
href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">reverse
proxy</a></li>
<li>The <strong>Web Server</strong> forwards the request to the
<strong>Search API</strong> server</li>
<li>The <strong>Search API</strong> server forwards the request to the
<strong>User Graph Service</strong></li>
<li>The <strong>User Graph Service</strong> does the following:
<ul>
<li>Uses the <strong>Lookup Service</strong> to find the <strong>Person
Server</strong> where the current user’s info is stored</li>
<li>Finds the appropriate <strong>Person Server</strong> to retrieve the
current user’s list of <code>friend_ids</code></li>
<li>Runs a BFS search using the current user as the <code>source</code>
and the current user’s <code>friend_ids</code> as the ids for each
<code>adjacent_node</code></li>
<li>To get the <code>adjacent_node</code> from a given id:
<ul>
<li>The <strong>User Graph Service</strong> will <em>again</em> need to
communicate with the <strong>Lookup Service</strong> to determine which
<strong>Person Server</strong> stores the<code>adjacent_node</code>
matching the given id (potential for optimization)</li>
</ul></li>
</ul></li>
</ul>
<p><strong>Clarify with your interviewer how much code you should be
writing</strong>.</p>
<p><strong>Note</strong>: Error handling is excluded below for
simplicity. Ask if you should code proper error handing.</p>
<p><strong>Lookup Service</strong> implementation:</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LookupService(<span class="bu">object</span>):</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lookup <span class="op">=</span> <span class="va">self</span>._init_lookup()  <span class="co"># key: person_id, value: person_server</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _init_lookup(<span class="va">self</span>):</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> lookup_person_server(<span class="va">self</span>, person_id):</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.lookup[person_id]</span></code></pre></div>
<p><strong>Person Server</strong> implementation:</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PersonServer(<span class="bu">object</span>):</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.people <span class="op">=</span> {}  <span class="co"># key: person_id, value: person</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_person(<span class="va">self</span>, person):</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> people(<span class="va">self</span>, ids):</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="bu">id</span> <span class="kw">in</span> ids:</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">id</span> <span class="kw">in</span> <span class="va">self</span>.people:</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>                results.append(<span class="va">self</span>.people[<span class="bu">id</span>])</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results</span></code></pre></div>
<p><strong>Person</strong> implementation:</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Person(<span class="bu">object</span>):</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="bu">id</span>, name, friend_ids):</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">id</span> <span class="op">=</span> <span class="bu">id</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.friend_ids <span class="op">=</span> friend_ids</span></code></pre></div>
<p><strong>User Graph Service</strong> implementation:</p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserGraphService(<span class="bu">object</span>):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, lookup_service):</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lookup_service <span class="op">=</span> lookup_service</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> person(<span class="va">self</span>, person_id):</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>        person_server <span class="op">=</span> <span class="va">self</span>.lookup_service.lookup_person_server(person_id)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> person_server.people([person_id])</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> shortest_path(<span class="va">self</span>, source_key, dest_key):</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> source_key <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> dest_key <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> source_key <span class="kw">is</span> dest_key:</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [source_key]</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>        prev_node_keys <span class="op">=</span> <span class="va">self</span>._shortest_path(source_key, dest_key)</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> prev_node_keys <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Iterate through the path_ids backwards, starting at dest_key</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>            path_ids <span class="op">=</span> [dest_key]</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>            prev_node_key <span class="op">=</span> prev_node_keys[dest_key]</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> prev_node_key <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>                path_ids.append(prev_node_key)</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>                prev_node_key <span class="op">=</span> prev_node_keys[prev_node_key]</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Reverse the list since we iterated backwards</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> path_ids[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _shortest_path(<span class="va">self</span>, source_key, dest_key, path):</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use the id to get the Person</span></span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>        source <span class="op">=</span> <span class="va">self</span>.person(source_key)</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Update our bfs queue</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>        queue <span class="op">=</span> deque()</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>        queue.append(source)</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># prev_node_keys keeps track of each hop from</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the source_key to the dest_key</span></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>        prev_node_keys <span class="op">=</span> {source_key: <span class="va">None</span>}</span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We&#39;ll use visited_ids to keep track of which nodes we&#39;ve</span></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># visited, which can be different from a typical bfs where</span></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># this can be stored in the node itself</span></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>        visited_ids <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>        visited_ids.add(source.<span class="bu">id</span>)</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> queue:</span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>            node <span class="op">=</span> queue.popleft()</span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> node.key <span class="kw">is</span> dest_key:</span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> prev_node_keys</span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>            prev_node <span class="op">=</span> node</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> friend_id <span class="kw">in</span> node.friend_ids:</span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> friend_id <span class="kw">not</span> <span class="kw">in</span> visited_ids:</span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>                    friend_node <span class="op">=</span> <span class="va">self</span>.person(friend_id)</span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a>                    queue.append(friend_node)</span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>                    prev_node_keys[friend_id] <span class="op">=</span> prev_node.key</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>                    visited_ids.add(friend_id)</span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span></code></pre></div>
<p>We’ll use a public <a
href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest"><strong>REST
API</strong></a>:</p>
<pre><code>$ curl https://social.com/api/v1/friend_search?person_id=1234</code></pre>
<p>Response:</p>
<pre><code>{
    &quot;person_id&quot;: &quot;100&quot;,
    &quot;name&quot;: &quot;foo&quot;,
    &quot;link&quot;: &quot;https://social.com/foo&quot;,
},
{
    &quot;person_id&quot;: &quot;53&quot;,
    &quot;name&quot;: &quot;bar&quot;,
    &quot;link&quot;: &quot;https://social.com/bar&quot;,
},
{
    &quot;person_id&quot;: &quot;1234&quot;,
    &quot;name&quot;: &quot;baz&quot;,
    &quot;link&quot;: &quot;https://social.com/baz&quot;,
},</code></pre>
<p>For internal communications, we could use <a
href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">Remote
Procedure Calls</a>.</p>
<h2 id="step-4-scale-the-design-5">Step 4: Scale the design</h2>
<blockquote>
<p>Identify and address bottlenecks, given the constraints.</p>
</blockquote>
<figure>
<img src="http://i.imgur.com/cdCv5g7.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<p><strong>Important: Do not simply jump right into the final design
from the initial design!</strong></p>
<p>State you would 1) <strong>Benchmark/Load Test</strong>, 2)
<strong>Profile</strong> for bottlenecks 3) address bottlenecks while
evaluating alternatives and trade-offs, and 4) repeat. See <a
href="#scaling-aws">Design a system that scales to millions of users on
AWS</a> as a sample on how to iteratively scale the initial design.</p>
<p>It’s important to discuss what bottlenecks you might encounter with
the initial design and how you might address each of them. For example,
what issues are addressed by adding a <strong>Load Balancer</strong>
with multiple <strong>Web Servers</strong>? <strong>CDN</strong>?
<strong>Master-Slave Replicas</strong>? What are the alternatives and
<strong>Trade-Offs</strong> for each?</p>
<p>We’ll introduce some components to complete the design and to address
scalability issues. Internal load balancers are not shown to reduce
clutter.</p>
<p><em>To avoid repeating discussions</em>, refer to the following <a
href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system
design topics</a> for main talking points, tradeoffs, and
alternatives:</p>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#domain-name-system">DNS</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#load-balancer">Load
balancer</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#horizontal-scaling">Horizontal
scaling</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">Web
server (reverse proxy)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#application-layer">API
server (application layer)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#cache">Cache</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#consistency-patterns">Consistency
patterns</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#availability-patterns">Availability
patterns</a></li>
</ul>
<p>To address the constraint of 400 <em>average</em> read requests per
second (higher at peak), person data can be served from a <strong>Memory
Cache</strong> such as Redis or Memcached to reduce response times and
to reduce traffic to downstream services. This could be especially
useful for people who do multiple searches in succession and for people
who are well-connected. Reading 1 MB sequentially from memory takes
about 250 microseconds, while reading from SSD takes 4x and from disk
takes 80x
longer.<sup><a href=https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know>1</a></sup></p>
<p>Below are further optimizations:</p>
<ul>
<li>Store complete or partial BFS traversals to speed up subsequent
lookups in the <strong>Memory Cache</strong></li>
<li>Batch compute offline then store complete or partial BFS traversals
to speed up subsequent lookups in a <strong>NoSQL Database</strong></li>
<li>Reduce machine jumps by batching together friend lookups hosted on
the same <strong>Person Server</strong>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#sharding">Shard</a>
<strong>Person Servers</strong> by location to further improve this, as
friends generally live closer to each other</li>
</ul></li>
<li>Do two BFS searches at the same time, one starting from the source,
and one from the destination, then merge the two paths</li>
<li>Start the BFS search from people with large numbers of friends, as
they are more likely to reduce the number of <a
href="https://en.wikipedia.org/wiki/Six_degrees_of_separation">degrees
of separation</a> between the current user and the search target</li>
<li>Set a limit based on time or number of hops before asking the user
if they want to continue searching, as searching could take a
considerable amount of time in some cases</li>
<li>Use a <strong>Graph Database</strong> such as <a
href="https://neo4j.com/">Neo4j</a> or a graph-specific query language
such as <a href="http://graphql.org/" target="_blank">GraphQL</a> (if there were no
constraint preventing the use of <strong>Graph Databases</strong>)</li>
</ul>
<h2 id="additional-talking-points-4">Additional talking points</h2>
<blockquote>
<p>Additional topics to dive into, depending on the problem scope and
time remaining.</p>
</blockquote>
<h3 id="sql-scaling-patterns-1">SQL scaling patterns</h3>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#master-slave-replication">Read
replicas</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#federation">Federation</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sharding">Sharding</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#denormalization">Denormalization</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-tuning">SQL
Tuning</a></li>
</ul>
<h4 id="nosql-5">NoSQL</h4>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#key-value-store">Key-value
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#document-store">Document
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#wide-column-store">Wide
column store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#graph-database">Graph
database</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">SQL
vs NoSQL</a></li>
</ul>
<h3 id="caching-4">Caching</h3>
<ul>
<li>Where to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#client-caching">Client
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#cdn-caching">CDN
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#web-server-caching">Web
server caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#database-caching">Database
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#application-caching">Application
caching</a></li>
</ul></li>
<li>What to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-database-query-level">Caching
at the database query level</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-object-level">Caching
at the object level</a></li>
</ul></li>
<li>When to update the cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#cache-aside">Cache-aside</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-through">Write-through</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-behind-write-back">Write-behind
(write-back)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#refresh-ahead">Refresh
ahead</a></li>
</ul></li>
</ul>
<h3 id="asynchronism-and-microservices-4">Asynchronism and
microservices</h3>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#message-queues">Message
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#task-queues">Task
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#back-pressure">Back
pressure</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#microservices">Microservices</a></li>
</ul>
<h3 id="communications-4">Communications</h3>
<ul>
<li>Discuss tradeoffs:
<ul>
<li>External communication with clients - <a
href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest">HTTP
APIs following REST</a></li>
<li>Internal communications - <a
href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">RPC</a></li>
</ul></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#service-discovery">Service
discovery</a></li>
</ul>
<h3 id="security-5">Security</h3>
<p>Refer to the <a
href="https://github.com/donnemartin/system-design-primer#security">security
section</a>.</p>
<h3 id="latency-numbers-4">Latency numbers</h3>
<p>See <a
href="https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know">Latency
numbers every programmer should know</a>.</p>
<h3 id="ongoing-4">Ongoing</h3>
<ul>
<li>Continue benchmarking and monitoring your system to address
bottlenecks as they come up</li>
<li>Scaling is an iterative process</li>
</ul>
<h1 id="system-design-query-cache">System Design: Query Cache</h1>
<h1
id="design-a-key-value-cache-to-save-the-results-of-the-most-recent-web-server-queries">Design
a key-value cache to save the results of the most recent web server
queries</h1>
<p><em>Note: This document links directly to relevant areas found in the
<a
href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system
design topics</a> to avoid duplication. Refer to the linked content for
general talking points, tradeoffs, and alternatives.</em></p>
<h2 id="step-1-outline-use-cases-and-constraints-5">Step 1: Outline use
cases and constraints</h2>
<blockquote>
<p>Gather requirements and scope the problem. Ask questions to clarify
use cases and constraints. Discuss assumptions.</p>
</blockquote>
<p>Without an interviewer to address clarifying questions, we’ll define
some use cases and constraints.</p>
<h3 id="use-cases-5">Use cases</h3>
<h4
id="well-scope-the-problem-to-handle-only-the-following-use-cases-5">We’ll
scope the problem to handle only the following use cases</h4>
<ul>
<li><strong>User</strong> sends a search request resulting in a cache
hit</li>
<li><strong>User</strong> sends a search request resulting in a cache
miss</li>
<li><strong>Service</strong> has high availability</li>
</ul>
<h3 id="constraints-and-assumptions-5">Constraints and assumptions</h3>
<h4 id="state-assumptions-5">State assumptions</h4>
<ul>
<li>Traffic is not evenly distributed
<ul>
<li>Popular queries should almost always be in the cache</li>
<li>Need to determine how to expire/refresh</li>
</ul></li>
<li>Serving from cache requires fast lookups</li>
<li>Low latency between machines</li>
<li>Limited memory in cache
<ul>
<li>Need to determine what to keep/remove</li>
<li>Need to cache millions of queries</li>
</ul></li>
<li>10 million users</li>
<li>10 billion queries per month</li>
</ul>
<h4 id="calculate-usage-5">Calculate usage</h4>
<p><strong>Clarify with your interviewer if you should run
back-of-the-envelope usage calculations.</strong></p>
<ul>
<li>Cache stores ordered list of key: query, value: results
<ul>
<li><code>query</code> - 50 bytes</li>
<li><code>title</code> - 20 bytes</li>
<li><code>snippet</code> - 200 bytes</li>
<li>Total: 270 bytes</li>
</ul></li>
<li>2.7 TB of cache data per month if all 10 billion queries are unique
and all are stored
<ul>
<li>270 bytes per search * 10 billion searches per month</li>
<li>Assumptions state limited memory, need to determine how to expire
contents</li>
</ul></li>
<li>4,000 requests per second</li>
</ul>
<p>Handy conversion guide:</p>
<ul>
<li>2.5 million seconds per month</li>
<li>1 request per second = 2.5 million requests per month</li>
<li>40 requests per second = 100 million requests per month</li>
<li>400 requests per second = 1 billion requests per month</li>
</ul>
<h2 id="step-2-create-a-high-level-design-6">Step 2: Create a high level
design</h2>
<blockquote>
<p>Outline a high level design with all important components.</p>
</blockquote>
<figure>
<img src="http://i.imgur.com/KqZ3dSx.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h2 id="step-3-design-core-components-6">Step 3: Design core
components</h2>
<blockquote>
<p>Dive into details for each core component.</p>
</blockquote>
<h3 id="use-case-user-sends-a-request-resulting-in-a-cache-hit">Use
case: User sends a request resulting in a cache hit</h3>
<p>Popular queries can be served from a <strong>Memory Cache</strong>
such as Redis or Memcached to reduce read latency and to avoid
overloading the <strong>Reverse Index Service</strong> and
<strong>Document Service</strong>. Reading 1 MB sequentially from memory
takes about 250 microseconds, while reading from SSD takes 4x and from
disk takes 80x
longer.<sup><a href=https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know>1</a></sup></p>
<p>Since the cache has limited capacity, we’ll use a least recently used
(LRU) approach to expire older entries.</p>
<ul>
<li>The <strong>Client</strong> sends a request to the <strong>Web
Server</strong>, running as a <a
href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">reverse
proxy</a></li>
<li>The <strong>Web Server</strong> forwards the request to the
<strong>Query API</strong> server</li>
<li>The <strong>Query API</strong> server does the following:
<ul>
<li>Parses the query
<ul>
<li>Removes markup</li>
<li>Breaks up the text into terms</li>
<li>Fixes typos</li>
<li>Normalizes capitalization</li>
<li>Converts the query to use boolean operations</li>
</ul></li>
<li>Checks the <strong>Memory Cache</strong> for the content matching
the query
<ul>
<li>If there’s a hit in the <strong>Memory Cache</strong>, the
<strong>Memory Cache</strong> does the following:
<ul>
<li>Updates the cached entry’s position to the front of the LRU
list</li>
<li>Returns the cached contents</li>
</ul></li>
<li>Else, the <strong>Query API</strong> does the following:
<ul>
<li>Uses the <strong>Reverse Index Service</strong> to find documents
matching the query
<ul>
<li>The <strong>Reverse Index Service</strong> ranks the matching
results and returns the top ones</li>
</ul></li>
<li>Uses the <strong>Document Service</strong> to return titles and
snippets</li>
<li>Updates the <strong>Memory Cache</strong> with the contents, placing
the entry at the front of the LRU list</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<h4 id="cache-implementation">Cache implementation</h4>
<p>The cache can use a doubly-linked list: new items will be added to
the head while items to expire will be removed from the tail. We’ll use
a hash table for fast lookups to each linked list node.</p>
<p><strong>Clarify with your interviewer how much code you are expected
to write</strong>.</p>
<p><strong>Query API Server</strong> implementation:</p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QueryApi(<span class="bu">object</span>):</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, memory_cache, reverse_index_service):</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.memory_cache <span class="op">=</span> memory_cache</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.reverse_index_service <span class="op">=</span> reverse_index_service</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> parse_query(<span class="va">self</span>, query):</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Remove markup, break text into terms, deal with typos,</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co">        normalize capitalization, convert to use boolean operations.</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_query(<span class="va">self</span>, query):</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>        query <span class="op">=</span> <span class="va">self</span>.parse_query(query)</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> <span class="va">self</span>.memory_cache.get(query)</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> results <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>            results <span class="op">=</span> <span class="va">self</span>.reverse_index_service.process_search(query)</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.memory_cache.<span class="bu">set</span>(query, results)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results</span></code></pre></div>
<p><strong>Node</strong> implementation:</p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Node(<span class="bu">object</span>):</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, query, results):</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.query <span class="op">=</span> query</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results <span class="op">=</span> results</span></code></pre></div>
<p><strong>LinkedList</strong> implementation:</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LinkedList(<span class="bu">object</span>):</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.head <span class="op">=</span> <span class="va">None</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.tail <span class="op">=</span> <span class="va">None</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> move_to_front(<span class="va">self</span>, node):</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> append_to_front(<span class="va">self</span>, node):</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> remove_from_tail(<span class="va">self</span>):</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>        ...</span></code></pre></div>
<p><strong>Cache</strong> implementation:</p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Cache(<span class="bu">object</span>):</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, MAX_SIZE):</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.MAX_SIZE <span class="op">=</span> MAX_SIZE</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.size <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lookup <span class="op">=</span> {}  <span class="co"># key: query, value: node</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linked_list <span class="op">=</span> LinkedList()</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get(<span class="va">self</span>, query)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Get the stored query result from the cache.</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Accessing a node updates its position to the front of the LRU list.</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>        node <span class="op">=</span> <span class="va">self</span>.lookup[query]</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linked_list.move_to_front(node)</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> node.results</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="bu">set</span>(<span class="va">self</span>, results, query):</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Set the result for the given query key in the cache.</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a><span class="co">        When updating an entry, updates its position to the front of the LRU list.</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a><span class="co">        If the entry is new and the cache is at capacity, removes the oldest entry</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a><span class="co">        before the new entry is added.</span></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a>        node <span class="op">=</span> <span class="va">self</span>.lookup[query]</span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Key exists in cache, update the value</span></span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>            node.results <span class="op">=</span> results</span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.linked_list.move_to_front(node)</span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Key does not exist in cache</span></span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.size <span class="op">==</span> <span class="va">self</span>.MAX_SIZE:</span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Remove the oldest entry from the linked list and lookup</span></span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.lookup.pop(<span class="va">self</span>.linked_list.tail.query, <span class="va">None</span>)</span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.linked_list.remove_from_tail()</span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.size <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add the new key and value</span></span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>            new_node <span class="op">=</span> Node(query, results)</span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.linked_list.append_to_front(new_node)</span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.lookup[query] <span class="op">=</span> new_node</span></code></pre></div>
<h4 id="when-to-update-the-cache-1">When to update the cache</h4>
<p>The cache should be updated when:</p>
<ul>
<li>The page contents change</li>
<li>The page is removed or a new page is added</li>
<li>The page rank changes</li>
</ul>
<p>The most straightforward way to handle these cases is to simply set a
max time that a cached entry can stay in the cache before it is updated,
usually referred to as time to live (TTL).</p>
<p>Refer to <a
href="https://github.com/donnemartin/system-design-primer#when-to-update-the-cache">When
to update the cache</a> for tradeoffs and alternatives. The approach
above describes <a
href="https://github.com/donnemartin/system-design-primer#cache-aside">cache-aside</a>.</p>
<h2 id="step-4-scale-the-design-6">Step 4: Scale the design</h2>
<blockquote>
<p>Identify and address bottlenecks, given the constraints.</p>
</blockquote>
<figure>
<img src="http://i.imgur.com/4j99mhe.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<p><strong>Important: Do not simply jump right into the final design
from the initial design!</strong></p>
<p>State you would 1) <strong>Benchmark/Load Test</strong>, 2)
<strong>Profile</strong> for bottlenecks 3) address bottlenecks while
evaluating alternatives and trade-offs, and 4) repeat. See <a
href="#scaling-aws">Design a system that scales to millions of users on
AWS</a> as a sample on how to iteratively scale the initial design.</p>
<p>It’s important to discuss what bottlenecks you might encounter with
the initial design and how you might address each of them. For example,
what issues are addressed by adding a <strong>Load Balancer</strong>
with multiple <strong>Web Servers</strong>? <strong>CDN</strong>?
<strong>Master-Slave Replicas</strong>? What are the alternatives and
<strong>Trade-Offs</strong> for each?</p>
<p>We’ll introduce some components to complete the design and to address
scalability issues. Internal load balancers are not shown to reduce
clutter.</p>
<p><em>To avoid repeating discussions</em>, refer to the following <a
href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system
design topics</a> for main talking points, tradeoffs, and
alternatives:</p>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#domain-name-system">DNS</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#load-balancer">Load
balancer</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#horizontal-scaling">Horizontal
scaling</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">Web
server (reverse proxy)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#application-layer">API
server (application layer)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#cache">Cache</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#consistency-patterns">Consistency
patterns</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#availability-patterns">Availability
patterns</a></li>
</ul>
<h3 id="expanding-the-memory-cache-to-many-machines">Expanding the
Memory Cache to many machines</h3>
<p>To handle the heavy request load and the large amount of memory
needed, we’ll scale horizontally. We have three main options on how to
store the data on our <strong>Memory Cache</strong> cluster:</p>
<ul>
<li><strong>Each machine in the cache cluster has its own cache</strong>
- Simple, although it will likely result in a low cache hit rate.</li>
<li><strong>Each machine in the cache cluster has a copy of the
cache</strong> - Simple, although it is an inefficient use of
memory.</li>
<li><strong>The cache is <a
href="https://github.com/donnemartin/system-design-primer#sharding">sharded</a>
across all machines in the cache cluster</strong> - More complex,
although it is likely the best option. We could use hashing to determine
which machine could have the cached results of a query using
<code>machine = hash(query)</code>. We’ll likely want to use <a
href="https://github.com/donnemartin/system-design-primer#under-development">consistent
hashing</a>.</li>
</ul>
<h2 id="additional-talking-points-5">Additional talking points</h2>
<blockquote>
<p>Additional topics to dive into, depending on the problem scope and
time remaining.</p>
</blockquote>
<h3 id="sql-scaling-patterns-2">SQL scaling patterns</h3>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#master-slave-replication">Read
replicas</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#federation">Federation</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sharding">Sharding</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#denormalization">Denormalization</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-tuning">SQL
Tuning</a></li>
</ul>
<h4 id="nosql-6">NoSQL</h4>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#key-value-store">Key-value
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#document-store">Document
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#wide-column-store">Wide
column store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#graph-database">Graph
database</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">SQL
vs NoSQL</a></li>
</ul>
<h3 id="caching-5">Caching</h3>
<ul>
<li>Where to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#client-caching">Client
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#cdn-caching">CDN
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#web-server-caching">Web
server caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#database-caching">Database
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#application-caching">Application
caching</a></li>
</ul></li>
<li>What to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-database-query-level">Caching
at the database query level</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-object-level">Caching
at the object level</a></li>
</ul></li>
<li>When to update the cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#cache-aside">Cache-aside</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-through">Write-through</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-behind-write-back">Write-behind
(write-back)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#refresh-ahead">Refresh
ahead</a></li>
</ul></li>
</ul>
<h3 id="asynchronism-and-microservices-5">Asynchronism and
microservices</h3>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#message-queues">Message
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#task-queues">Task
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#back-pressure">Back
pressure</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#microservices">Microservices</a></li>
</ul>
<h3 id="communications-5">Communications</h3>
<ul>
<li>Discuss tradeoffs:
<ul>
<li>External communication with clients - <a
href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest">HTTP
APIs following REST</a></li>
<li>Internal communications - <a
href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">RPC</a></li>
</ul></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#service-discovery">Service
discovery</a></li>
</ul>
<h3 id="security-6">Security</h3>
<p>Refer to the <a
href="https://github.com/donnemartin/system-design-primer#security">security
section</a>.</p>
<h3 id="latency-numbers-5">Latency numbers</h3>
<p>See <a
href="https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know">Latency
numbers every programmer should know</a>.</p>
<h3 id="ongoing-5">Ongoing</h3>
<ul>
<li>Continue benchmarking and monitoring your system to address
bottlenecks as they come up</li>
<li>Scaling is an iterative process</li>
</ul>
<h1 id="system-design-sales-rank">System Design: Sales Rank</h1>
<h1 id="design-amazons-sales-rank-by-category-feature">Design Amazon’s
sales rank by category feature</h1>
<p><em>Note: This document links directly to relevant areas found in the
<a
href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system
design topics</a> to avoid duplication. Refer to the linked content for
general talking points, tradeoffs, and alternatives.</em></p>
<h2 id="step-1-outline-use-cases-and-constraints-6">Step 1: Outline use
cases and constraints</h2>
<blockquote>
<p>Gather requirements and scope the problem. Ask questions to clarify
use cases and constraints. Discuss assumptions.</p>
</blockquote>
<p>Without an interviewer to address clarifying questions, we’ll define
some use cases and constraints.</p>
<h3 id="use-cases-6">Use cases</h3>
<h4
id="well-scope-the-problem-to-handle-only-the-following-use-case">We’ll
scope the problem to handle only the following use case</h4>
<ul>
<li><strong>Service</strong> calculates the past week’s most popular
products by category</li>
<li><strong>User</strong> views the past week’s most popular products by
category</li>
<li><strong>Service</strong> has high availability</li>
</ul>
<h4 id="out-of-scope-4">Out of scope</h4>
<ul>
<li>The general e-commerce site
<ul>
<li>Design components only for calculating sales rank</li>
</ul></li>
</ul>
<h3 id="constraints-and-assumptions-6">Constraints and assumptions</h3>
<h4 id="state-assumptions-6">State assumptions</h4>
<ul>
<li>Traffic is not evenly distributed</li>
<li>Items can be in multiple categories</li>
<li>Items cannot change categories</li>
<li>There are no subcategories ie <code>foo/bar/baz</code></li>
<li>Results must be updated hourly
<ul>
<li>More popular products might need to be updated more frequently</li>
</ul></li>
<li>10 million products</li>
<li>1000 categories</li>
<li>1 billion transactions per month</li>
<li>100 billion read requests per month</li>
<li>100:1 read to write ratio</li>
</ul>
<h4 id="calculate-usage-6">Calculate usage</h4>
<p><strong>Clarify with your interviewer if you should run
back-of-the-envelope usage calculations.</strong></p>
<ul>
<li>Size per transaction:
<ul>
<li><code>created_at</code> - 5 bytes</li>
<li><code>product_id</code> - 8 bytes</li>
<li><code>category_id</code> - 4 bytes</li>
<li><code>seller_id</code> - 8 bytes</li>
<li><code>buyer_id</code> - 8 bytes</li>
<li><code>quantity</code> - 4 bytes</li>
<li><code>total_price</code> - 5 bytes</li>
<li>Total: ~40 bytes</li>
</ul></li>
<li>40 GB of new transaction content per month
<ul>
<li>40 bytes per transaction * 1 billion transactions per month</li>
<li>1.44 TB of new transaction content in 3 years</li>
<li>Assume most are new transactions instead of updates to existing
ones</li>
</ul></li>
<li>400 transactions per second on average</li>
<li>40,000 read requests per second on average</li>
</ul>
<p>Handy conversion guide:</p>
<ul>
<li>2.5 million seconds per month</li>
<li>1 request per second = 2.5 million requests per month</li>
<li>40 requests per second = 100 million requests per month</li>
<li>400 requests per second = 1 billion requests per month</li>
</ul>
<h2 id="step-2-create-a-high-level-design-7">Step 2: Create a high level
design</h2>
<blockquote>
<p>Outline a high level design with all important components.</p>
</blockquote>
<figure>
<img src="http://i.imgur.com/vwMa1Qu.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h2 id="step-3-design-core-components-7">Step 3: Design core
components</h2>
<blockquote>
<p>Dive into details for each core component.</p>
</blockquote>
<h3
id="use-case-service-calculates-the-past-weeks-most-popular-products-by-category">Use
case: Service calculates the past week’s most popular products by
category</h3>
<p>We could store the raw <strong>Sales API</strong> server log files on
a managed <strong>Object Store</strong> such as Amazon S3, rather than
managing our own distributed file system.</p>
<p><strong>Clarify with your interviewer how much code you are expected
to write</strong>.</p>
<p>We’ll assume this is a sample log entry, tab delimited:</p>
<pre><code>timestamp   product_id  category_id    qty     total_price   seller_id    buyer_id
t1          product1    category1      2       20.00         1            1
t2          product1    category2      2       20.00         2            2
t2          product1    category2      1       10.00         2            3
t3          product2    category1      3        7.00         3            4
t4          product3    category2      7        2.00         4            5
t5          product4    category1      1        5.00         5            6
...</code></pre>
<p>The <strong>Sales Rank Service</strong> could use
<strong>MapReduce</strong>, using the <strong>Sales API</strong> server
log files as input and writing the results to an aggregate table
<code>sales_rank</code> in a <strong>SQL Database</strong>. We should
discuss the <a
href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">use
cases and tradeoffs between choosing SQL or NoSQL</a>.</p>
<p>We’ll use a multi-step <strong>MapReduce</strong>:</p>
<ul>
<li><strong>Step 1</strong> - Transform the data to
<code>(category, product_id), sum(quantity)</code></li>
<li><strong>Step 2</strong> - Perform a distributed sort</li>
</ul>
<div class="sourceCode" id="cb57"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SalesRanker(MRJob):</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> within_past_week(<span class="va">self</span>, timestamp):</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Return True if timestamp is within past week, False otherwise.&quot;&quot;&quot;</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>        ...</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mapper(<span class="va">self</span>, _ line):</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Parse each log line, extract and transform relevant lines.</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Emit key value pairs of the form:</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="co">        (category1, product1), 2</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a><span class="co">        (category2, product1), 2</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="co">        (category2, product1), 1</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a><span class="co">        (category1, product2), 3</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a><span class="co">        (category2, product3), 7</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a><span class="co">        (category1, product4), 1</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>        timestamp, product_id, category_id, quantity, total_price, seller_id, <span class="op">\</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>            buyer_id <span class="op">=</span> line.split(<span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>)</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.within_past_week(timestamp):</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> (category_id, product_id), quantity</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reducer(<span class="va">self</span>, key, value):</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Sum values for each key.</span></span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a><span class="co">        (category1, product1), 2</span></span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a><span class="co">        (category2, product1), 3</span></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a><span class="co">        (category1, product2), 3</span></span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a><span class="co">        (category2, product3), 7</span></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a><span class="co">        (category1, product4), 1</span></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> key, <span class="bu">sum</span>(values)</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> mapper_sort(<span class="va">self</span>, key, value):</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Construct key to ensure proper sorting.</span></span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a><span class="co">        Transform key and value to the form:</span></span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a><span class="co">        (category1, 2), product1</span></span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a><span class="co">        (category2, 3), product1</span></span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a><span class="co">        (category1, 3), product2</span></span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a><span class="co">        (category2, 7), product3</span></span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a><span class="co">        (category1, 1), product4</span></span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a><span class="co">        The shuffle/sort step of MapReduce will then do a</span></span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a><span class="co">        distributed sort on the keys, resulting in:</span></span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a><span class="co">        (category1, 1), product4</span></span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a><span class="co">        (category1, 2), product1</span></span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a><span class="co">        (category1, 3), product2</span></span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a><span class="co">        (category2, 3), product1</span></span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a><span class="co">        (category2, 7), product3</span></span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a>        category_id, product_id <span class="op">=</span> key</span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a>        quantity <span class="op">=</span> value</span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> (category_id, quantity), product_id</span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reducer_identity(<span class="va">self</span>, key, value):</span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> key, value</span>
<span id="cb57-61"><a href="#cb57-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-62"><a href="#cb57-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> steps(<span class="va">self</span>):</span>
<span id="cb57-63"><a href="#cb57-63" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Run the map and reduce steps.&quot;&quot;&quot;</span></span>
<span id="cb57-64"><a href="#cb57-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [</span>
<span id="cb57-65"><a href="#cb57-65" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.mr(mapper<span class="op">=</span><span class="va">self</span>.mapper,</span>
<span id="cb57-66"><a href="#cb57-66" aria-hidden="true" tabindex="-1"></a>                    reducer<span class="op">=</span><span class="va">self</span>.reducer),</span>
<span id="cb57-67"><a href="#cb57-67" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.mr(mapper<span class="op">=</span><span class="va">self</span>.mapper_sort,</span>
<span id="cb57-68"><a href="#cb57-68" aria-hidden="true" tabindex="-1"></a>                    reducer<span class="op">=</span><span class="va">self</span>.reducer_identity),</span>
<span id="cb57-69"><a href="#cb57-69" aria-hidden="true" tabindex="-1"></a>        ]</span></code></pre></div>
<p>The result would be the following sorted list, which we could insert
into the <code>sales_rank</code> table:</p>
<pre><code>(category1, 1), product4
(category1, 2), product1
(category1, 3), product2
(category2, 3), product1
(category2, 7), product3</code></pre>
<p>The <code>sales_rank</code> table could have the following
structure:</p>
<pre><code>id int NOT NULL AUTO_INCREMENT
category_id int NOT NULL
total_sold int NOT NULL
product_id int NOT NULL
PRIMARY KEY(id)
FOREIGN KEY(category_id) REFERENCES Categories(id)
FOREIGN KEY(product_id) REFERENCES Products(id)</code></pre>
<p>We’ll create an <a
href="https://github.com/donnemartin/system-design-primer#use-good-indices">index</a>
on <code>id</code>, <code>category_id</code>, and
<code>product_id</code> to speed up lookups (log-time instead of
scanning the entire table) and to keep the data in memory. Reading 1 MB
sequentially from memory takes about 250 microseconds, while reading
from SSD takes 4x and from disk takes 80x
longer.<sup><a href=https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know>1</a></sup></p>
<h3
id="use-case-user-views-the-past-weeks-most-popular-products-by-category">Use
case: User views the past week’s most popular products by category</h3>
<ul>
<li>The <strong>Client</strong> sends a request to the <strong>Web
Server</strong>, running as a <a
href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">reverse
proxy</a></li>
<li>The <strong>Web Server</strong> forwards the request to the
<strong>Read API</strong> server</li>
<li>The <strong>Read API</strong> server reads from the <strong>SQL
Database</strong> <code>sales_rank</code> table</li>
</ul>
<p>We’ll use a public <a
href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest"><strong>REST
API</strong></a>:</p>
<pre><code>$ curl https://amazon.com/api/v1/popular?category_id=1234</code></pre>
<p>Response:</p>
<pre><code>{
    &quot;id&quot;: &quot;100&quot;,
    &quot;category_id&quot;: &quot;1234&quot;,
    &quot;total_sold&quot;: &quot;100000&quot;,
    &quot;product_id&quot;: &quot;50&quot;,
},
{
    &quot;id&quot;: &quot;53&quot;,
    &quot;category_id&quot;: &quot;1234&quot;,
    &quot;total_sold&quot;: &quot;90000&quot;,
    &quot;product_id&quot;: &quot;200&quot;,
},
{
    &quot;id&quot;: &quot;75&quot;,
    &quot;category_id&quot;: &quot;1234&quot;,
    &quot;total_sold&quot;: &quot;80000&quot;,
    &quot;product_id&quot;: &quot;3&quot;,
},</code></pre>
<p>For internal communications, we could use <a
href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">Remote
Procedure Calls</a>.</p>
<h2 id="step-4-scale-the-design-7">Step 4: Scale the design</h2>
<blockquote>
<p>Identify and address bottlenecks, given the constraints.</p>
</blockquote>
<figure>
<img src="http://i.imgur.com/MzExP06.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<p><strong>Important: Do not simply jump right into the final design
from the initial design!</strong></p>
<p>State you would 1) <strong>Benchmark/Load Test</strong>, 2)
<strong>Profile</strong> for bottlenecks 3) address bottlenecks while
evaluating alternatives and trade-offs, and 4) repeat. See <a
href="#scaling-aws">Design a system that scales to millions of users on
AWS</a> as a sample on how to iteratively scale the initial design.</p>
<p>It’s important to discuss what bottlenecks you might encounter with
the initial design and how you might address each of them. For example,
what issues are addressed by adding a <strong>Load Balancer</strong>
with multiple <strong>Web Servers</strong>? <strong>CDN</strong>?
<strong>Master-Slave Replicas</strong>? What are the alternatives and
<strong>Trade-Offs</strong> for each?</p>
<p>We’ll introduce some components to complete the design and to address
scalability issues. Internal load balancers are not shown to reduce
clutter.</p>
<p><em>To avoid repeating discussions</em>, refer to the following <a
href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system
design topics</a> for main talking points, tradeoffs, and
alternatives:</p>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#domain-name-system">DNS</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#content-delivery-network">CDN</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#load-balancer">Load
balancer</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#horizontal-scaling">Horizontal
scaling</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server">Web
server (reverse proxy)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#application-layer">API
server (application layer)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#cache">Cache</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#relational-database-management-system-rdbms">Relational
database management system (RDBMS)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#fail-over">SQL
write master-slave failover</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#master-slave-replication">Master-slave
replication</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#consistency-patterns">Consistency
patterns</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#availability-patterns">Availability
patterns</a></li>
</ul>
<p>The <strong>Analytics Database</strong> could use a data warehousing
solution such as Amazon Redshift or Google BigQuery.</p>
<p>We might only want to store a limited time period of data in the
database, while storing the rest in a data warehouse or in an
<strong>Object Store</strong>. An <strong>Object Store</strong> such as
Amazon S3 can comfortably handle the constraint of 40 GB of new content
per month.</p>
<p>To address the 40,000 <em>average</em> read requests per second
(higher at peak), traffic for popular content (and their sales rank)
should be handled by the <strong>Memory Cache</strong> instead of the
database. The <strong>Memory Cache</strong> is also useful for handling
the unevenly distributed traffic and traffic spikes. With the large
volume of reads, the <strong>SQL Read Replicas</strong> might not be
able to handle the cache misses. We’ll probably need to employ
additional SQL scaling patterns.</p>
<p>400 <em>average</em> writes per second (higher at peak) might be
tough for a single <strong>SQL Write Master-Slave</strong>, also
pointing to a need for additional scaling techniques.</p>
<p>SQL scaling patterns include:</p>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#federation">Federation</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sharding">Sharding</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#denormalization">Denormalization</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-tuning">SQL
Tuning</a></li>
</ul>
<p>We should also consider moving some data to a <strong>NoSQL
Database</strong>.</p>
<h2 id="additional-talking-points-6">Additional talking points</h2>
<blockquote>
<p>Additional topics to dive into, depending on the problem scope and
time remaining.</p>
</blockquote>
<h4 id="nosql-7">NoSQL</h4>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#key-value-store">Key-value
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#document-store">Document
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#wide-column-store">Wide
column store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#graph-database">Graph
database</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">SQL
vs NoSQL</a></li>
</ul>
<h3 id="caching-6">Caching</h3>
<ul>
<li>Where to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#client-caching">Client
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#cdn-caching">CDN
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#web-server-caching">Web
server caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#database-caching">Database
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#application-caching">Application
caching</a></li>
</ul></li>
<li>What to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-database-query-level">Caching
at the database query level</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-object-level">Caching
at the object level</a></li>
</ul></li>
<li>When to update the cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#cache-aside">Cache-aside</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-through">Write-through</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-behind-write-back">Write-behind
(write-back)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#refresh-ahead">Refresh
ahead</a></li>
</ul></li>
</ul>
<h3 id="asynchronism-and-microservices-6">Asynchronism and
microservices</h3>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#message-queues">Message
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#task-queues">Task
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#back-pressure">Back
pressure</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#microservices">Microservices</a></li>
</ul>
<h3 id="communications-6">Communications</h3>
<ul>
<li>Discuss tradeoffs:
<ul>
<li>External communication with clients - <a
href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest">HTTP
APIs following REST</a></li>
<li>Internal communications - <a
href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">RPC</a></li>
</ul></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#service-discovery">Service
discovery</a></li>
</ul>
<h3 id="security-7">Security</h3>
<p>Refer to the <a
href="https://github.com/donnemartin/system-design-primer#security">security
section</a>.</p>
<h3 id="latency-numbers-6">Latency numbers</h3>
<p>See <a
href="https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know">Latency
numbers every programmer should know</a>.</p>
<h3 id="ongoing-6">Ongoing</h3>
<ul>
<li>Continue benchmarking and monitoring your system to address
bottlenecks as they come up</li>
<li>Scaling is an iterative process</li>
</ul>
<h1 id="system-design-scaling-aws">System Design: Scaling Aws</h1>
<h1
id="design-a-system-that-scales-to-millions-of-users-on-aws-1">Design a
system that scales to millions of users on AWS</h1>
<p><em>Note: This document links directly to relevant areas found in the
<a
href="https://github.com/donnemartin/system-design-primer#index-of-system-design-topics">system
design topics</a> to avoid duplication. Refer to the linked content for
general talking points, tradeoffs, and alternatives.</em></p>
<h2 id="step-1-outline-use-cases-and-constraints-7">Step 1: Outline use
cases and constraints</h2>
<blockquote>
<p>Gather requirements and scope the problem. Ask questions to clarify
use cases and constraints. Discuss assumptions.</p>
</blockquote>
<p>Without an interviewer to address clarifying questions, we’ll define
some use cases and constraints.</p>
<h3 id="use-cases-7">Use cases</h3>
<p>Solving this problem takes an iterative approach of: 1)
<strong>Benchmark/Load Test</strong>, 2) <strong>Profile</strong> for
bottlenecks 3) address bottlenecks while evaluating alternatives and
trade-offs, and 4) repeat, which is good pattern for evolving basic
designs to scalable designs.</p>
<p>Unless you have a background in AWS or are applying for a position
that requires AWS knowledge, AWS-specific details are not a requirement.
However, <strong>much of the principles discussed in this exercise can
apply more generally outside of the AWS ecosystem.</strong></p>
<h4
id="well-scope-the-problem-to-handle-only-the-following-use-cases-6">We’ll
scope the problem to handle only the following use cases</h4>
<ul>
<li><strong>User</strong> makes a read or write request
<ul>
<li><strong>Service</strong> does processing, stores user data, then
returns the results</li>
</ul></li>
<li><strong>Service</strong> needs to evolve from serving a small amount
of users to millions of users
<ul>
<li>Discuss general scaling patterns as we evolve an architecture to
handle a large number of users and requests</li>
</ul></li>
<li><strong>Service</strong> has high availability</li>
</ul>
<h3 id="constraints-and-assumptions-7">Constraints and assumptions</h3>
<h4 id="state-assumptions-7">State assumptions</h4>
<ul>
<li>Traffic is not evenly distributed</li>
<li>Need for relational data</li>
<li>Scale from 1 user to tens of millions of users
<ul>
<li>Denote increase of users as:
<ul>
<li>Users+</li>
<li>Users++</li>
<li>Users+++</li>
<li>…</li>
</ul></li>
<li>10 million users</li>
<li>1 billion writes per month</li>
<li>100 billion reads per month</li>
<li>100:1 read to write ratio</li>
<li>1 KB content per write</li>
</ul></li>
</ul>
<h4 id="calculate-usage-7">Calculate usage</h4>
<p><strong>Clarify with your interviewer if you should run
back-of-the-envelope usage calculations.</strong></p>
<ul>
<li>1 TB of new content per month
<ul>
<li>1 KB per write * 1 billion writes per month</li>
<li>36 TB of new content in 3 years</li>
<li>Assume most writes are from new content instead of updates to
existing ones</li>
</ul></li>
<li>400 writes per second on average</li>
<li>40,000 reads per second on average</li>
</ul>
<p>Handy conversion guide:</p>
<ul>
<li>2.5 million seconds per month</li>
<li>1 request per second = 2.5 million requests per month</li>
<li>40 requests per second = 100 million requests per month</li>
<li>400 requests per second = 1 billion requests per month</li>
</ul>
<h2 id="step-2-create-a-high-level-design-8">Step 2: Create a high level
design</h2>
<blockquote>
<p>Outline a high level design with all important components.</p>
</blockquote>
<figure>
<img src="http://i.imgur.com/B8LDKD7.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h2 id="step-3-design-core-components-8">Step 3: Design core
components</h2>
<blockquote>
<p>Dive into details for each core component.</p>
</blockquote>
<h3 id="use-case-user-makes-a-read-or-write-request">Use case: User
makes a read or write request</h3>
<h4 id="goals">Goals</h4>
<ul>
<li>With only 1-2 users, you only need a basic setup
<ul>
<li>Single box for simplicity</li>
<li>Vertical scaling when needed</li>
<li>Monitor to determine bottlenecks</li>
</ul></li>
</ul>
<h4 id="start-with-a-single-box">Start with a single box</h4>
<ul>
<li><strong>Web server</strong> on EC2
<ul>
<li>Storage for user data</li>
<li><a
href="https://github.com/donnemartin/system-design-primer#relational-database-management-system-rdbms"><strong>MySQL
Database</strong></a></li>
</ul></li>
</ul>
<p>Use <strong>Vertical Scaling</strong>:</p>
<ul>
<li>Simply choose a bigger box</li>
<li>Keep an eye on metrics to determine how to scale up
<ul>
<li>Use basic monitoring to determine bottlenecks: CPU, memory, IO,
network, etc</li>
<li>CloudWatch, top, nagios, statsd, graphite, etc</li>
</ul></li>
<li>Scaling vertically can get very expensive</li>
<li>No redundancy/failover</li>
</ul>
<p><em>Trade-offs, alternatives, and additional details:</em></p>
<ul>
<li>The alternative to <strong>Vertical Scaling</strong> is <a
href="https://github.com/donnemartin/system-design-primer#horizontal-scaling"><strong>Horizontal
scaling</strong></a></li>
</ul>
<h4 id="start-with-sql-consider-nosql">Start with SQL, consider
NoSQL</h4>
<p>The constraints assume there is a need for relational data. We can
start off using a <strong>MySQL Database</strong> on the single box.</p>
<p><em>Trade-offs, alternatives, and additional details:</em></p>
<ul>
<li>See the <a
href="https://github.com/donnemartin/system-design-primer#relational-database-management-system-rdbms">Relational
database management system (RDBMS)</a> section</li>
<li>Discuss reasons to use <a
href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">SQL
or NoSQL</a></li>
</ul>
<h4 id="assign-a-public-static-ip">Assign a public static IP</h4>
<ul>
<li>Elastic IPs provide a public endpoint whose IP doesn’t change on
reboot</li>
<li>Helps with failover, just point the domain to a new IP</li>
</ul>
<h4 id="use-a-dns">Use a DNS</h4>
<p>Add a <strong>DNS</strong> such as Route 53 to map the domain to the
instance’s public IP.</p>
<p><em>Trade-offs, alternatives, and additional details:</em></p>
<ul>
<li>See the <a
href="https://github.com/donnemartin/system-design-primer#domain-name-system">Domain
name system</a> section</li>
</ul>
<h4 id="secure-the-web-server">Secure the web server</h4>
<ul>
<li>Open up only necessary ports
<ul>
<li>Allow the web server to respond to incoming requests from:
<ul>
<li>80 for HTTP</li>
<li>443 for HTTPS</li>
<li>22 for SSH to only whitelisted IPs</li>
</ul></li>
<li>Prevent the web server from initiating outbound connections</li>
</ul></li>
</ul>
<p><em>Trade-offs, alternatives, and additional details:</em></p>
<ul>
<li>See the <a
href="https://github.com/donnemartin/system-design-primer#security">Security</a>
section</li>
</ul>
<h2 id="step-4-scale-the-design-8">Step 4: Scale the design</h2>
<blockquote>
<p>Identify and address bottlenecks, given the constraints.</p>
</blockquote>
<h3 id="users">Users+</h3>
<figure>
<img src="http://i.imgur.com/rrfjMXB.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h4 id="assumptions">Assumptions</h4>
<p>Our user count is starting to pick up and the load is increasing on
our single box. Our <strong>Benchmarks/Load Tests</strong> and
<strong>Profiling</strong> are pointing to the <strong>MySQL
Database</strong> taking up more and more memory and CPU resources,
while the user content is filling up disk space.</p>
<p>We’ve been able to address these issues with <strong>Vertical
Scaling</strong> so far. Unfortunately, this has become quite expensive
and it doesn’t allow for independent scaling of the <strong>MySQL
Database</strong> and <strong>Web Server</strong>.</p>
<h4 id="goals-1">Goals</h4>
<ul>
<li>Lighten load on the single box and allow for independent scaling
<ul>
<li>Store static content separately in an <strong>Object
Store</strong></li>
<li>Move the <strong>MySQL Database</strong> to a separate box</li>
</ul></li>
<li>Disadvantages
<ul>
<li>These changes would increase complexity and would require changes to
the <strong>Web Server</strong> to point to the <strong>Object
Store</strong> and the <strong>MySQL Database</strong></li>
<li>Additional security measures must be taken to secure the new
components</li>
<li>AWS costs could also increase, but should be weighed with the costs
of managing similar systems on your own</li>
</ul></li>
</ul>
<h4 id="store-static-content-separately">Store static content
separately</h4>
<ul>
<li>Consider using a managed <strong>Object Store</strong> like S3 to
store static content
<ul>
<li>Highly scalable and reliable</li>
<li>Server side encryption</li>
</ul></li>
<li>Move static content to S3
<ul>
<li>User files</li>
<li>JS</li>
<li>CSS</li>
<li>Images</li>
<li>Videos</li>
</ul></li>
</ul>
<h4 id="move-the-mysql-database-to-a-separate-box">Move the MySQL
database to a separate box</h4>
<ul>
<li>Consider using a service like RDS to manage the <strong>MySQL
Database</strong>
<ul>
<li>Simple to administer, scale</li>
<li>Multiple availability zones</li>
<li>Encryption at rest</li>
</ul></li>
</ul>
<h4 id="secure-the-system">Secure the system</h4>
<ul>
<li>Encrypt data in transit and at rest</li>
<li>Use a Virtual Private Cloud
<ul>
<li>Create a public subnet for the single <strong>Web Server</strong> so
it can send and receive traffic from the internet</li>
<li>Create a private subnet for everything else, preventing outside
access</li>
<li>Only open ports from whitelisted IPs for each component</li>
</ul></li>
<li>These same patterns should be implemented for new components in the
remainder of the exercise</li>
</ul>
<p><em>Trade-offs, alternatives, and additional details:</em></p>
<ul>
<li>See the <a
href="https://github.com/donnemartin/system-design-primer#security">Security</a>
section</li>
</ul>
<h3 id="users-1">Users++</h3>
<figure>
<img src="http://i.imgur.com/raoFTXM.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h4 id="assumptions-1">Assumptions</h4>
<p>Our <strong>Benchmarks/Load Tests</strong> and
<strong>Profiling</strong> show that our single <strong>Web
Server</strong> bottlenecks during peak hours, resulting in slow
responses and in some cases, downtime. As the service matures, we’d also
like to move towards higher availability and redundancy.</p>
<h4 id="goals-2">Goals</h4>
<ul>
<li>The following goals attempt to address the scaling issues with the
<strong>Web Server</strong>
<ul>
<li>Based on the <strong>Benchmarks/Load Tests</strong> and
<strong>Profiling</strong>, you might only need to implement one or two
of these techniques</li>
</ul></li>
<li>Use <a
href="https://github.com/donnemartin/system-design-primer#horizontal-scaling"><strong>Horizontal
Scaling</strong></a> to handle increasing loads and to address single
points of failure
<ul>
<li>Add a <a
href="https://github.com/donnemartin/system-design-primer#load-balancer"><strong>Load
Balancer</strong></a> such as Amazon’s ELB or HAProxy
<ul>
<li>ELB is highly available</li>
<li>If you are configuring your own <strong>Load Balancer</strong>,
setting up multiple servers in <a
href="https://github.com/donnemartin/system-design-primer#active-active">active-active</a>
or <a
href="https://github.com/donnemartin/system-design-primer#active-passive">active-passive</a>
in multiple availability zones will improve availability</li>
<li>Terminate SSL on the <strong>Load Balancer</strong> to reduce
computational load on backend servers and to simplify certificate
administration</li>
</ul></li>
<li>Use multiple <strong>Web Servers</strong> spread out over multiple
availability zones</li>
<li>Use multiple <strong>MySQL</strong> instances in <a
href="https://github.com/donnemartin/system-design-primer#master-slave-replication"><strong>Master-Slave
Failover</strong></a> mode across multiple availability zones to improve
redundancy</li>
</ul></li>
<li>Separate out the <strong>Web Servers</strong> from the <a
href="https://github.com/donnemartin/system-design-primer#application-layer"><strong>Application
Servers</strong></a>
<ul>
<li>Scale and configure both layers independently</li>
<li><strong>Web Servers</strong> can run as a <a
href="https://github.com/donnemartin/system-design-primer#reverse-proxy-web-server"><strong>Reverse
Proxy</strong></a></li>
<li>For example, you can add <strong>Application Servers</strong>
handling <strong>Read APIs</strong> while others handle <strong>Write
APIs</strong></li>
</ul></li>
<li>Move static (and some dynamic) content to a <a
href="https://github.com/donnemartin/system-design-primer#content-delivery-network"><strong>Content
Delivery Network (CDN)</strong></a> such as CloudFront to reduce load
and latency</li>
</ul>
<p><em>Trade-offs, alternatives, and additional details:</em></p>
<ul>
<li>See the linked content above for details</li>
</ul>
<h3 id="users-2">Users+++</h3>
<figure>
<img src="http://i.imgur.com/OZCxJr0.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<p><strong>Note:</strong> <strong>Internal Load Balancers</strong> not
shown to reduce clutter</p>
<h4 id="assumptions-2">Assumptions</h4>
<p>Our <strong>Benchmarks/Load Tests</strong> and
<strong>Profiling</strong> show that we are read-heavy (100:1 with
writes) and our database is suffering from poor performance from the
high read requests.</p>
<h4 id="goals-3">Goals</h4>
<ul>
<li>The following goals attempt to address the scaling issues with the
<strong>MySQL Database</strong>
<ul>
<li>Based on the <strong>Benchmarks/Load Tests</strong> and
<strong>Profiling</strong>, you might only need to implement one or two
of these techniques</li>
</ul></li>
<li>Move the following data to a <a
href="https://github.com/donnemartin/system-design-primer#cache"><strong>Memory
Cache</strong></a> such as Elasticache to reduce load and latency:
<ul>
<li>Frequently accessed content from <strong>MySQL</strong>
<ul>
<li>First, try to configure the <strong>MySQL Database</strong> cache to
see if that is sufficient to relieve the bottleneck before implementing
a <strong>Memory Cache</strong></li>
</ul></li>
<li>Session data from the <strong>Web Servers</strong>
<ul>
<li>The <strong>Web Servers</strong> become stateless, allowing for
<strong>Autoscaling</strong></li>
</ul></li>
<li>Reading 1 MB sequentially from memory takes about 250 microseconds,
while reading from SSD takes 4x and from disk takes 80x
longer.<sup><a href=https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know>1</a></sup></li>
</ul></li>
<li>Add <a
href="https://github.com/donnemartin/system-design-primer#master-slave-replication"><strong>MySQL
Read Replicas</strong></a> to reduce load on the write master</li>
<li>Add more <strong>Web Servers</strong> and <strong>Application
Servers</strong> to improve responsiveness</li>
</ul>
<p><em>Trade-offs, alternatives, and additional details:</em></p>
<ul>
<li>See the linked content above for details</li>
</ul>
<h4 id="add-mysql-read-replicas">Add MySQL read replicas</h4>
<ul>
<li>In addition to adding and scaling a <strong>Memory Cache</strong>,
<strong>MySQL Read Replicas</strong> can also help relieve load on the
<strong>MySQL Write Master</strong></li>
<li>Add logic to <strong>Web Server</strong> to separate out writes and
reads</li>
<li>Add <strong>Load Balancers</strong> in front of <strong>MySQL Read
Replicas</strong> (not pictured to reduce clutter)</li>
<li>Most services are read-heavy vs write-heavy</li>
</ul>
<p><em>Trade-offs, alternatives, and additional details:</em></p>
<ul>
<li>See the <a
href="https://github.com/donnemartin/system-design-primer#relational-database-management-system-rdbms">Relational
database management system (RDBMS)</a> section</li>
</ul>
<h3 id="users-3">Users++++</h3>
<figure>
<img src="http://i.imgur.com/3X8nmdL.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<h4 id="assumptions-3">Assumptions</h4>
<p>Our <strong>Benchmarks/Load Tests</strong> and
<strong>Profiling</strong> show that our traffic spikes during regular
business hours in the U.S. and drop significantly when users leave the
office. We think we can cut costs by automatically spinning up and down
servers based on actual load. We’re a small shop so we’d like to
automate as much of the DevOps as possible for
<strong>Autoscaling</strong> and for the general operations.</p>
<h4 id="goals-4">Goals</h4>
<ul>
<li>Add <strong>Autoscaling</strong> to provision capacity as needed
<ul>
<li>Keep up with traffic spikes</li>
<li>Reduce costs by powering down unused instances</li>
</ul></li>
<li>Automate DevOps
<ul>
<li>Chef, Puppet, Ansible, etc</li>
</ul></li>
<li>Continue monitoring metrics to address bottlenecks
<ul>
<li><strong>Host level</strong> - Review a single EC2 instance</li>
<li><strong>Aggregate level</strong> - Review load balancer stats</li>
<li><strong>Log analysis</strong> - CloudWatch, CloudTrail, Loggly,
Splunk, Sumo</li>
<li><strong>External site performance</strong> - Pingdom or New
Relic</li>
<li><strong>Handle notifications and incidents</strong> - PagerDuty</li>
<li><strong>Error Reporting</strong> - Sentry</li>
</ul></li>
</ul>
<h4 id="add-autoscaling">Add autoscaling</h4>
<ul>
<li>Consider a managed service such as AWS <strong>Autoscaling</strong>
<ul>
<li>Create one group for each <strong>Web Server</strong> and one for
each <strong>Application Server</strong> type, place each group in
multiple availability zones</li>
<li>Set a min and max number of instances</li>
<li>Trigger to scale up and down through CloudWatch
<ul>
<li>Simple time of day metric for predictable loads or</li>
<li>Metrics over a time period:
<ul>
<li>CPU load</li>
<li>Latency</li>
<li>Network traffic</li>
<li>Custom metric</li>
</ul></li>
</ul></li>
<li>Disadvantages
<ul>
<li>Autoscaling can introduce complexity</li>
<li>It could take some time before a system appropriately scales up to
meet increased demand, or to scale down when demand drops</li>
</ul></li>
</ul></li>
</ul>
<h3 id="users-4">Users+++++</h3>
<figure>
<img src="http://i.imgur.com/jj3A5N8.png" alt="Imgur" />
<figcaption aria-hidden="true">Imgur</figcaption>
</figure>
<p><strong>Note:</strong> <strong>Autoscaling</strong> groups not shown
to reduce clutter</p>
<h4 id="assumptions-4">Assumptions</h4>
<p>As the service continues to grow towards the figures outlined in the
constraints, we iteratively run <strong>Benchmarks/Load Tests</strong>
and <strong>Profiling</strong> to uncover and address new
bottlenecks.</p>
<h4 id="goals-5">Goals</h4>
<p>We’ll continue to address scaling issues due to the problem’s
constraints:</p>
<ul>
<li>If our <strong>MySQL Database</strong> starts to grow too large, we
might consider only storing a limited time period of data in the
database, while storing the rest in a data warehouse such as Redshift
<ul>
<li>A data warehouse such as Redshift can comfortably handle the
constraint of 1 TB of new content per month</li>
</ul></li>
<li>With 40,000 average read requests per second, read traffic for
popular content can be addressed by scaling the <strong>Memory
Cache</strong>, which is also useful for handling the unevenly
distributed traffic and traffic spikes
<ul>
<li>The <strong>SQL Read Replicas</strong> might have trouble handling
the cache misses, we’ll probably need to employ additional SQL scaling
patterns</li>
</ul></li>
<li>400 average writes per second (with presumably significantly higher
peaks) might be tough for a single <strong>SQL Write
Master-Slave</strong>, also pointing to a need for additional scaling
techniques</li>
</ul>
<p>SQL scaling patterns include:</p>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#federation">Federation</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sharding">Sharding</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#denormalization">Denormalization</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-tuning">SQL
Tuning</a></li>
</ul>
<p>To further address the high read and write requests, we should also
consider moving appropriate data to a <a
href="https://github.com/donnemartin/system-design-primer#nosql"><strong>NoSQL
Database</strong></a> such as DynamoDB.</p>
<p>We can further separate out our <a
href="https://github.com/donnemartin/system-design-primer#application-layer"><strong>Application
Servers</strong></a> to allow for independent scaling. Batch processes
or computations that do not need to be done in real-time can be done <a
href="https://github.com/donnemartin/system-design-primer#asynchronism"><strong>Asynchronously</strong></a>
with <strong>Queues</strong> and <strong>Workers</strong>:</p>
<ul>
<li>For example, in a photo service, the photo upload and the thumbnail
creation can be separated:
<ul>
<li><strong>Client</strong> uploads photo</li>
<li><strong>Application Server</strong> puts a job in a
<strong>Queue</strong> such as SQS</li>
<li>The <strong>Worker Service</strong> on EC2 or Lambda pulls work off
the <strong>Queue</strong> then:
<ul>
<li>Creates a thumbnail</li>
<li>Updates a <strong>Database</strong></li>
<li>Stores the thumbnail in the <strong>Object Store</strong></li>
</ul></li>
</ul></li>
</ul>
<p><em>Trade-offs, alternatives, and additional details:</em></p>
<ul>
<li>See the linked content above for details</li>
</ul>
<h2 id="additional-talking-points-7">Additional talking points</h2>
<blockquote>
<p>Additional topics to dive into, depending on the problem scope and
time remaining.</p>
</blockquote>
<h3 id="sql-scaling-patterns-3">SQL scaling patterns</h3>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#master-slave-replication">Read
replicas</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#federation">Federation</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sharding">Sharding</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#denormalization">Denormalization</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-tuning">SQL
Tuning</a></li>
</ul>
<h4 id="nosql-8">NoSQL</h4>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#key-value-store">Key-value
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#document-store">Document
store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#wide-column-store">Wide
column store</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#graph-database">Graph
database</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#sql-or-nosql">SQL
vs NoSQL</a></li>
</ul>
<h3 id="caching-7">Caching</h3>
<ul>
<li>Where to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#client-caching">Client
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#cdn-caching">CDN
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#web-server-caching">Web
server caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#database-caching">Database
caching</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#application-caching">Application
caching</a></li>
</ul></li>
<li>What to cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-database-query-level">Caching
at the database query level</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#caching-at-the-object-level">Caching
at the object level</a></li>
</ul></li>
<li>When to update the cache
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#cache-aside">Cache-aside</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-through">Write-through</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#write-behind-write-back">Write-behind
(write-back)</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#refresh-ahead">Refresh
ahead</a></li>
</ul></li>
</ul>
<h3 id="asynchronism-and-microservices-7">Asynchronism and
microservices</h3>
<ul>
<li><a
href="https://github.com/donnemartin/system-design-primer#message-queues">Message
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#task-queues">Task
queues</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#back-pressure">Back
pressure</a></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#microservices">Microservices</a></li>
</ul>
<h3 id="communications-7">Communications</h3>
<ul>
<li>Discuss tradeoffs:
<ul>
<li>External communication with clients - <a
href="https://github.com/donnemartin/system-design-primer#representational-state-transfer-rest">HTTP
APIs following REST</a></li>
<li>Internal communications - <a
href="https://github.com/donnemartin/system-design-primer#remote-procedure-call-rpc">RPC</a></li>
</ul></li>
<li><a
href="https://github.com/donnemartin/system-design-primer#service-discovery">Service
discovery</a></li>
</ul>
<h3 id="security-8">Security</h3>
<p>Refer to the <a
href="https://github.com/donnemartin/system-design-primer#security">security
section</a>.</p>
<h3 id="latency-numbers-7">Latency numbers</h3>
<p>See <a
href="https://github.com/donnemartin/system-design-primer#latency-numbers-every-programmer-should-know">Latency
numbers every programmer should know</a>.</p>
<h3 id="ongoing-7">Ongoing</h3>
<ul>
<li>Continue benchmarking and monitoring your system to address
bottlenecks as they come up</li>
<li>Scaling is an iterative process</li>
</ul>
<h1 id="object-oriented-design-hash-table">Object Oriented Design: Hash
Table</h1>
<div class="cell markdown">
<p>This notebook was prepared by <a
href="https://github.com/donnemartin">Donne Martin</a>. Source and
license info is on <a
href="https://github.com/donnemartin/system-design-primer">GitHub</a>.</p>
</div>
<section id="design-a-hash-map" class="cell markdown">
<h1>Design a hash map</h1>
</section>
<section id="constraints-and-assumptions-8" class="cell markdown">
<h2>Constraints and assumptions</h2>
<ul>
<li>For simplicity, are the keys integers only?
<ul>
<li>Yes</li>
</ul></li>
<li>For collision resolution, can we use chaining?
<ul>
<li>Yes</li>
</ul></li>
<li>Do we have to worry about load factors?
<ul>
<li>No</li>
</ul></li>
<li>Can we assume inputs are valid or do we have to validate them?
<ul>
<li>Assume they're valid</li>
</ul></li>
<li>Can we assume this fits memory?
<ul>
<li>Yes</li>
</ul></li>
</ul>
</section>
<section id="solution" class="cell markdown">
<h2>Solution</h2>
</section>
<div class="cell code" data-execution_count="1" data-collapsed="false">
<div class="sourceCode" id="cb62"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile hash_map.py</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Item(<span class="bu">object</span>):</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, key, value):</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.key <span class="op">=</span> key</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.value <span class="op">=</span> value</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HashTable(<span class="bu">object</span>):</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, size):</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.size <span class="op">=</span> size</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.table <span class="op">=</span> [[] <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>.size)]</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _hash_function(<span class="va">self</span>, key):</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> key <span class="op">%</span> <span class="va">self</span>.size</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="bu">set</span>(<span class="va">self</span>, key, value):</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>        hash_index <span class="op">=</span> <span class="va">self</span>._hash_function(key)</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> <span class="va">self</span>.table[hash_index]:</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> item.key <span class="op">==</span> key:</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>                item.value <span class="op">=</span> value</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.table[hash_index].append(Item(key, value))</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get(<span class="va">self</span>, key):</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>        hash_index <span class="op">=</span> <span class="va">self</span>._hash_function(key)</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> <span class="va">self</span>.table[hash_index]:</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> item.key <span class="op">==</span> key:</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> item.value</span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="st">&#39;Key not found&#39;</span>)</span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> remove(<span class="va">self</span>, key):</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>        hash_index <span class="op">=</span> <span class="va">self</span>._hash_function(key)</span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> index, item <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.table[hash_index]):</span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> item.key <span class="op">==</span> key:</span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>                <span class="kw">del</span> <span class="va">self</span>.table[hash_index][index]</span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span></span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">KeyError</span>(<span class="st">&#39;Key not found&#39;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Overwriting hash_map.py</code></pre>
</div>
</div>
<h1 id="object-oriented-design-lru-cache">Object Oriented Design: Lru
Cache</h1>
<div class="cell markdown">
<p>This notebook was prepared by <a
href="https://github.com/donnemartin">Donne Martin</a>. Source and
license info is on <a
href="https://github.com/donnemartin/system-design-primer">GitHub</a>.</p>
</div>
<section id="design-an-lru-cache" class="cell markdown">
<h1>Design an LRU cache</h1>
</section>
<section id="constraints-and-assumptions-9" class="cell markdown">
<h2>Constraints and assumptions</h2>
<ul>
<li>What are we caching?
<ul>
<li>We are caching the results of web queries</li>
</ul></li>
<li>Can we assume inputs are valid or do we have to validate them?
<ul>
<li>Assume they're valid</li>
</ul></li>
<li>Can we assume this fits memory?
<ul>
<li>Yes</li>
</ul></li>
</ul>
</section>
<section id="solution-1" class="cell markdown">
<h2>Solution</h2>
</section>
<div class="cell code" data-execution_count="1" data-collapsed="false">
<div class="sourceCode" id="cb64"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile lru_cache.py</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Node(<span class="bu">object</span>):</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, results):</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results <span class="op">=</span> results</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.prev <span class="op">=</span> <span class="va">None</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">next</span> <span class="op">=</span> <span class="va">None</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LinkedList(<span class="bu">object</span>):</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.head <span class="op">=</span> <span class="va">None</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.tail <span class="op">=</span> <span class="va">None</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> move_to_front(<span class="va">self</span>, node):  <span class="co"># ...</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> append_to_front(<span class="va">self</span>, node):  <span class="co"># ...</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> remove_from_tail(<span class="va">self</span>):  <span class="co"># ...</span></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Cache(<span class="bu">object</span>):</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, MAX_SIZE):</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.MAX_SIZE <span class="op">=</span> MAX_SIZE</span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.size <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lookup <span class="op">=</span> {}  <span class="co"># key: query, value: node</span></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linked_list <span class="op">=</span> LinkedList()</span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get(<span class="va">self</span>, query)</span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Get the stored query result from the cache.</span></span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a><span class="co">        Accessing a node updates its position to the front of the LRU list.</span></span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a>        node <span class="op">=</span> <span class="va">self</span>.lookup.get(query)</span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linked_list.move_to_front(node)</span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> node.results</span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="bu">set</span>(<span class="va">self</span>, results, query):</span>
<span id="cb64-41"><a href="#cb64-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Set the result for the given query key in the cache.</span></span>
<span id="cb64-42"><a href="#cb64-42" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb64-43"><a href="#cb64-43" aria-hidden="true" tabindex="-1"></a><span class="co">        When updating an entry, updates its position to the front of the LRU list.</span></span>
<span id="cb64-44"><a href="#cb64-44" aria-hidden="true" tabindex="-1"></a><span class="co">        If the entry is new and the cache is at capacity, removes the oldest entry</span></span>
<span id="cb64-45"><a href="#cb64-45" aria-hidden="true" tabindex="-1"></a><span class="co">        before the new entry is added.</span></span>
<span id="cb64-46"><a href="#cb64-46" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb64-47"><a href="#cb64-47" aria-hidden="true" tabindex="-1"></a>        node <span class="op">=</span> <span class="va">self</span>.lookup.get(query)</span>
<span id="cb64-48"><a href="#cb64-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> node <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb64-49"><a href="#cb64-49" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Key exists in cache, update the value</span></span>
<span id="cb64-50"><a href="#cb64-50" aria-hidden="true" tabindex="-1"></a>            node.results <span class="op">=</span> results</span>
<span id="cb64-51"><a href="#cb64-51" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.linked_list.move_to_front(node)</span>
<span id="cb64-52"><a href="#cb64-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb64-53"><a href="#cb64-53" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Key does not exist in cache</span></span>
<span id="cb64-54"><a href="#cb64-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.size <span class="op">==</span> <span class="va">self</span>.MAX_SIZE:</span>
<span id="cb64-55"><a href="#cb64-55" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Remove the oldest entry from the linked list and lookup</span></span>
<span id="cb64-56"><a href="#cb64-56" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.lookup.pop(<span class="va">self</span>.linked_list.tail.query, <span class="va">None</span>)</span>
<span id="cb64-57"><a href="#cb64-57" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.linked_list.remove_from_tail()</span>
<span id="cb64-58"><a href="#cb64-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb64-59"><a href="#cb64-59" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.size <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb64-60"><a href="#cb64-60" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add the new key and value</span></span>
<span id="cb64-61"><a href="#cb64-61" aria-hidden="true" tabindex="-1"></a>            new_node <span class="op">=</span> Node(results)</span>
<span id="cb64-62"><a href="#cb64-62" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.linked_list.append_to_front(new_node)</span>
<span id="cb64-63"><a href="#cb64-63" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.lookup[query] <span class="op">=</span> new_node</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Overwriting lru_cache.py</code></pre>
</div>
</div>
<h1 id="object-oriented-design-call-center">Object Oriented Design: Call
Center</h1>
<div class="cell markdown">
<p>This notebook was prepared by <a
href="https://github.com/donnemartin">Donne Martin</a>. Source and
license info is on <a
href="https://github.com/donnemartin/system-design-primer">GitHub</a>.</p>
</div>
<section id="design-a-call-center" class="cell markdown">
<h1>Design a call center</h1>
</section>
<section id="constraints-and-assumptions-10" class="cell markdown">
<h2>Constraints and assumptions</h2>
<ul>
<li>What levels of employees are in the call center?
<ul>
<li>Operator, supervisor, director</li>
</ul></li>
<li>Can we assume operators always get the initial calls?
<ul>
<li>Yes</li>
</ul></li>
<li>If there is no available operators or the operator can't handle the
call, does the call go to the supervisors?
<ul>
<li>Yes</li>
</ul></li>
<li>If there is no available supervisors or the supervisor can't handle
the call, does the call go to the directors?
<ul>
<li>Yes</li>
</ul></li>
<li>Can we assume the directors can handle all calls?
<ul>
<li>Yes</li>
</ul></li>
<li>What happens if nobody can answer the call?
<ul>
<li>It gets queued</li>
</ul></li>
<li>Do we need to handle 'VIP' calls where we put someone to the front
of the line?
<ul>
<li>No</li>
</ul></li>
<li>Can we assume inputs are valid or do we have to validate them?
<ul>
<li>Assume they're valid</li>
</ul></li>
</ul>
</section>
<section id="solution-2" class="cell markdown">
<h2>Solution</h2>
</section>
<div class="cell code" data-execution_count="1" data-collapsed="false">
<div class="sourceCode" id="cb66"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile call_center.py</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> abc <span class="im">import</span> ABCMeta, abstractmethod</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> deque</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> enum <span class="im">import</span> Enum</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Rank(Enum):</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    OPERATOR <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    SUPERVISOR <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    DIRECTOR <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Employee(metaclass<span class="op">=</span>ABCMeta):</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, employee_id, name, rank, call_center):</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.employee_id <span class="op">=</span> employee_id</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rank <span class="op">=</span> rank</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.call <span class="op">=</span> <span class="va">None</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.call_center <span class="op">=</span> call_center</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> take_call(<span class="va">self</span>, call):</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Assume the employee will always successfully take the call.&quot;&quot;&quot;</span></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.call <span class="op">=</span> call</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.call.employee <span class="op">=</span> <span class="va">self</span></span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.call.state <span class="op">=</span> CallState.IN_PROGRESS</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> complete_call(<span class="va">self</span>):</span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.call.state <span class="op">=</span> CallState.COMPLETE</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.call_center.notify_call_completed(<span class="va">self</span>.call)</span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">@abstractmethod</span></span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> escalate_call(<span class="va">self</span>):</span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _escalate_call(<span class="va">self</span>):</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.call.state <span class="op">=</span> CallState.READY</span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>        call <span class="op">=</span> <span class="va">self</span>.call</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.call <span class="op">=</span> <span class="va">None</span></span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.call_center.notify_call_escalated(call)</span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Operator(Employee):</span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, employee_id, name):</span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Operator, <span class="va">self</span>).<span class="fu">__init__</span>(employee_id, name, Rank.OPERATOR)</span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> escalate_call(<span class="va">self</span>):</span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.call.level <span class="op">=</span> Rank.SUPERVISOR</span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._escalate_call()</span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-53"><a href="#cb66-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-54"><a href="#cb66-54" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Supervisor(Employee):</span>
<span id="cb66-55"><a href="#cb66-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-56"><a href="#cb66-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, employee_id, name):</span>
<span id="cb66-57"><a href="#cb66-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Operator, <span class="va">self</span>).<span class="fu">__init__</span>(employee_id, name, Rank.SUPERVISOR)</span>
<span id="cb66-58"><a href="#cb66-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-59"><a href="#cb66-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> escalate_call(<span class="va">self</span>):</span>
<span id="cb66-60"><a href="#cb66-60" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.call.level <span class="op">=</span> Rank.DIRECTOR</span>
<span id="cb66-61"><a href="#cb66-61" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._escalate_call()</span>
<span id="cb66-62"><a href="#cb66-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-63"><a href="#cb66-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-64"><a href="#cb66-64" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Director(Employee):</span>
<span id="cb66-65"><a href="#cb66-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-66"><a href="#cb66-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, employee_id, name):</span>
<span id="cb66-67"><a href="#cb66-67" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Operator, <span class="va">self</span>).<span class="fu">__init__</span>(employee_id, name, Rank.DIRECTOR)</span>
<span id="cb66-68"><a href="#cb66-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-69"><a href="#cb66-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> escalate_call(<span class="va">self</span>):</span>
<span id="cb66-70"><a href="#cb66-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="va">NotImplemented</span>(<span class="st">&#39;Directors must be able to handle any call&#39;</span>)</span>
<span id="cb66-71"><a href="#cb66-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-72"><a href="#cb66-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-73"><a href="#cb66-73" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CallState(Enum):</span>
<span id="cb66-74"><a href="#cb66-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-75"><a href="#cb66-75" aria-hidden="true" tabindex="-1"></a>    READY <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb66-76"><a href="#cb66-76" aria-hidden="true" tabindex="-1"></a>    IN_PROGRESS <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb66-77"><a href="#cb66-77" aria-hidden="true" tabindex="-1"></a>    COMPLETE <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb66-78"><a href="#cb66-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-79"><a href="#cb66-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-80"><a href="#cb66-80" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Call(<span class="bu">object</span>):</span>
<span id="cb66-81"><a href="#cb66-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-82"><a href="#cb66-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, rank):</span>
<span id="cb66-83"><a href="#cb66-83" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.state <span class="op">=</span> CallState.READY</span>
<span id="cb66-84"><a href="#cb66-84" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rank <span class="op">=</span> rank</span>
<span id="cb66-85"><a href="#cb66-85" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.employee <span class="op">=</span> <span class="va">None</span></span>
<span id="cb66-86"><a href="#cb66-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-87"><a href="#cb66-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-88"><a href="#cb66-88" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CallCenter(<span class="bu">object</span>):</span>
<span id="cb66-89"><a href="#cb66-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-90"><a href="#cb66-90" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, operators, supervisors, directors):</span>
<span id="cb66-91"><a href="#cb66-91" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.operators <span class="op">=</span> operators</span>
<span id="cb66-92"><a href="#cb66-92" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.supervisors <span class="op">=</span> supervisors</span>
<span id="cb66-93"><a href="#cb66-93" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.directors <span class="op">=</span> directors</span>
<span id="cb66-94"><a href="#cb66-94" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.queued_calls <span class="op">=</span> deque()</span>
<span id="cb66-95"><a href="#cb66-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-96"><a href="#cb66-96" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dispatch_call(<span class="va">self</span>, call):</span>
<span id="cb66-97"><a href="#cb66-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> call.rank <span class="kw">not</span> <span class="kw">in</span> (Rank.OPERATOR, Rank.SUPERVISOR, Rank.DIRECTOR):</span>
<span id="cb66-98"><a href="#cb66-98" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&#39;Invalid call rank: </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(call.rank))</span>
<span id="cb66-99"><a href="#cb66-99" aria-hidden="true" tabindex="-1"></a>        employee <span class="op">=</span> <span class="va">None</span></span>
<span id="cb66-100"><a href="#cb66-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> call.rank <span class="op">==</span> Rank.OPERATOR:</span>
<span id="cb66-101"><a href="#cb66-101" aria-hidden="true" tabindex="-1"></a>            employee <span class="op">=</span> <span class="va">self</span>._dispatch_call(call, <span class="va">self</span>.operators)</span>
<span id="cb66-102"><a href="#cb66-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> call.rank <span class="op">==</span> Rank.SUPERVISOR <span class="kw">or</span> employee <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb66-103"><a href="#cb66-103" aria-hidden="true" tabindex="-1"></a>            employee <span class="op">=</span> <span class="va">self</span>._dispatch_call(call, <span class="va">self</span>.supervisors)</span>
<span id="cb66-104"><a href="#cb66-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> call.rank <span class="op">==</span> Rank.DIRECTOR <span class="kw">or</span> employee <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb66-105"><a href="#cb66-105" aria-hidden="true" tabindex="-1"></a>            employee <span class="op">=</span> <span class="va">self</span>._dispatch_call(call, <span class="va">self</span>.directors)</span>
<span id="cb66-106"><a href="#cb66-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> employee <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb66-107"><a href="#cb66-107" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.queued_calls.append(call)</span>
<span id="cb66-108"><a href="#cb66-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-109"><a href="#cb66-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _dispatch_call(<span class="va">self</span>, call, employees):</span>
<span id="cb66-110"><a href="#cb66-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> employee <span class="kw">in</span> employees:</span>
<span id="cb66-111"><a href="#cb66-111" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> employee.call <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb66-112"><a href="#cb66-112" aria-hidden="true" tabindex="-1"></a>                employee.take_call(call)</span>
<span id="cb66-113"><a href="#cb66-113" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> employee</span>
<span id="cb66-114"><a href="#cb66-114" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb66-115"><a href="#cb66-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-116"><a href="#cb66-116" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> notify_call_escalated(<span class="va">self</span>, call):  <span class="co"># ...</span></span>
<span id="cb66-117"><a href="#cb66-117" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> notify_call_completed(<span class="va">self</span>, call):  <span class="co"># ...</span></span>
<span id="cb66-118"><a href="#cb66-118" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dispatch_queued_call_to_newly_freed_employee(<span class="va">self</span>, call, employee):  <span class="co"># ...</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>Overwriting call_center.py</code></pre>
</div>
</div>
<h1 id="object-oriented-design-deck-of-cards">Object Oriented Design:
Deck Of Cards</h1>
<div class="cell markdown">
<p>This notebook was prepared by <a
href="https://github.com/donnemartin">Donne Martin</a>. Source and
license info is on <a
href="https://github.com/donnemartin/system-design-primer">GitHub</a>.</p>
</div>
<section id="design-a-deck-of-cards" class="cell markdown">
<h1>Design a deck of cards</h1>
</section>
<section id="constraints-and-assumptions-11" class="cell markdown">
<h2>Constraints and assumptions</h2>
<ul>
<li>Is this a generic deck of cards for games like poker and black jack?
<ul>
<li>Yes, design a generic deck then extend it to black jack</li>
</ul></li>
<li>Can we assume the deck has 52 cards (2-10, Jack, Queen, King, Ace)
and 4 suits?
<ul>
<li>Yes</li>
</ul></li>
<li>Can we assume inputs are valid or do we have to validate them?
<ul>
<li>Assume they're valid</li>
</ul></li>
</ul>
</section>
<section id="solution-3" class="cell markdown">
<h2>Solution</h2>
</section>
<div class="cell code" data-execution_count="1" data-collapsed="false">
<div class="sourceCode" id="cb68"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile deck_of_cards.py</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> abc <span class="im">import</span> ABCMeta, abstractmethod</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> enum <span class="im">import</span> Enum</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Suit(Enum):</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    HEART <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    DIAMOND <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    CLUBS <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    SPADE <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Card(metaclass<span class="op">=</span>ABCMeta):</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, value, suit):</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.value <span class="op">=</span> value</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.suit <span class="op">=</span> suit</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.is_available <span class="op">=</span> <span class="va">True</span></span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-22"><a href="#cb68-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb68-23"><a href="#cb68-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">@abstractmethod</span></span>
<span id="cb68-24"><a href="#cb68-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> value(<span class="va">self</span>):</span>
<span id="cb68-25"><a href="#cb68-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb68-26"><a href="#cb68-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-27"><a href="#cb68-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">@value.setter</span></span>
<span id="cb68-28"><a href="#cb68-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">@abstractmethod</span></span>
<span id="cb68-29"><a href="#cb68-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> value(<span class="va">self</span>, other):</span>
<span id="cb68-30"><a href="#cb68-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb68-31"><a href="#cb68-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-32"><a href="#cb68-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-33"><a href="#cb68-33" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BlackJackCard(Card):</span>
<span id="cb68-34"><a href="#cb68-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-35"><a href="#cb68-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, value, suit):</span>
<span id="cb68-36"><a href="#cb68-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(BlackJackCard, <span class="va">self</span>).<span class="fu">__init__</span>(value, suit)</span>
<span id="cb68-37"><a href="#cb68-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-38"><a href="#cb68-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_ace(<span class="va">self</span>):</span>
<span id="cb68-39"><a href="#cb68-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._value <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb68-40"><a href="#cb68-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-41"><a href="#cb68-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_face_card(<span class="va">self</span>):</span>
<span id="cb68-42"><a href="#cb68-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Jack = 11, Queen = 12, King = 13&quot;&quot;&quot;</span></span>
<span id="cb68-43"><a href="#cb68-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">10</span> <span class="op">&lt;</span> <span class="va">self</span>._value <span class="op">&lt;=</span> <span class="dv">13</span></span>
<span id="cb68-44"><a href="#cb68-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-45"><a href="#cb68-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb68-46"><a href="#cb68-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> value(<span class="va">self</span>):</span>
<span id="cb68-47"><a href="#cb68-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.is_ace() <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb68-48"><a href="#cb68-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb68-49"><a href="#cb68-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.is_face_card():</span>
<span id="cb68-50"><a href="#cb68-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">10</span></span>
<span id="cb68-51"><a href="#cb68-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb68-52"><a href="#cb68-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._value</span>
<span id="cb68-53"><a href="#cb68-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-54"><a href="#cb68-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">@value.setter</span></span>
<span id="cb68-55"><a href="#cb68-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> value(<span class="va">self</span>, new_value):</span>
<span id="cb68-56"><a href="#cb68-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="dv">1</span> <span class="op">&lt;=</span> new_value <span class="op">&lt;=</span> <span class="dv">13</span>:</span>
<span id="cb68-57"><a href="#cb68-57" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._value <span class="op">=</span> new_value</span>
<span id="cb68-58"><a href="#cb68-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb68-59"><a href="#cb68-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&#39;Invalid card value: </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(new_value))</span>
<span id="cb68-60"><a href="#cb68-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-61"><a href="#cb68-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-62"><a href="#cb68-62" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Hand(<span class="bu">object</span>):</span>
<span id="cb68-63"><a href="#cb68-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-64"><a href="#cb68-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, cards):</span>
<span id="cb68-65"><a href="#cb68-65" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cards <span class="op">=</span> cards</span>
<span id="cb68-66"><a href="#cb68-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-67"><a href="#cb68-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_card(<span class="va">self</span>, card):</span>
<span id="cb68-68"><a href="#cb68-68" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cards.append(card)</span>
<span id="cb68-69"><a href="#cb68-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-70"><a href="#cb68-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> score(<span class="va">self</span>):</span>
<span id="cb68-71"><a href="#cb68-71" aria-hidden="true" tabindex="-1"></a>        total_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb68-72"><a href="#cb68-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> card <span class="kw">in</span> <span class="va">self</span>.cards:</span>
<span id="cb68-73"><a href="#cb68-73" aria-hidden="true" tabindex="-1"></a>            total_value <span class="op">+=</span> card.value</span>
<span id="cb68-74"><a href="#cb68-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> total_value</span>
<span id="cb68-75"><a href="#cb68-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-76"><a href="#cb68-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-77"><a href="#cb68-77" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BlackJackHand(Hand):</span>
<span id="cb68-78"><a href="#cb68-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-79"><a href="#cb68-79" aria-hidden="true" tabindex="-1"></a>    BLACKJACK <span class="op">=</span> <span class="dv">21</span></span>
<span id="cb68-80"><a href="#cb68-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-81"><a href="#cb68-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, cards):</span>
<span id="cb68-82"><a href="#cb68-82" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(BlackJackHand, <span class="va">self</span>).<span class="fu">__init__</span>(cards)</span>
<span id="cb68-83"><a href="#cb68-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-84"><a href="#cb68-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> score(<span class="va">self</span>):</span>
<span id="cb68-85"><a href="#cb68-85" aria-hidden="true" tabindex="-1"></a>        min_over <span class="op">=</span> sys.MAXSIZE</span>
<span id="cb68-86"><a href="#cb68-86" aria-hidden="true" tabindex="-1"></a>        max_under <span class="op">=</span> <span class="op">-</span>sys.MAXSIZE</span>
<span id="cb68-87"><a href="#cb68-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> score <span class="kw">in</span> <span class="va">self</span>.possible_scores():</span>
<span id="cb68-88"><a href="#cb68-88" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.BLACKJACK <span class="op">&lt;</span> score <span class="op">&lt;</span> min_over:</span>
<span id="cb68-89"><a href="#cb68-89" aria-hidden="true" tabindex="-1"></a>                min_over <span class="op">=</span> score</span>
<span id="cb68-90"><a href="#cb68-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> max_under <span class="op">&lt;</span> score <span class="op">&lt;=</span> <span class="va">self</span>.BLACKJACK:</span>
<span id="cb68-91"><a href="#cb68-91" aria-hidden="true" tabindex="-1"></a>                max_under <span class="op">=</span> score</span>
<span id="cb68-92"><a href="#cb68-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> max_under <span class="cf">if</span> max_under <span class="op">!=</span> <span class="op">-</span>sys.MAXSIZE <span class="cf">else</span> min_over</span>
<span id="cb68-93"><a href="#cb68-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-94"><a href="#cb68-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> possible_scores(<span class="va">self</span>):</span>
<span id="cb68-95"><a href="#cb68-95" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Return a list of possible scores, taking Aces into account.&quot;&quot;&quot;</span></span>
<span id="cb68-96"><a href="#cb68-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ...</span></span>
<span id="cb68-97"><a href="#cb68-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-98"><a href="#cb68-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-99"><a href="#cb68-99" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Deck(<span class="bu">object</span>):</span>
<span id="cb68-100"><a href="#cb68-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-101"><a href="#cb68-101" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, cards):</span>
<span id="cb68-102"><a href="#cb68-102" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.cards <span class="op">=</span> cards</span>
<span id="cb68-103"><a href="#cb68-103" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.deal_index <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb68-104"><a href="#cb68-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-105"><a href="#cb68-105" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> remaining_cards(<span class="va">self</span>):</span>
<span id="cb68-106"><a href="#cb68-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.cards) <span class="op">-</span> deal_index</span>
<span id="cb68-107"><a href="#cb68-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-108"><a href="#cb68-108" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> deal_card():</span>
<span id="cb68-109"><a href="#cb68-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb68-110"><a href="#cb68-110" aria-hidden="true" tabindex="-1"></a>            card <span class="op">=</span> <span class="va">self</span>.cards[<span class="va">self</span>.deal_index]</span>
<span id="cb68-111"><a href="#cb68-111" aria-hidden="true" tabindex="-1"></a>            card.is_available <span class="op">=</span> <span class="va">False</span></span>
<span id="cb68-112"><a href="#cb68-112" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.deal_index <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb68-113"><a href="#cb68-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">IndexError</span>:</span>
<span id="cb68-114"><a href="#cb68-114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb68-115"><a href="#cb68-115" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> card</span>
<span id="cb68-116"><a href="#cb68-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-117"><a href="#cb68-117" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> shuffle(<span class="va">self</span>):  <span class="co"># ...</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>Overwriting deck_of_cards.py</code></pre>
</div>
</div>
<h1 id="object-oriented-design-parking-lot">Object Oriented Design:
Parking Lot</h1>
<div class="cell markdown">
<p>This notebook was prepared by <a
href="https://github.com/donnemartin">Donne Martin</a>. Source and
license info is on <a
href="https://github.com/donnemartin/system-design-primer">GitHub</a>.</p>
</div>
<section id="design-a-parking-lot" class="cell markdown">
<h1>Design a parking lot</h1>
</section>
<section id="constraints-and-assumptions-12" class="cell markdown">
<h2>Constraints and assumptions</h2>
<ul>
<li>What types of vehicles should we support?
<ul>
<li>Motorcycle, Car, Bus</li>
</ul></li>
<li>Does each vehicle type take up a different amount of parking spots?
<ul>
<li>Yes</li>
<li>Motorcycle spot -&gt; Motorcycle</li>
<li>Compact spot -&gt; Motorcycle, Car</li>
<li>Large spot -&gt; Motorcycle, Car</li>
<li>Bus can park if we have 5 consecutive "large" spots</li>
</ul></li>
<li>Does the parking lot have multiple levels?
<ul>
<li>Yes</li>
</ul></li>
</ul>
</section>
<section id="solution-4" class="cell markdown">
<h2>Solution</h2>
</section>
<div class="cell code" data-execution_count="1" data-collapsed="false">
<div class="sourceCode" id="cb70"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile parking_lot.py</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> abc <span class="im">import</span> ABCMeta, abstractmethod</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> VehicleSize(Enum):</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    MOTORCYCLE <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    COMPACT <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    LARGE <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Vehicle(metaclass<span class="op">=</span>ABCMeta):</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, vehicle_size, license_plate, spot_size):</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vehicle_size <span class="op">=</span> vehicle_size</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.license_plate <span class="op">=</span> license_plate</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.spot_size <span class="op">=</span> spot_size</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.spots_taken <span class="op">=</span> []</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> clear_spots(<span class="va">self</span>):</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> spot <span class="kw">in</span> <span class="va">self</span>.spots_taken:</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>            spot.remove_vehicle(<span class="va">self</span>)</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.spots_taken <span class="op">=</span> []</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> take_spot(<span class="va">self</span>, spot):</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.spots_taken.append(spot)</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">@abstractmethod</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> can_fit_in_spot(<span class="va">self</span>, spot):</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Motorcycle(Vehicle):</span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, license_plate):</span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Motorcycle, <span class="va">self</span>).<span class="fu">__init__</span>(VehicleSize.MOTORCYCLE, license_plate, spot_size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> can_fit_in_spot(<span class="va">self</span>, spot):</span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Car(Vehicle):</span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, license_plate):</span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Car, <span class="va">self</span>).<span class="fu">__init__</span>(VehicleSize.COMPACT, license_plate, spot_size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> can_fit_in_spot(<span class="va">self</span>, spot):</span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span> <span class="cf">if</span> (spot.size <span class="op">==</span> LARGE <span class="kw">or</span> spot.size <span class="op">==</span> COMPACT) <span class="cf">else</span> <span class="va">False</span></span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Bus(Vehicle):</span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, license_plate):</span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Bus, <span class="va">self</span>).<span class="fu">__init__</span>(VehicleSize.LARGE, license_plate, spot_size<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> can_fit_in_spot(<span class="va">self</span>, spot):</span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span> <span class="cf">if</span> spot.size <span class="op">==</span> LARGE <span class="cf">else</span> <span class="va">False</span></span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ParkingLot(<span class="bu">object</span>):</span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_levels):</span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_levels <span class="op">=</span> num_levels</span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.levels <span class="op">=</span> []</span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> park_vehicle(<span class="va">self</span>, vehicle):</span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> level <span class="kw">in</span> levels:</span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> level.park_vehicle(vehicle):</span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb70-70"><a href="#cb70-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb70-71"><a href="#cb70-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-72"><a href="#cb70-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-73"><a href="#cb70-73" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Level(<span class="bu">object</span>):</span>
<span id="cb70-74"><a href="#cb70-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-75"><a href="#cb70-75" aria-hidden="true" tabindex="-1"></a>    SPOTS_PER_ROW <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb70-76"><a href="#cb70-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-77"><a href="#cb70-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, floor, total_spots):</span>
<span id="cb70-78"><a href="#cb70-78" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.floor <span class="op">=</span> floor</span>
<span id="cb70-79"><a href="#cb70-79" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_spots <span class="op">=</span> total_spots</span>
<span id="cb70-80"><a href="#cb70-80" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.available_spots <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb70-81"><a href="#cb70-81" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parking_spots <span class="op">=</span> []</span>
<span id="cb70-82"><a href="#cb70-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-83"><a href="#cb70-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> spot_freed(<span class="va">self</span>):</span>
<span id="cb70-84"><a href="#cb70-84" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.available_spots <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb70-85"><a href="#cb70-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-86"><a href="#cb70-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> park_vehicle(<span class="va">self</span>, vehicle):</span>
<span id="cb70-87"><a href="#cb70-87" aria-hidden="true" tabindex="-1"></a>        spot <span class="op">=</span> <span class="va">self</span>._find_available_spot(vehicle)</span>
<span id="cb70-88"><a href="#cb70-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> spot <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb70-89"><a href="#cb70-89" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb70-90"><a href="#cb70-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb70-91"><a href="#cb70-91" aria-hidden="true" tabindex="-1"></a>            spot.park_vehicle(vehicle)</span>
<span id="cb70-92"><a href="#cb70-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> spot</span>
<span id="cb70-93"><a href="#cb70-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-94"><a href="#cb70-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _find_available_spot(<span class="va">self</span>, vehicle):</span>
<span id="cb70-95"><a href="#cb70-95" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Find an available spot where vehicle can fit, or return None&quot;&quot;&quot;</span></span>
<span id="cb70-96"><a href="#cb70-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ...</span></span>
<span id="cb70-97"><a href="#cb70-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-98"><a href="#cb70-98" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _park_starting_at_spot(<span class="va">self</span>, spot, vehicle):</span>
<span id="cb70-99"><a href="#cb70-99" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Occupy starting at spot.spot_number to vehicle.spot_size.&quot;&quot;&quot;</span></span>
<span id="cb70-100"><a href="#cb70-100" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ...</span></span>
<span id="cb70-101"><a href="#cb70-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-102"><a href="#cb70-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-103"><a href="#cb70-103" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ParkingSpot(<span class="bu">object</span>):</span>
<span id="cb70-104"><a href="#cb70-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-105"><a href="#cb70-105" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, level, row, spot_number, spot_size, vehicle_size):</span>
<span id="cb70-106"><a href="#cb70-106" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.level <span class="op">=</span> level</span>
<span id="cb70-107"><a href="#cb70-107" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.row <span class="op">=</span> row</span>
<span id="cb70-108"><a href="#cb70-108" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.spot_number <span class="op">=</span> spot_number</span>
<span id="cb70-109"><a href="#cb70-109" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.spot_size <span class="op">=</span> spot_size</span>
<span id="cb70-110"><a href="#cb70-110" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vehicle_size <span class="op">=</span> vehicle_size</span>
<span id="cb70-111"><a href="#cb70-111" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.vehicle <span class="op">=</span> <span class="va">None</span></span>
<span id="cb70-112"><a href="#cb70-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-113"><a href="#cb70-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_available(<span class="va">self</span>):</span>
<span id="cb70-114"><a href="#cb70-114" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span> <span class="cf">if</span> <span class="va">self</span>.vehicle <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> <span class="va">False</span></span>
<span id="cb70-115"><a href="#cb70-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-116"><a href="#cb70-116" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> can_fit_vehicle(<span class="va">self</span>, vehicle):</span>
<span id="cb70-117"><a href="#cb70-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.vehicle <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb70-118"><a href="#cb70-118" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb70-119"><a href="#cb70-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> vehicle.can_fit_in_spot(<span class="va">self</span>)</span>
<span id="cb70-120"><a href="#cb70-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-121"><a href="#cb70-121" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> park_vehicle(<span class="va">self</span>, vehicle):  <span class="co"># ...</span></span>
<span id="cb70-122"><a href="#cb70-122" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> remove_vehicle(<span class="va">self</span>):  <span class="co"># ...</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>Overwriting parking_lot.py</code></pre>
</div>
</div>
<h1 id="object-oriented-design-online-chat">Object Oriented Design:
Online Chat</h1>
<div class="cell markdown">
<p>This notebook was prepared by <a
href="https://github.com/donnemartin">Donne Martin</a>. Source and
license info is on <a
href="https://github.com/donnemartin/system-design-primer">GitHub</a>.</p>
</div>
<section id="design-an-online-chat" class="cell markdown">
<h1>Design an online chat</h1>
</section>
<section id="constraints-and-assumptions-13" class="cell markdown">
<h2>Constraints and assumptions</h2>
<ul>
<li>Assume we'll focus on the following workflows:
<ul>
<li>Text conversations only</li>
<li>Users
<ul>
<li>Add a user</li>
<li>Remove a user</li>
<li>Update a user</li>
<li>Add to a user's friends list
<ul>
<li>Add friend request
<ul>
<li>Approve friend request</li>
<li>Reject friend request</li>
</ul></li>
</ul></li>
<li>Remove from a user's friends list</li>
</ul></li>
<li>Create a group chat
<ul>
<li>Invite friends to a group chat</li>
<li>Post a message to a group chat</li>
</ul></li>
<li>Private 1-1 chat
<ul>
<li>Invite a friend to a private chat</li>
<li>Post a meesage to a private chat</li>
</ul></li>
</ul></li>
<li>No need to worry about scaling initially</li>
</ul>
</section>
<section id="solution-5" class="cell markdown">
<h2>Solution</h2>
</section>
<div class="cell code" data-execution_count="1" data-collapsed="false">
<div class="sourceCode" id="cb72"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>writefile online_chat.py</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> abc <span class="im">import</span> ABCMeta</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UserService(<span class="bu">object</span>):</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.users_by_id <span class="op">=</span> {}  <span class="co"># key: user id, value: User</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_user(<span class="va">self</span>, user_id, name, pass_hash):  <span class="co"># ...</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> remove_user(<span class="va">self</span>, user_id):  <span class="co"># ...</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_friend_request(<span class="va">self</span>, from_user_id, to_user_id):  <span class="co"># ...</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> approve_friend_request(<span class="va">self</span>, from_user_id, to_user_id):  <span class="co"># ...</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reject_friend_request(<span class="va">self</span>, from_user_id, to_user_id):  <span class="co"># ...</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> User(<span class="bu">object</span>):</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, user_id, name, pass_hash):</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.user_id <span class="op">=</span> user_id</span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pass_hash <span class="op">=</span> pass_hash</span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.friends_by_id <span class="op">=</span> {}  <span class="co"># key: friend id, value: User</span></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.friend_ids_to_private_chats <span class="op">=</span> {}  <span class="co"># key: friend id, value: private chats</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.group_chats_by_id <span class="op">=</span> {}  <span class="co"># key: chat id, value: GroupChat</span></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.received_friend_requests_by_friend_id <span class="op">=</span> {}  <span class="co"># key: friend id, value: AddRequest</span></span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sent_friend_requests_by_friend_id <span class="op">=</span> {}  <span class="co"># key: friend id, value: AddRequest</span></span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> message_user(<span class="va">self</span>, friend_id, message):  <span class="co"># ...</span></span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> message_group(<span class="va">self</span>, group_id, message):  <span class="co"># ...</span></span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> send_friend_request(<span class="va">self</span>, friend_id):  <span class="co"># ...</span></span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> receive_friend_request(<span class="va">self</span>, friend_id):  <span class="co"># ...</span></span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> approve_friend_request(<span class="va">self</span>, friend_id):  <span class="co"># ...</span></span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reject_friend_request(<span class="va">self</span>, friend_id):  <span class="co"># ...</span></span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Chat(metaclass<span class="op">=</span>ABCMeta):</span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, chat_id):</span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.chat_id <span class="op">=</span> chat_id</span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.users <span class="op">=</span> []</span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.messages <span class="op">=</span> []</span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PrivateChat(Chat):</span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, first_user, second_user):</span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(PrivateChat, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb72-49"><a href="#cb72-49" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.users.append(first_user)</span>
<span id="cb72-50"><a href="#cb72-50" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.users.append(second_user)</span>
<span id="cb72-51"><a href="#cb72-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-52"><a href="#cb72-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-53"><a href="#cb72-53" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GroupChat(Chat):</span>
<span id="cb72-54"><a href="#cb72-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-55"><a href="#cb72-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_user(<span class="va">self</span>, user):  <span class="co"># ...</span></span>
<span id="cb72-56"><a href="#cb72-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> remove_user(<span class="va">self</span>, user):  <span class="co"># ... </span></span>
<span id="cb72-57"><a href="#cb72-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-58"><a href="#cb72-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-59"><a href="#cb72-59" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Message(<span class="bu">object</span>):</span>
<span id="cb72-60"><a href="#cb72-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-61"><a href="#cb72-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, message_id, message, timestamp):</span>
<span id="cb72-62"><a href="#cb72-62" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.message_id <span class="op">=</span> message_id</span>
<span id="cb72-63"><a href="#cb72-63" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.message <span class="op">=</span> message</span>
<span id="cb72-64"><a href="#cb72-64" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.timestamp <span class="op">=</span> timestamp</span>
<span id="cb72-65"><a href="#cb72-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-66"><a href="#cb72-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-67"><a href="#cb72-67" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AddRequest(<span class="bu">object</span>):</span>
<span id="cb72-68"><a href="#cb72-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-69"><a href="#cb72-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, from_user_id, to_user_id, request_status, timestamp):</span>
<span id="cb72-70"><a href="#cb72-70" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.from_user_id <span class="op">=</span> from_user_id</span>
<span id="cb72-71"><a href="#cb72-71" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.to_user_id <span class="op">=</span> to_user_id</span>
<span id="cb72-72"><a href="#cb72-72" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.request_status <span class="op">=</span> request_status</span>
<span id="cb72-73"><a href="#cb72-73" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.timestamp <span class="op">=</span> timestamp</span>
<span id="cb72-74"><a href="#cb72-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-75"><a href="#cb72-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-76"><a href="#cb72-76" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RequestStatus(Enum):</span>
<span id="cb72-77"><a href="#cb72-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-78"><a href="#cb72-78" aria-hidden="true" tabindex="-1"></a>    UNREAD <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb72-79"><a href="#cb72-79" aria-hidden="true" tabindex="-1"></a>    READ <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb72-80"><a href="#cb72-80" aria-hidden="true" tabindex="-1"></a>    ACCEPTED <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb72-81"><a href="#cb72-81" aria-hidden="true" tabindex="-1"></a>    REJECTED <span class="op">=</span> <span class="dv">3</span></span></code></pre></div>
<div class="output stream stdout">
<pre><code>Overwriting online_chat.py</code></pre>
</div>
</div>
</body>
</html>
